<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RentalShield - Submit Claim</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
        }

        .header p {
            color: #666;
            margin: 0;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .nav-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .claim-form {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        select.form-control {
            cursor: pointer;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .selection-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .selection-item:hover {
            border-color: #667eea;
            background: #f0f8ff;
        }

        .selection-item.selected {
            border-color: #28a745;
            background: #e8f5e8;
        }

        .vehicle-card {
            text-align: center;
        }

        .vehicle-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .vehicle-details {
            color: #666;
            font-size: 0.9rem;
        }

        .inspection-card {
            text-align: center;
        }

        .inspection-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .inspection-date {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .damage-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .damage-yes {
            background: #fff3cd;
            color: #856404;
        }

        .damage-no {
            background: #d1edff;
            color: #0c5460;
        }

        .submit-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .claim-summary {
            background: #e3f2fd;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .summary-item:last-child {
            margin-bottom: 0;
            padding-top: 0.5rem;
            border-top: 1px solid #ccc;
            font-weight: 600;
        }

        .step-indicator {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-bottom: 1rem;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .nav-buttons {
                flex-direction: column;
            }

            .selection-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üõ°Ô∏è Submit Insurance Claim</h1>
            <p>Select your vehicle and inspection, then file your claim</p>
        </div>

        <!-- Navigation -->
        <div class="nav-buttons">
            <a href="/reports.html" class="nav-btn">‚Üê Back to Reports</a>
            <a href="/dashboard.html" class="nav-btn">Dashboard</a>
        </div>

        <!-- Claim Form -->
        <div class="claim-form">
            <div id="loading" class="loading">
                Loading your vehicles and inspections...
            </div>

            <div id="error-container"></div>

            <form id="claim-form" style="display: none;">
                <!-- Step 1: Select Vehicle -->
                <div class="form-section" id="vehicle-section">
                    <div class="step-indicator">Step 1 of 3</div>
                    <h3>üöó Select Vehicle</h3>
                    <div id="vehicles-list" class="selection-grid">
                        <!-- Vehicles will be loaded here -->
                    </div>
                </div>

                <!-- Step 2: Select Inspection -->
                <div class="form-section" id="inspection-section" style="display: none;">
                    <div class="step-indicator">Step 2 of 3</div>
                    <h3>üìã Select Inspection Report</h3>
                    <div id="inspections-list" class="selection-grid">
                        <!-- Inspections will be loaded here -->
                    </div>
                </div>

                <!-- Step 3: Claim Details -->
                <div class="form-section" id="details-section" style="display: none;">
                    <div class="step-indicator">Step 3 of 3</div>
                    <h3>üìù Claim Details</h3>
                    
                    <div class="form-group">
                        <label for="claim-type">Claim Type</label>
                        <select id="claim-type" class="form-control" required>
                            <option value="">Select claim type</option>
                            <option value="damage">Vehicle Damage</option>
                            <option value="theft">Theft/Vandalism</option>
                            <option value="accident">Accident</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="damage-location">Damage Location</label>
                        <select id="damage-location" class="form-control" required>
                            <option value="">Select damaged area</option>
                            <option value="front_bumper">Front Bumper</option>
                            <option value="rear_bumper">Rear Bumper</option>
                            <option value="driver_side_front_fender">Driver Side Front Fender</option>
                            <option value="passenger_side_front_fender">Passenger Side Front Fender</option>
                            <option value="driver_side_rear_fender">Driver Side Rear Fender</option>
                            <option value="passenger_side_rear_fender">Passenger Side Rear Fender</option>
                            <option value="driver_side_doors">Driver Side Doors</option>
                            <option value="passenger_side_doors">Passenger Side Doors</option>
                            <option value="driver_side_front_wheel">Driver Side Front Wheel</option>
                            <option value="driver_side_rear_wheel">Driver Side Rear Wheel</option>
                            <option value="passenger_side_front_wheel">Passenger Side Front Wheel</option>
                            <option value="passenger_side_rear_wheel">Passenger Side Rear Wheel</option>
                            <option value="front_windshield">Front Windshield</option>
                            <option value="interior_dashboard">Interior Dashboard</option>
                            <option value="interior_front_seats">Interior Front Seats</option>
                            <option value="interior_rear_seats">Interior Rear Seats</option>
                            <option value="trunk_cargo_area">Trunk/Cargo Area</option>
                            <option value="multiple_areas">Multiple Areas</option>
                            <option value="other_location">Other Location</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="description">Description of Incident</label>
                        <textarea 
                            id="description" 
                            class="form-control" 
                            placeholder="Describe what happened, when it occurred, and any relevant details..."
                            required
                        ></textarea>
                    </div>

                    <!-- Review -->
                    <h3>üëÄ Review Your Claim</h3>
                    <div id="claim-summary" class="claim-summary">
                        Complete all steps to see summary
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submit-btn" class="submit-btn" disabled>
                        Submit Claim
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://aganyvysumqdfqajwgim.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnYW55dnlzdW1xZGZxYWp3Z2ltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4MTI0MzIsImV4cCI6MjA2NjM4ODQzMn0.0wULj5KIICC1eBDs3DuyqgHrmIwI8CQHYTIjy4g3swM';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let selectedVehicle = null;
        let selectedReport = null;
        let userReports = [];
        let userVehicles = [];

        // Initialize page
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = '/auth.html';
                return;
            }

            currentUser = session.user;
            await loadUserData();
        }

        // Load user's reports and extract vehicle data
        async function loadUserData() {
            try {
                const { data: reports, error } = await supabase
                    .from('reports')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                userReports = reports;
                
                // Extract unique vehicles from reports
                const vehicleMap = new Map();
                reports.forEach(report => {
                    if (report.vehicle_id) {
                        let vehicleInfo = {
                            vehicle_id: report.vehicle_id,
                            license_plate: 'Unknown',
                            make: 'Unknown',
                            model: 'Unknown',
                            year: 'Unknown',
                            color: 'Unknown'
                        };

                        // Try to parse vehicle_info if it exists
                        if (report.vehicle_info) {
                            try {
                                const parsed = typeof report.vehicle_info === 'string' ? 
                                    JSON.parse(report.vehicle_info) : report.vehicle_info;
                                vehicleInfo = { ...vehicleInfo, ...parsed };
                            } catch (e) {
                                console.log('Could not parse vehicle_info for report:', report.id);
                            }
                        }

                        vehicleMap.set(report.vehicle_id, vehicleInfo);
                    }
                });

                userVehicles = Array.from(vehicleMap.values());
                
                if (userVehicles.length === 0) {
                    showError('No vehicles found. Please complete an inspection first.');
                    return;
                }

                displayVehicles();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('claim-form').style.display = 'block';

            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Unable to load your data. Please try again.');
            }
        }

        // Display vehicles for selection
        function displayVehicles() {
            const vehiclesContainer = document.getElementById('vehicles-list');
            
            vehiclesContainer.innerHTML = userVehicles.map(vehicle => `
                <div class="selection-item vehicle-card" onclick="selectVehicle('${vehicle.vehicle_id}')">
                    <div class="vehicle-title">${vehicle.make} ${vehicle.model}</div>
                    <div class="vehicle-details">
                        ${vehicle.year} ‚Ä¢ ${vehicle.color}<br>
                        License: ${vehicle.license_plate}
                    </div>
                </div>
            `).join('');
        }

        // Select a vehicle
        function selectVehicle(vehicleId) {
            // Remove previous selection
            document.querySelectorAll('.vehicle-card').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selection to clicked item
            event.target.closest('.vehicle-card').classList.add('selected');

            selectedVehicle = userVehicles.find(v => v.vehicle_id === vehicleId);
            
            // Load inspections for this vehicle
            loadInspectionsForVehicle(vehicleId);
            
            // Show inspection section
            document.getElementById('inspection-section').style.display = 'block';
            document.getElementById('inspection-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Load inspections for selected vehicle
        function loadInspectionsForVehicle(vehicleId) {
            const vehicleReports = userReports.filter(r => r.vehicle_id === vehicleId);
            const inspectionsContainer = document.getElementById('inspections-list');
            
            inspectionsContainer.innerHTML = vehicleReports.map(report => {
                const date = new Date(report.created_at);
                const dateStr = date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const hasDamage = report.damage_summary && 
                    (report.damage_summary.toLowerCase().includes('damage') || 
                     report.damage_summary.toLowerCase().includes('scratch') ||
                     report.damage_summary.toLowerCase().includes('dent') ||
                     report.damage_summary.toLowerCase().includes('confirmed'));

                return `
                    <div class="selection-item inspection-card" onclick="selectInspection('${report.id}')">
                        <div class="inspection-title">Inspection ${report.id.slice(0, 8)}</div>
                        <div class="inspection-date">${dateStr}</div>
                        <div class="damage-indicator ${hasDamage ? 'damage-yes' : 'damage-no'}">
                            ${hasDamage ? 'Damage Found' : 'Clean'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select an inspection
        function selectInspection(reportId) {
            // Remove previous selection
            document.querySelectorAll('.inspection-card').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selection to clicked item
            event.target.closest('.inspection-card').classList.add('selected');

            selectedReport = userReports.find(r => r.id === reportId);
            
            // Show details section
            document.getElementById('details-section').style.display = 'block';
            document.getElementById('details-section').scrollIntoView({ behavior: 'smooth' });
            
            updateClaimSummary();
        }

        // Update claim summary
        function updateClaimSummary() {
            const summaryContainer = document.getElementById('claim-summary');
            
            if (!selectedVehicle || !selectedReport) {
                summaryContainer.innerHTML = '<p>Complete all steps to see summary</p>';
                return;
            }

            const claimType = document.getElementById('claim-type').value;
            const damageLocation = document.getElementById('damage-location').value;
            const description = document.getElementById('description').value;

            summaryContainer.innerHTML = `
                <div class="summary-item">
                    <span>Vehicle:</span>
                    <span>${selectedVehicle.make} ${selectedVehicle.model} (${selectedVehicle.license_plate})</span>
                </div>
                <div class="summary-item">
                    <span>Inspection:</span>
                    <span>${new Date(selectedReport.created_at).toLocaleDateString()}</span>
                </div>
                <div class="summary-item">
                    <span>Claim Type:</span>
                    <span>${claimType || 'Not selected'}</span>
                </div>
                <div class="summary-item">
                    <span>Damage Location:</span>
                    <span>${damageLocation ? damageLocation.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Not selected'}</span>
                </div>
            `;

            validateForm();
        }

        // Validate form and enable/disable submit button
        function validateForm() {
            const claimType = document.getElementById('claim-type').value;
            const damageLocation = document.getElementById('damage-location').value;
            const description = document.getElementById('description').value;
            
            const isValid = selectedVehicle && selectedReport && claimType && damageLocation && description.trim();
            document.getElementById('submit-btn').disabled = !isValid;
        }

        // Submit claim
        async function submitClaim(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const claimData = {
                    report_id: selectedReport.id,
                    user_id: currentUser.id,
                    claim_type: document.getElementById('claim-type').value,
                    damage_location: document.getElementById('damage-location').value,
                    description: document.getElementById('description').value,
                    status: 'processing'
                };

                // Save claim to database
                const { data: claimRecord, error } = await supabase
                    .from('claims')
                    .insert([claimData])
                    .select()
                    .single();

                if (error) throw error;

                // Update status to show document generation
                submitBtn.textContent = 'Generating Insurance Document...';

                // Send clean data to n8n webhook
                const webhookData = {
                    claim_id: claimRecord.id,
                    user_id: currentUser.id,
                    user_email: currentUser.email,
                    user_name: currentUser.user_metadata?.full_name || currentUser.email,
                    
                    // Vehicle information
                    vehicle_id: selectedVehicle.vehicle_id,
                    vehicle_license_plate: selectedVehicle.license_plate,
                    vehicle_make: selectedVehicle.make,
                    vehicle_model: selectedVehicle.model,
                    vehicle_year: selectedVehicle.year,
                    vehicle_color: selectedVehicle.color,
                    
                    // Report information  
                    report_id: selectedReport.id,
                    inspection_date: selectedReport.created_at,
                    damage_summary: selectedReport.damage_summary,
                    pdf_url: selectedReport.pdf_url,
                    total_photos: selectedReport.total_photos,
                    
                    // Claim details
                    claim_type: claimData.claim_type,
                    damage_location: claimData.damage_location,
                    description: claimData.description,
                    claim_date: new Date().toISOString()
                };

                console.log('üì§ Sending to n8n webhook:', webhookData);

                const webhookResponse = await fetch('https://hamzaw.app.n8n.cloud/webhook-test/bde57252-616c-414c-bf0a-536a9d7dd5ad', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webhookData)
                });

                if (webhookResponse.ok) {
                    showSuccess('üéâ Claim submitted successfully!<br><br>üìã Your professional insurance claim document is being generated and will be emailed to you within 5-10 minutes.<br><br>üìÑ This document contains all evidence, photos, and legal language needed for your insurance company.');
                } else {
                    throw new Error('Document generation failed');
                }
                
                // Redirect after success
                setTimeout(() => {
                    window.location.href = '/claims.html';
                }, 5000);

            } catch (error) {
                console.error('Error submitting claim:', error);
                showError('Failed to submit claim or generate document. Your claim may have been saved - please check your claims page.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Claim';
            }
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // Show success message
        function showSuccess(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="success-message">${message}</div>`;
        }

        // Event listeners
        document.getElementById('claim-form').addEventListener('submit', submitClaim);
        document.getElementById('claim-type').addEventListener('change', updateClaimSummary);
        document.getElementById('damage-location').addEventListener('change', updateClaimSummary);
        document.getElementById('description').addEventListener('input', updateClaimSummary);

        // Initialize on page load
        init();
    </script>
</body>
</html>
