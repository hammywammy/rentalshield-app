<script>
      let currentUser = null;
      let authChecked = false;
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Car Inspection Recorder</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        background: black;
      }
      video {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 0;
        background: #000;
      }
      #start-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        z-index: 15;
        padding: 2rem;
      }
      #start-screen h1 {
        font-size: 2rem;
        margin-bottom: 1rem;
      }
      #start-screen p {
        font-size: 1.2rem;
        margin-bottom: 2rem;
        opacity: 0.8;
        line-height: 1.4;
      }
      .btn {
        padding: 1rem 2rem;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 1.2rem;
        cursor: pointer;
        margin: 0.5rem;
        transition: background-color 0.2s;
      }
      .btn:hover {
        background: #45a049;
      }
      .btn-test {
        background: #ff9800;
        font-size: 1rem;
      }
      .btn-test:hover {
        background: #e68900;
      }
      #status-bar {
        position: fixed;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 1rem;
        font-size: 1.2rem;
        border-radius: 0.75rem;
        text-align: center;
        z-index: 10;
        user-select: none;
        display: none;
      }
      #step-instruction {
        position: fixed;
        bottom: 8rem;
        left: 1rem;
        right: 1rem;
        margin: 0 auto;
        background: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 1rem;
        border-radius: 0.75rem;
        font-size: 1.5rem;
        text-align: center;
        z-index: 10;
        line-height: 1.4;
        user-select: none;
        box-sizing: border-box;
        word-wrap: break-word;
        display: none;
      }
      #photo-button,
      #next-button {
        position: fixed;
        bottom: 1.5rem;
        padding: 0.8rem 1.6rem;
        font-size: 1.5rem;
        border-radius: 1rem;
        border: none;
        color: white;
        cursor: pointer;
        z-index: 10;
        user-select: none;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
        transition: background-color 0.3s, opacity 0.3s;
        display: none;
      }
      #photo-button {
        left: 50%;
        transform: translateX(-50%);
        background-color: #2196f3;
        font-size: 1.8rem;
        padding: 1rem 2rem;
      }
      #next-button {
        right: 1rem;
        background-color: #4caf50;
      }
      #next-button:disabled {
        background-color: #888;
        opacity: 0.5;
        cursor: not-allowed;
      }
      .flash-effect {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        z-index: 20;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.1s;
      }
      .flash-effect.active {
        opacity: 0.8;
      }
      
      /* Vehicle confirmation popup */
      .vehicle-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        z-index: 1000;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        max-width: 400px;
        width: 90%;
        color: #333;
      }
      .vehicle-popup h3 {
        margin: 0 0 1rem 0;
        color: #333;
        font-size: 1.3rem;
      }
      .vehicle-popup p {
        margin: 0.5rem 0;
        color: #666;
        font-size: 1rem;
      }
      .vehicle-popup strong {
        color: #333;
        font-size: 1.1rem;
      }
      .popup-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
      }
      .popup-btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        transition: background-color 0.2s;
      }
      .btn-yes {
        background: #4caf50;
        color: white;
      }
      .btn-no {
        background: #f44336;
        color: white;
      }
      .btn-yes:hover {
        background: #45a049;
      }
      .btn-no:hover {
        background: #da190b;
      }
      
      /* Manual vehicle form */
      .manual-form {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        text-align: left;
      }
      .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .form-row input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 0.25rem;
      }
      .form-row label {
        display: block;
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.25rem;
      }
    </style>
  </head>
  <body>
    <script>
      // AUTH COMPLETELY DISABLED - App works immediately
      let currentUser = { 
        id: 'user-' + Date.now(), 
        email: 'user@example.com' 
      };
      console.log('‚úÖ Auth disabled - using test user:', currentUser.email);
    </script>
    
    <video id="video" autoplay muted playsinline></video>
    <div id="flash-effect" class="flash-effect"></div>

    <!-- Start Screen -->
    <div id="start-screen">
      <h1>üöó Car Inspection</h1>
      <p>Welcome to the vehicle inspection app.<br><br>
      <strong>Instructions:</strong><br>
      ‚Ä¢ First, take a clear photo of your license plate<br>
      ‚Ä¢ Then follow the 18-step inspection process<br>
      ‚Ä¢ Each photo will be automatically uploaded and analyzed</p>
      <button id="start-inspection-btn" class="btn">Start Inspection</button>
      <button id="test-mode-btn" class="btn btn-test">üß™ Test Mode</button>
    </div>

    <!-- Status and Controls -->
    <div id="status-bar">Ready to start...</div>
    <div id="step-instruction">Loading...</div>
    <button id="photo-button">üì∏ Take Photo</button>
    <button id="next-button" disabled>Next Step</button>

    <script>
      console.log('Script starting...');
      
      const steps = [
        "Front bumper",
        "Driver side front fender", 
        "Driver side front wheel",
        "Driver side doors",
        "Driver side rear wheel",
        "Driver side rear fender",
        "Rear bumper",
        "Passenger side rear fender",
        "Passenger side rear wheel", 
        "Passenger side doors",
        "Passenger side front wheel",
        "Passenger side front fender",
        "Front windshield",
        "Interior: dashboard",
        "Interior: front seats",
        "Interior: rear seats",
        "Odometer",
        "Trunk/cargo area",
      ];

      let currentStep = -1; // -1 = license plate step, 0-17 = inspection steps
      let recordedBlob = null;
      let vehicleInfo = null;
      let detectedVehicle = null;
      let inspectionStarted = false;
      let uploadedVideoUrls = [];
      let isTestMode = false;
      let userVehicles = [];
      let currentVehicleId = null;

      // Test folder photos
      const testFolderPhotos = [
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-bumper.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-left-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-left-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/left-side-doors.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-left-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-left-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-bumper.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-right-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-right-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/right-side-doors.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-right-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-right-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-windshield.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/dashboard.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-seats.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-seats.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/odometer.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/trunk.jpg",
      ];

      // Get elements
      const video = document.getElementById("video");
      const statusBar = document.getElementById("status-bar");
      const stepInstruction = document.getElementById("step-instruction");
      const nextButton = document.getElementById("next-button");
      const photoButton = document.getElementById("photo-button");
      const startScreen = document.getElementById("start-screen");
      const startInspectionBtn = document.getElementById("start-inspection-btn");
      const testModeBtn = document.getElementById("test-mode-btn");
      const flashEffect = document.getElementById("flash-effect");

      console.log('Elements found:', {
        startInspectionBtn: !!startInspectionBtn,
        testModeBtn: !!testModeBtn,
        photoButton: !!photoButton,
        nextButton: !!nextButton
      });

      // Start camera
      async function startCamera() {
        try {
          console.log('Requesting camera...');
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280, max: 1280 },
              height: { ideal: 720, max: 720 },
              frameRate: { ideal: 30 },
            },
            audio: false,
          });
          video.srcObject = stream;
          console.log("Camera started successfully");
        } catch (e) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "environment",
                width: { ideal: 1024, max: 1024 },
                height: { ideal: 576, max: 576 },
                frameRate: { ideal: 30 },
              },
              audio: false,
            });
            video.srcObject = stream;
            console.log("Camera started with fallback settings");
          } catch (e2) {
            console.log("Camera not available:", e2);
            video.style.display = 'none';
          }
        }
      }

      // Generate vehicle UUID
      function generateVehicleUUID() {
        return `veh-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      }

      // Find existing vehicle in user's fleet
      function findUserVehicle(vehicleData) {
        return userVehicles.find(v => 
          v.plate.toLowerCase() === vehicleData.plate.toLowerCase() &&
          v.make.toLowerCase() === vehicleData.make.toLowerCase() &&
          v.model.toLowerCase() === vehicleData.model.toLowerCase()
        );
      }

      // Generate inspection ID
      function generateInspectionId() {
        const date = new Date().toISOString().split('T')[0];
        const time = Date.now();
        return `inspection-${date}-${time}`;
      }

      // Load user vehicles
      async function loadUserVehicles() {
        try {
          if (!currentUser) {
            console.log('No user logged in, skipping vehicle load');
            userVehicles = [];
            return;
          }
          
          console.log('Loading user vehicles...');
          const response = await fetch('/.netlify/functions/get-user-vehicles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              userId: currentUser.id,
              vehiclesPath: `rental-shield/users/${currentUser.id}/vehicles/`
            })
          });
          
          if (response.ok) {
            const data = await response.json();
            userVehicles = data.vehicles || [];
            console.log('Loaded user vehicles:', userVehicles);
          }
        } catch (error) {
          console.log("Couldn't load user vehicles:", error);
          userVehicles = [];
        }
      }

      // Start inspection
      async function startInspection() {
        console.log('Starting inspection...');
        isTestMode = false;
        inspectionStarted = true;
        
        await loadUserVehicles();
        
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        photoButton.style.display = "block";
        nextButton.style.display = "block";
        
        currentStep = -1; // Start with license plate
        updateStep();
      }

      // Test mode
      async function startTestMode() {
        console.log('Starting test mode...');
        isTestMode = true;
        inspectionStarted = true;
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        
        statusBar.textContent = "üß™ Creating test data from folder...";
        stepInstruction.textContent = "üß™ TEST MODE: Auto-sending test folder photos...";

        // Create test vehicle data
        detectedVehicle = {
          make: "Toyota",
          model: "Camry",
          year: "2023",
          color: "Silver",
          plate: "TEST123",
          confidence: 0.95
        };
        vehicleInfo = detectedVehicle;
        currentVehicleId = "veh-test123";

        // Create test data with photos from test folder
        uploadedVideoUrls = [];
        const testInspectionId = generateInspectionId();
        
        for (let i = 0; i < steps.length; i++) {
          uploadedVideoUrls.push({
            step: i + 1,
            stepName: steps[i],
            url: testFolderPhotos[i] || testFolderPhotos[0],
            type: "photo",
            timestamp: new Date().toISOString(),
            fileSize: Math.floor(Math.random() * 150 + 100) + " KB",
            vehicleId: currentVehicleId,
            inspectionId: testInspectionId,
            filePath: `rental-shield/users/test-user/vehicles/${currentVehicleId}/inspections/${testInspectionId}/step-${i + 1}-${steps[i].replace(/\s+/g, '-').toLowerCase()}.jpg`
          });
        }

        await new Promise((resolve) => setTimeout(resolve, 1000));

        statusBar.textContent = "üß™ Test data ready! Triggering webhook...";
        stepInstruction.textContent = "üß™ TEST MODE: Sending 18 test photos to AI analysis...";

        await triggerInspectionComplete();
      }

      // Update step display with vehicle history context
      function updateStep() {
        if (currentStep === -1) {
          stepInstruction.textContent = "üìã Step 0: Take a clear photo of your license plate";
          statusBar.textContent = "üì∏ License plate detection - Make sure plate is clearly visible";
        } else {
          let vehicleText = "Vehicle";
          let inspectionContext = "";
          
          if (detectedVehicle) {
            vehicleText = `${detectedVehicle.make} ${detectedVehicle.model} ${detectedVehicle.year}`;
            
            if (detectedVehicle.totalInspections > 0) {
              inspectionContext = ` (Inspection #${detectedVehicle.totalInspections + 1})`;
            } else {
              inspectionContext = " (First inspection)";
            }
          }
          
          stepInstruction.textContent = `${vehicleText}${inspectionContext} - Step ${currentStep + 1} of ${steps.length}: ${steps[currentStep]}`;
          statusBar.textContent = "üì∏ Ready to take photo";
        }
        
        nextButton.disabled = true;
        recordedBlob = null;
      }

      // Capture photo
      function capturePhoto() {
        console.log('Capturing photo...');
        
        // Flash effect
        flashEffect.classList.add("active");
        setTimeout(() => flashEffect.classList.remove("active"), 100);

        if (currentStep === -1) {
          // License plate step - silent detection
          detectLicensePlate();
        } else {
          // Regular inspection photo - upload to R2
          uploadToR2();
        }
      }

      // License plate detection with vehicle history matching
      async function detectLicensePlate() {
        try {
          statusBar.textContent = "üîç Analyzing license plate...";
          
          // Create a canvas to get image data
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          
          // Convert to base64
          const imageData = canvas.toDataURL('image/jpeg', 0.8);
          const base64 = imageData.split(',')[1];
          
          console.log('ü§ñ Calling vehicle detection API...');
          
          // Call your Netlify function for AI detection
          const response = await fetch('/.netlify/functions/detect-vehicle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              imageBase64: base64,
              checkPlateOnly: true,
              userId: currentUser?.id,
              vehiclesPath: `rental-shield/users/${currentUser?.id || 'anonymous'}/vehicles/`
            })
          });
          
          const result = await response.json();
          console.log('ü§ñ AI Detection result:', result);
          
          // Process result and check vehicle history
          if (result.success && result.vehicle && result.vehicle.plate) {
            statusBar.textContent = "‚úÖ Vehicle detected - checking history...";
            
            // Check if this vehicle exists in user's history
            const existingVehicle = findExistingVehicle(result.vehicle);
            
            if (existingVehicle) {
              // Found existing vehicle - show history confirmation
              console.log('üìã Found existing vehicle with history');
              result.vehicle.vehicleUUID = existingVehicle.vehicleUUID;
              result.vehicle.inspectionHistory = existingVehicle.inspectionHistory || [];
              result.vehicle.totalInspections = existingVehicle.inspectionHistory?.length || 0;
              result.vehicle.lastInspection = existingVehicle.inspectionHistory?.length > 0 ? 
                existingVehicle.inspectionHistory[existingVehicle.inspectionHistory.length - 1] : null;
              
              showVehicleHistoryConfirmation(result.vehicle, existingVehicle);
            } else {
              // New vehicle - show new vehicle confirmation
              console.log('üÜï New vehicle detected');
              result.vehicle.vehicleUUID = generateVehicleUUID();
              result.vehicle.inspectionHistory = [];
              result.vehicle.totalInspections = 0;
              result.vehicle.lastInspection = null;
              
              showNewVehicleConfirmation(result.vehicle);
            }
          } else {
            // AI couldn't detect vehicle clearly
            console.log('‚ùå No clear vehicle detection');
            statusBar.textContent = "‚ö†Ô∏è Could not detect license plate - manual entry required";
            
            setTimeout(() => {
              showManualVehicleEntry();
            }, 1500);
          }
          
        } catch (error) {
          console.error('‚ùå License plate detection error:', error);
          statusBar.textContent = "‚ö†Ô∏è Detection failed - manual entry required";
          
          setTimeout(() => {
            showManualVehicleEntry();
          }, 1500);
        }
      }

      // Show vehicle history confirmation for existing vehicles
      function showVehicleHistoryConfirmation(vehicleData, existingVehicle) {
        console.log('üìã Showing vehicle history confirmation:', vehicleData);
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'vehicle-history-confirmation';
        
        // Format last inspection date
        let lastInspectionText = '';
        if (vehicleData.lastInspection) {
          const lastDate = new Date(vehicleData.lastInspection.date || vehicleData.lastInspection.timestamp).toLocaleDateString();
          lastInspectionText = `<p style="color: #2e7d32; font-size: 0.9rem; font-weight: 500;">
            üìÖ Last inspection: ${lastDate}
          </p>`;
        }
        
        popup.innerHTML = `
          <h3>üöó Is this your vehicle?</h3>
          <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
            <p style="margin: 0.5rem 0; font-size: 1.1rem;"><strong>${vehicleData.make} ${vehicleData.model} ${vehicleData.year}</strong></p>
            <p style="margin: 0.5rem 0; color: #666;">${vehicleData.color} ‚Ä¢ ${vehicleData.plate}</p>
            ${lastInspectionText}
            <p style="color: #1976d2; font-size: 0.9rem; font-weight: 500;">
              üìä ${vehicleData.totalInspections} previous inspection${vehicleData.totalInspections !== 1 ? 's' : ''} on record
            </p>
          </div>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="confirmExistingVehicle(true)">‚úÖ Yes, same vehicle</button>
            <button class="popup-btn btn-no" onclick="confirmExistingVehicle(false)">‚ùå No, different vehicle</button>
          </div>
        `;
        
        detectedVehicle = vehicleData;
        document.body.appendChild(popup);
      }

      // Show new vehicle confirmation
      function showNewVehicleConfirmation(vehicleData) {
        console.log('üÜï Showing new vehicle confirmation:', vehicleData);
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'new-vehicle-confirmation';
        
        popup.innerHTML = `
          <h3>üÜï New vehicle detected</h3>
          <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
            <p style="margin: 0.5rem 0; font-size: 1.1rem;"><strong>${vehicleData.make} ${vehicleData.model} ${vehicleData.year}</strong></p>
            <p style="margin: 0.5rem 0; color: #666;">${vehicleData.color} ‚Ä¢ ${vehicleData.plate}</p>
            <p style="color: #ed6c02; font-size: 0.9rem; font-weight: 500;">
              üìù This will be your first inspection of this vehicle
            </p>
          </div>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="confirmNewVehicle(true)">‚úÖ Correct, add to my vehicles</button>
            <button class="popup-btn btn-no" onclick="confirmNewVehicle(false)">‚ùå Wrong vehicle info</button>
          </div>
        `;
        
        detectedVehicle = vehicleData;
        document.body.appendChild(popup);
      }

      // Show manual vehicle entry
      function showManualVehicleEntry() {
        console.log('Showing manual vehicle entry');
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'manual-vehicle-entry';
        popup.innerHTML = `
          <h3>üìù Enter Vehicle Details</h3>
          <div class="manual-form">
            <div class="form-row">
              <div>
                <label>Make</label>
                <input type="text" id="manual-make" placeholder="Toyota" required>
              </div>
              <div>
                <label>Model</label>
                <input type="text" id="manual-model" placeholder="Camry" required>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Year</label>
                <input type="number" id="manual-year" min="1990" max="2025" placeholder="2023" required>
              </div>
              <div>
                <label>Color</label>
                <input type="text" id="manual-color" placeholder="Silver" required>
              </div>
            </div>
            <div class="form-row">
              <div style="flex: 1;">
                <label>License Plate</label>
                <input type="text" id="manual-plate" placeholder="ABC123" required>
              </div>
            </div>
          </div>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="saveManualVehicle()">üíæ Save & Continue</button>
          </div>
        `;
        
        document.body.appendChild(popup);
      }

      // Global functions for popup interactions
      window.confirmExistingVehicle = async function(confirmed) {
        console.log('üöó Existing vehicle confirmation:', confirmed);
        const popup = document.getElementById('vehicle-history-confirmation');
        if (popup) popup.remove();
        
        if (confirmed) {
          // User confirmed this is the same vehicle - add new inspection to existing history
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.vehicleUUID;
          console.log('‚úÖ Adding inspection to existing vehicle:', currentVehicleId);
          console.log('üìä Previous inspections:', detectedVehicle.totalInspections);
          
          statusBar.textContent = `‚úÖ Vehicle confirmed - inspection #${detectedVehicle.totalInspections + 1}`;
          currentStep = 0;
          updateStep();
          nextButton.disabled = false;
        } else {
          // User says this is a different vehicle - show manual entry
          console.log('‚ùå User says this is different vehicle');
          showManualVehicleEntry();
        }
      };

      window.confirmNewVehicle = async function(confirmed) {
        console.log('üÜï New vehicle confirmation:', confirmed);
        const popup = document.getElementById('new-vehicle-confirmation');
        if (popup) popup.remove();
        
        if (confirmed) {
          // User confirmed new vehicle info is correct
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.vehicleUUID;
          console.log('‚úÖ Creating new vehicle record:', currentVehicleId);
          
          statusBar.textContent = "‚úÖ New vehicle added - first inspection";
          currentStep = 0;
          updateStep();
          nextButton.disabled = false;
        } else {
          // User says vehicle info is wrong - show manual entry
          console.log('‚ùå User says vehicle info is wrong');
          showManualVehicleEntry();
        }
      };

      window.saveManualVehicle = async function() {
        console.log('üíæ Saving manual vehicle...');
        const make = document.getElementById('manual-make').value.trim();
        const model = document.getElementById('manual-model').value.trim();
        const year = document.getElementById('manual-year').value.trim();
        const color = document.getElementById('manual-color').value.trim();
        const plate = document.getElementById('manual-plate').value.trim();
        
        if (!make || !model || !year || !color || !plate) {
          alert('Please fill in all fields');
          return;
        }
        
        // Check if manually entered vehicle already exists
        const manualVehicle = { make, model, year, color, plate, confidence: 1.0 };
        const existingVehicle = findExistingVehicle(manualVehicle);
        
        if (existingVehicle) {
          // Found existing vehicle with manual entry
          console.log('üìã Manual entry matches existing vehicle');
          detectedVehicle = {
            ...manualVehicle,
            vehicleUUID: existingVehicle.vehicleUUID,
            inspectionHistory: existingVehicle.inspectionHistory || [],
            totalInspections: existingVehicle.inspectionHistory?.length || 0
          };
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.vehicleUUID;
          statusBar.textContent = `‚úÖ Vehicle found - inspection #${detectedVehicle.totalInspections + 1}`;
        } else {
          // Create new vehicle from manual entry
          console.log('üÜï Creating new vehicle from manual entry');
          detectedVehicle = manualVehicle;
          detectedVehicle.vehicleUUID = generateVehicleUUID();
          detectedVehicle.inspectionHistory = [];
          detectedVehicle.totalInspections = 0;
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.vehicleUUID;
          statusBar.textContent = "‚úÖ New vehicle created - first inspection";
        }
        
        const popup = document.getElementById('manual-vehicle-entry');
        if (popup) popup.remove();
        
        currentStep = 0;
        updateStep();
        nextButton.disabled = false;
      };

      // Upload to R2 function with new structure
      async function uploadToR2() {
        try {
          statusBar.textContent = "üì§ Uploading photo...";
          
          // Create a canvas to get image data
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          
          // Convert to blob
          canvas.toBlob(async (blob) => {
            if (!blob) {
              statusBar.textContent = "‚ùå Failed to capture photo";
              return;
            }
            
            // Create new hierarchical file path
            const userId = currentUser?.id || 'anonymous';
            const vehicleId = currentVehicleId || 'unknown-vehicle';
            const inspectionId = generateInspectionId();
            
            let fileName;
            if (currentStep === -1) {
              // License plate photo
              fileName = `rental-shield/users/${userId}/vehicles/${vehicleId}/inspections/${inspectionId}/license-plate.jpg`;
            } else {
              // Inspection step photo
              fileName = `rental-shield/users/${userId}/vehicles/${vehicleId}/inspections/${inspectionId}/step-${currentStep + 1}-${steps[currentStep].replace(/\s+/g, '-').toLowerCase()}.jpg`;
            }

            console.log('Uploading to new structure:', fileName);

            // Try to upload to R2
            try {
              const formData = new FormData();
              formData.append('file', blob, fileName);
              formData.append('fileName', fileName);
              formData.append('bucketName', 'rental-shield');
              formData.append('metadata', JSON.stringify({
                vehicleId: vehicleId,
                inspectionId: inspectionId,
                userId: userId,
                vehicleData: detectedVehicle,
                stepNumber: currentStep + 1,
                stepName: steps[currentStep],
                isLicensePlate: currentStep === -1
              }));

              const response = await fetch('/.netlify/functions/upload-to-r2', {
                method: 'POST',
                body: formData
              });

              if (response.ok) {
                const result = await response.json();
                const uploadUrl = result.url;
                
                // Track the uploaded file with new structure info
                if (currentStep >= 0) {
                  const fileInfo = {
                    step: currentStep + 1,
                    stepName: steps[currentStep],
                    url: uploadUrl,
                    type: "photo",
                    timestamp: new Date().toISOString(),
                    fileSize: Math.round(blob.size / 1024) + " KB",
                    vehicleId: vehicleId,
                    inspectionId: inspectionId,
                    filePath: fileName
                  };
                  
                  uploadedVideoUrls.push(fileInfo);
                }

                statusBar.textContent = `‚úÖ Photo uploaded! (${Math.round(blob.size / 1024)} KB)`;
                nextButton.disabled = false;
                console.log('Upload successful:', uploadUrl);
              } else {
                throw new Error(`Upload failed: ${response.status}`);
              }
            } catch (uploadError) {
              console.error('R2 upload failed:', uploadError);
              statusBar.textContent = "‚ö†Ô∏è R2 upload failed - continuing anyway";
              nextButton.disabled = false;
            }
          }, 'image/jpeg', 0.8);
          
        } catch (error) {
          console.error('Upload error:', error);
          statusBar.textContent = "‚ö†Ô∏è Upload error - continuing anyway";
          nextButton.disabled = false;
        }
      }

      // Next step
      function nextStep() {
        console.log('Next step...');
        if (currentStep < steps.length - 1) {
          currentStep++;
          updateStep();
        } else {
          stepInstruction.textContent = "üéâ Inspection completed! Processing...";
          nextButton.style.display = "none";
          photoButton.style.display = "none";
          statusBar.textContent = "Sending to AI analysis...";
          
          triggerInspectionComplete();
        }
      }

      // Trigger inspection completion webhook with enhanced data
      async function triggerInspectionComplete() {
        const inspectionId = uploadedVideoUrls[0]?.inspectionId || generateInspectionId();
        const completionData = {
          inspectionId: inspectionId,
          vehicleInfo: {
            ...vehicleInfo,
            vehicleId: currentVehicleId,
            isNewVehicle: !userVehicles.find(v => v.vehicleId === currentVehicleId)
          },
          userInfo: {
            userId: currentUser?.id || 'anonymous',
            email: currentUser?.email || 'unknown'
          },
          completedAt: new Date().toISOString(),
          totalSteps: steps.length,
          uploadedFiles: uploadedVideoUrls,
          folderStructure: {
            basePath: `rental-shield/users/${currentUser?.id || 'anonymous'}/vehicles/${currentVehicleId}/inspections/${inspectionId}/`,
            licensePlatePhoto: `rental-shield/users/${currentUser?.id || 'anonymous'}/vehicles/${currentVehicleId}/inspections/${inspectionId}/license-plate.jpg`,
            inspectionPhotos: uploadedVideoUrls.map(file => file.filePath)
          },
          summary: {
            totalFiles: uploadedVideoUrls.length,
            totalSize: uploadedVideoUrls.reduce((sum, file) => {
              return sum + parseInt(file.fileSize.replace(" KB", ""));
            }, 0) + " KB",
            photoCount: uploadedVideoUrls.length,
            videoCount: 0,
          },
          readyForAIAnalysis: true,
          status: "inspection_complete",
          testMode: isTestMode,
        };

        try {
          const webhookUrl = "https://hamzaw.app.n8n.cloud/webhook-test/50903630-1eac-46a7-a041-6b5614e9f533";

          console.log("üöÄ Triggering inspection completion webhook...");
          console.log("Completion data:", completionData);

          const response = await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(completionData),
          });

          if (response.ok) {
            const vehicleText = vehicleInfo.make ? 
              `${vehicleInfo.make} ${vehicleInfo.model} ${vehicleInfo.year}` : 
              "Vehicle";
            stepInstruction.textContent = `‚úÖ ${vehicleText} inspection sent for AI analysis!`;
            statusBar.textContent = "Processing complete - AI analysis started! ü§ñ";
            console.log("‚úÖ Webhook sent successfully!");

            // Update user's vehicle list if this was a new vehicle
            if (!userVehicles.find(v => v.vehicleId === currentVehicleId)) {
              userVehicles.push({
                vehicleId: currentVehicleId,
                ...vehicleInfo,
                inspectionHistory: [{ date: new Date().toISOString(), inspectionId }]
              });
            }
          } else {
            throw new Error(`Webhook failed: ${response.status}`);
          }
        } catch (error) {
          console.error("Webhook trigger failed:", error);
          stepInstruction.textContent = "‚ö†Ô∏è Analysis trigger failed - inspection data saved locally";
          statusBar.textContent = "Inspection complete - please contact support if needed";
        }
      }

      // Lighting check function
      function checkLighting() {
        if (!inspectionStarted || video.readyState < 2) return;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth || 100;
        canvas.height = video.videoHeight || 100;

        if (video.videoWidth > 0) {
          ctx.drawImage(video, 0, 0);
          const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
          let total = 0;

          for (let i = 0; i < frame.data.length; i += 4) {
            const brightness =
              0.299 * frame.data[i] +
              0.587 * frame.data[i + 1] +
              0.114 * frame.data[i + 2];
            total += brightness;
          }

          const avg = total / (frame.data.length / 4);
          const lightOK = avg > 30 && avg < 200;

          if (currentStep === -1) {
            if (!statusBar.textContent.includes("‚úÖ") && !statusBar.textContent.includes("üì§") && !statusBar.textContent.includes("üîç")) {
              statusBar.textContent = `Lighting: ${lightOK ? "üü¢ Good" : "üü° Check"} | License plate detection ready`;
            }
          } else if (!statusBar.textContent.includes("‚úÖ") && !statusBar.textContent.includes("üì§")) {
            statusBar.textContent = `Lighting: ${lightOK ? "üü¢ Good" : "üü° Check"} | Ready for photo`;
          }
        } else {
          if (currentStep === -1) {
            statusBar.textContent = "üì∑ License plate detection ready";
          } else if (!statusBar.textContent.includes("‚úÖ") && !statusBar.textContent.includes("üì§")) {
            statusBar.textContent = "üì∑ Ready for photo";
          }
        }
      }

      function loopStatus() {
        checkLighting();
        requestAnimationFrame(loopStatus);
      }

      // Event listeners
      startInspectionBtn.addEventListener("click", function() {
        console.log('Start button clicked!');
        startInspection();
      });

      testModeBtn.addEventListener("click", function() {
        console.log('Test button clicked!');
        startTestMode();
      });

      photoButton.addEventListener("click", function() {
        console.log('Photo button clicked!');
        capturePhoto();
      });

      nextButton.addEventListener("click", function() {
        console.log('Next button clicked!');
        nextStep();
      });

      // Initialize
      console.log('Setting up camera...');
      startCamera();
      loopStatus();
      console.log('Setup complete!');
    </script>
  </body>
</html>
