<!DOCTYPE html>
<html lang="en">
  <head>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Car Inspection Recorder - Photo Only</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        background: black;
      }
      video {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 0;
      }
      #start-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        z-index: 15;
        padding: 2rem;
      }
      #start-screen h1 {
        font-size: 2rem;
        margin-bottom: 1rem;
      }
      #start-screen p {
        font-size: 1.2rem;
        margin-bottom: 2rem;
        opacity: 0.8;
      }
      #start-inspection-btn {
        padding: 1rem 2rem;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 1.2rem;
        cursor: pointer;
      }
      #test-mode-btn {
        padding: 0.5rem 1rem;
        background: #ff9800;
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 1rem;
      }
      #status-bar {
        position: fixed;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 1rem;
        font-size: 1.2rem;
        border-radius: 0.75rem;
        text-align: center;
        z-index: 10;
        user-select: none;
        display: none;
      }
      #step-instruction {
        position: fixed;
        bottom: 8rem;
        left: 1rem;
        right: 1rem;
        margin: 0 auto;
        background: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 1rem;
        border-radius: 0.75rem;
        font-size: 1.5rem;
        text-align: center;
        z-index: 10;
        line-height: 1.4;
        user-select: none;
        box-sizing: border-box;
        word-wrap: break-word;
        display: none;
      }
      #photo-button,
      #next-button,
      #retry-button {
        position: fixed;
        bottom: 1.5rem;
        padding: 0.8rem 1.6rem;
        font-size: 1.5rem;
        border-radius: 1rem;
        border: none;
        color: white;
        cursor: pointer;
        z-index: 10;
        user-select: none;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
        transition: background-color 0.3s, opacity 0.3s;
        display: none;
      }
      #photo-button {
        left: 50%;
        transform: translateX(-50%);
        background-color: #2196f3;
        font-size: 1.8rem;
        padding: 1rem 2rem;
      }
      #next-button {
        right: 1rem;
        background-color: #4caf50;
      }
      #retry-button {
        left: 1rem;
        background-color: #ff9800;
      }
      #next-button:disabled {
        background-color: #888;
        opacity: 0.5;
        cursor: not-allowed;
      }
      .flash-effect {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        z-index: 20;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.1s;
      }
      .flash-effect.active {
        opacity: 0.8;
      }
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        text-align: center;
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .spinner {
        animation: spin 1s linear infinite;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        margin: 0 auto 1rem;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .vehicle-info {
        text-align: left;
        margin: 1rem 0;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
      }
      .modal-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
        flex-wrap: wrap;
      }
      .modal-button {
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }
      .btn-success { background: #28a745; color: white; }
      .btn-danger { background: #dc3545; color: white; }
      .btn-warning { background: #ffc107; color: black; }
      .btn-primary { background: #007bff; color: white; }
      .form-group {
        margin-bottom: 1rem;
        text-align: left;
      }
      .form-group label {
        display: block;
        margin-bottom: 4px;
        font-weight: bold;
      }
      .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .error-message {
        color: #dc3545;
        font-size: 14px;
        margin-top: 0.5rem;
      }
      .warning-box {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
      }
    </style>
  </head>
  <body>
    <script>
      let currentUser = null;

      // Check authentication on page load
      netlifyIdentity.on('init', user => {
          if (!user) {
              // No user logged in, redirect to auth
              window.location.href = '/auth.html';
              return;
          }
          
          currentUser = user;
          console.log('Authenticated user:', user);
          
          // Continue with your existing app initialization
          initializeApp();
      });

      // Your existing initialization code goes in this function
      function initializeApp() {
          // Move your existing window.onload code here
          startCamera();
          loopStatus();
          // ... rest of your existing code
      }

      netlifyIdentity.init();
    </script>
    
    <video id="video" autoplay muted playsinline></video>

    <!-- Camera flash effect -->
    <div id="flash-effect" class="flash-effect"></div>

    <!-- Start Screen -->
    <div id="start-screen">
      <h1>🚗 Car Inspection</h1>
      <p>Point your camera at the front bumper to begin.<br>Vehicle details will be detected automatically.</p>
      <button id="start-inspection-btn">Start Inspection</button>
      <button id="test-mode-btn">🧪 Test Mode</button>
    </div>

    <!-- Status and Controls -->
    <div id="status-bar">Lighting: ...</div>
    <div id="step-instruction">Loading steps...</div>
    <button id="photo-button">📸 Take Photo</button>
    <button id="next-button" disabled>Next Step</button>
    <button id="retry-button">🔄 Retry Photo</button>

    <script>
      const steps = [
        "Front bumper",
        "Driver side front fender",
        "Driver side front wheel",
        "Driver side doors",
        "Driver side rear wheel",
        "Driver side rear fender",
        "Rear bumper",
        "Passenger side rear fender",
        "Passenger side rear wheel",
        "Passenger side doors",
        "Passenger side front wheel",
        "Passenger side front fender",
        "Front windshield",
        "Interior: dashboard",
        "Interior: front seats",
        "Interior: rear seats",
        "Odometer",
        "Trunk/cargo area",
      ];

      // Test folder photos - your R2 bucket URLs
      const testFolderPhotos = [
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-bumper.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-left-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-left-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/left-side-doors.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-left-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-left-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-bumper.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-right-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-right-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/right-side-doors.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-right-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-right-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-windshield.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/dashboard.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-seats.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-seats.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/odometer.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/trunk.jpg",
      ];

      let currentStep = 0;
      let recordedBlob = null;
      let vehicleInfo = null;
      let detectedVehicle = null;
      let inspectionStarted = false;
      let uploadedVideoUrls = [];
      let isTestMode = false;

      const video = document.getElementById("video");
      const statusBar = document.getElementById("status-bar");
      const stepInstruction = document.getElementById("step-instruction");
      const nextButton = document.getElementById("next-button");
      const photoButton = document.getElementById("photo-button");
      const retryButton = document.getElementById("retry-button");
      const startScreen = document.getElementById("start-screen");
      const startInspectionBtn = document.getElementById("start-inspection-btn");
      const testModeBtn = document.getElementById("test-mode-btn");
      const flashEffect = document.getElementById("flash-effect");

      // Start camera with optimized settings
      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280, max: 1280 },
              height: { ideal: 720, max: 720 },
              frameRate: { ideal: 30 },
            },
            audio: false,
          });
          video.srcObject = stream;
        } catch (e) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "environment",
                width: { ideal: 1024, max: 1024 },
                height: { ideal: 576, max: 576 },
                frameRate: { ideal: 30 },
              },
              audio: false,
            });
            video.srcObject = stream;
          } catch (e2) {
            console.log("Camera not available, test mode will work anyway");
          }
        }
      }

      // Start inspection event listeners
      startInspectionBtn.addEventListener("click", () => {
        isTestMode = false;
        startInspection();
      });

      testModeBtn.addEventListener("click", async () => {
        isTestMode = true;
        await autoSendTestPhotos();
      });

      // Start inspection
      function startInspection() {
        inspectionStarted = true;
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        photoButton.style.display = "block";
        nextButton.style.display = "block";
        
        updateStep();
      }

      // Auto-send test photos
      async function autoSendTestPhotos() {
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        
        statusBar.textContent = "🧪 Creating test data from folder...";
        stepInstruction.textContent = "🧪 TEST MODE: Auto-sending test folder photos...";

        // Create test vehicle data
        detectedVehicle = {
          make: "Toyota",
          model: "Camry",
          year: "2023",
          color: "Silver",
          plate: "TEST123",
          confidence: 0.95,
          condition: "Test Mode",
          notes: "Test vehicle for demo purposes"
        };
        vehicleInfo = detectedVehicle;

        // Create test data with photos from test folder
        uploadedVideoUrls = [];
        for (let i = 0; i < steps.length; i++) {
          uploadedVideoUrls.push({
            step: i + 1,
            stepName: steps[i],
            url: testFolderPhotos[i] || testFolderPhotos[0],
            type: "photo",
            timestamp: new Date().toISOString(),
            fileSize: Math.floor(Math.random() * 150 + 100) + " KB",
          });
        }

        await new Promise((resolve) => setTimeout(resolve, 1000));

        statusBar.textContent = "🧪 Test data ready! Triggering webhook...";
        stepInstruction.textContent = "🧪 TEST MODE: Sending 18 test photos to AI analysis...";

        await triggerInspectionComplete();
      }

      // Update step display
      function updateStep() {
        const vehicleText = detectedVehicle ? 
          `${detectedVehicle.make} ${detectedVehicle.model} ${detectedVehicle.year}` : 
          "Vehicle";
          
        stepInstruction.textContent = `${vehicleText} - Step ${currentStep + 1} of ${steps.length}: Photo — ${steps[currentStep]}`;
        nextButton.disabled = true;
        retryButton.style.display = "none";
        recordedBlob = null;
      }

      // Capture photo with edge case handling
      async function capturePhoto() {
        try {
          // Show flash effect
          flashEffect.classList.add("active");
          setTimeout(() => {
            flashEffect.classList.remove("active");
          }, 100);

          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          
          // Convert to blob
          canvas.toBlob(async (blob) => {
            recordedBlob = blob;
            
            // If this is step 1 (front bumper), detect vehicle and validate photo
            if (currentStep === 0) {
              await detectVehicleAndValidate(blob);
            } else {
              // For other steps, just validate photo quality
              await validatePhotoQuality(blob);
            }
          }, 'image/jpeg', 0.8);
          
        } catch (error) {
          console.error('Error capturing photo:', error);
          showErrorModal("Failed to capture photo. Please try again.");
        }
      }

      // Detect vehicle and validate first photo
      async function detectVehicleAndValidate(photoBlob) {
        try {
          showLoadingModal("🔍 Analyzing photo...", "Detecting vehicle and checking photo quality");
          
          const base64 = await blobToBase64(photoBlob);
          
          const response = await fetch('/.netlify/functions/detect-vehicle', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              imageBase64: base64.split(',')[1],
              validatePhoto: true // Request photo validation
            })
          });
          
          const result = await response.json();
          hideModal();
          
          // Handle various response scenarios
          if (result.photoIssues && result.photoIssues.length > 0) {
            handlePhotoIssues(result.photoIssues, result.vehicle);
          } else if (result.success && result.vehicle) {
            detectedVehicle = result.vehicle;
            showVehicleConfirmation(result.vehicle);
          } else {
            // No vehicle detected but photo is okay
            showManualVehicleEntry("No vehicle detected in photo. Please enter details manually.");
          }
          
        } catch (error) {
          hideModal();
          console.error('Vehicle detection error:', error);
          showManualVehicleEntry("Detection failed. Please enter vehicle details manually.");
        }
      }

      // Validate photo quality for non-first steps
      async function validatePhotoQuality(photoBlob) {
        try {
          showLoadingModal("📸 Validating photo...", "Checking photo quality");
          
          const base64 = await blobToBase64(photoBlob);
          
          const response = await fetch('/.netlify/functions/validate-photo', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              imageBase64: base64.split(',')[1],
              expectedContent: steps[currentStep]
            })
          });
          
          const result = await response.json();
          hideModal();
          
          if (result.issues && result.issues.length > 0) {
            handlePhotoIssues(result.issues);
          } else {
            // Photo is good, proceed with upload
            await uploadToR2();
            proceedToNextStep();
          }
          
        } catch (error) {
          hideModal();
          console.error('Photo validation error:', error);
          // If validation fails, just proceed (don't block user)
          await uploadToR2();
          proceedToNextStep();
        }
      }

      // Handle photo issues (blurry, no vehicle, multiple vehicles, etc.)
      function handlePhotoIssues(issues, vehicleInfo = null) {
        const issueDescriptions = {
          'blurry': 'Photo is too blurry',
          'no_vehicle': 'No vehicle visible in photo',
          'multiple_vehicles': 'Multiple vehicles detected',
          'no_license_plate': 'License plate not visible',
          'poor_lighting': 'Poor lighting conditions',
          'wrong_angle': 'Wrong angle or perspective',
          'obstruction': 'Vehicle is partially obstructed'
        };

        const issueList = issues.map(issue => `• ${issueDescriptions[issue] || issue}`).join('<br>');
        
        showPhotoIssueModal(issueList, vehicleInfo);
      }

      // Show photo issue modal
      function showPhotoIssueModal(issueList, vehicleInfo = null) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'photo-issue-modal';
        
        let content = `
          <div class="modal-content">
            <h3>⚠️ Photo Quality Issues</h3>
            <div class="warning-box">
              <strong>Issues detected:</strong><br>
              ${issueList}
            </div>
            <p>For best results, please retake the photo with:</p>
            <ul style="text-align: left;">
              <li>Good lighting</li>
              <li>Clear focus</li>
              <li>Single vehicle in frame</li>
              <li>Proper angle</li>
            </ul>
        `;

        if (vehicleInfo) {
          content += `
            <div class="vehicle-info">
              <strong>Vehicle detected despite issues:</strong><br>
              ${vehicleInfo.make} ${vehicleInfo.model} ${vehicleInfo.year}<br>
              ${vehicleInfo.color} - ${vehicleInfo.plate}
            </div>
          `;
        }

        content += `
            <div class="modal-buttons">
              <button class="modal-button btn-warning" onclick="retakePhoto()">
                📸 Retake Photo
              </button>
              <button class="modal-button btn-success" onclick="proceedAnyway(${vehicleInfo ? 'true' : 'false'})">
                ✅ Use Anyway
              </button>
            </div>
          </div>
        `;

        modal.innerHTML = content;
        document.body.appendChild(modal);
      }

      // Global functions for modal buttons
      window.retakePhoto = function() {
        hideModal();
        retryButton.style.display = "block";
        statusBar.textContent = "📸 Ready to retake photo";
      };

      window.proceedAnyway = async function(hasVehicleInfo) {
        hideModal();
        
        if (currentStep === 0) {
          if (hasVehicleInfo && detectedVehicle) {
            // Use detected vehicle info despite issues
            vehicleInfo = detectedVehicle;
            await uploadToR2();
            proceedToNextStep();
          } else {
            // No vehicle detected, force manual entry
            showManualVehicleEntry("Please enter vehicle details manually:");
          }
        } else {
          // For other steps, just proceed
          await uploadToR2();
          proceedToNextStep();
        }
      };

      // Show loading modal
      function showLoadingModal(title, message) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'loading-modal';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="spinner"></div>
            <h3>${title}</h3>
            <p>${message}</p>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // Show vehicle confirmation
      function showVehicleConfirmation(vehicleData) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'vehicle-confirmation';
        modal.innerHTML = `
          <div class="modal-content">
            <h3>🚗 Vehicle Detected!</h3>
            <div class="vehicle-info">
              <p><strong>Make:</strong> ${vehicleData.make}</p>
              <p><strong>Model:</strong> ${vehicleData.model}</p>
              <p><strong>Year:</strong> ${vehicleData.year}</p>
              <p><strong>Color:</strong> ${vehicleData.color}</p>
              <p><strong>License:</strong> ${vehicleData.plate}</p>
              <p><strong>Confidence:</strong> ${Math.round(vehicleData.confidence * 100)}%</p>
            </div>
            <div class="modal-buttons">
              <button class="modal-button btn-success" onclick="confirmVehicle(true)">
                ✅ Correct
              </button>
              <button class="modal-button btn-danger" onclick="confirmVehicle(false)">
                ❌ Wrong
              </button>
              <button class="modal-button btn-warning" onclick="editVehicleInfo()">
                ✏️ Edit
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // Show manual vehicle entry
      function showManualVehicleEntry(message = "Enter Vehicle Information") {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'manual-vehicle-modal';
        modal.innerHTML = `
          <div class="modal-content">
            <h3>${message}</h3>
            <form id="manual-vehicle-form">
              <div class="form-group">
                <label>License Plate:</label>
                <input type="text" id="edit-plate" value="${detectedVehicle.plate}" required>
              </div>
              <div class="modal-buttons">
                <button type="submit" class="modal-button btn-primary">
                  Save & Continue
                </button>
              </div>
            </form>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('edit-vehicle-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          detectedVehicle = {
            make: document.getElementById('edit-make').value,
            model: document.getElementById('edit-model').value,
            year: document.getElementById('edit-year').value,
            color: document.getElementById('edit-color').value,
            plate: document.getElementById('edit-plate').value,
            confidence: detectedVehicle.confidence,
            condition: "Edited",
            notes: "Edited by user"
          };
          
          vehicleInfo = detectedVehicle;
          hideModal();
          
          await uploadToR2();
          proceedToNextStep();
        });
      };

      // Hide modal
      function hideModal() {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => modal.remove());
      }

      // Helper function to convert blob to base64
      function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      // Upload to Cloudflare R2
      async function uploadToR2() {
        try {
          if (!recordedBlob && !isTestMode) {
            console.error('No recorded blob available');
            return;
          }

          statusBar.textContent = `Lighting: 🟢 OK | Uploading photo...`;

          let uploadResult;

          if (isTestMode) {
            uploadResult = testFolderPhotos[currentStep] || testFolderPhotos[0];
            await new Promise((resolve) => setTimeout(resolve, 500));
          } else {
            // Create vehicle-based file path
            let fileName;
            if (detectedVehicle) {
              const vehicleId = `${detectedVehicle.make}_${detectedVehicle.model}_${detectedVehicle.year}_${detectedVehicle.plate}`.replace(/[^a-zA-Z0-9]/g, '_');
              const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
              const userId = currentUser?.id || 'anonymous';
              
              fileName = `${userId}/${vehicleId}/${timestamp}/step-${currentStep + 1}-${steps[currentStep].replace(/\s+/g, '-').toLowerCase()}.jpg`;
            } else {
              fileName = `inspection-${Date.now()}-step-${currentStep + 1}.jpg`;
            }

            // Your existing R2 upload code would go here
            // For now, we'll simulate it
            uploadResult = `https://your-r2-bucket.com/${fileName}`;
            console.log('Would upload to:', fileName);
          }

          if (uploadResult) {
            uploadedVideoUrls.push({
              step: currentStep + 1,
              stepName: steps[currentStep],
              url: uploadResult,
              type: "photo",
              timestamp: new Date().toISOString(),
              fileSize: isTestMode
                ? Math.floor(Math.random() * 150 + 100) + " KB"
                : Math.round(recordedBlob.size / 1024) + " KB",
            });

            statusBar.textContent = `Lighting: 🟢 OK | Photo uploaded! ✅ (${
              isTestMode
                ? "Test photo"
                : Math.round(recordedBlob.size / 1024) + " KB"
            })`;
            
            console.log("File available at:", uploadResult);
            return uploadResult;
          } else {
            statusBar.textContent = `Lighting: 🟢 OK | Upload failed ❌ - try again`;
            return null;
          }
        } catch (error) {
          console.error('Upload error:', error);
          statusBar.textContent = `Upload failed ❌ - try again`;
          return null;
        }
      }

      // Proceed to next step
      function proceedToNextStep() {
        nextButton.disabled = false;
        retryButton.style.display = "none";
        
        if (currentStep === 0) {
          // After first step, update the step instruction to show vehicle info
          updateStep();
        }
      }

      // Trigger inspection completion
      async function triggerInspectionComplete() {
        const inspectionId = Date.now();
        const completionData = {
          inspectionId: inspectionId,
          vehicleInfo: vehicleInfo,
          completedAt: new Date().toISOString(),
          totalSteps: steps.length,
          uploadedFiles: uploadedVideoUrls,
          summary: {
            totalFiles: uploadedVideoUrls.length,
            totalSize:
              uploadedVideoUrls.reduce((sum, file) => {
                return sum + parseInt(file.fileSize.replace(" KB", ""));
              }, 0) + " KB",
            photoCount: uploadedVideoUrls.length,
            videoCount: 0,
          },
          readyForAIAnalysis: true,
          status: "inspection_complete",
          testMode: isTestMode,
        };

        try {
          const webhookUrl =
            "https://hamzaw.app.n8n.cloud/webhook-test/50903630-1eac-46a7-a041-6b5614e9f533";

          console.log("🚀 Triggering inspection completion webhook...");
          console.log("Completion data:", completionData);

          const response = await fetch(webhookUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(completionData),
          });

          if (response.ok) {
            const vehicleText = vehicleInfo.make ? 
              `${vehicleInfo.make} ${vehicleInfo.model} ${vehicleInfo.year}` : 
              "Vehicle";
            stepInstruction.textContent = `✅ ${vehicleText} inspection sent for AI analysis!`;
            statusBar.textContent = "Processing complete - AI analysis started! 🤖";
            console.log("✅ Webhook sent successfully to n8n!");
          } else {
            stepInstruction.textContent = `❌ Failed to trigger analysis. Please contact support.`;
            console.error("❌ Webhook failed:", response.status, response.statusText);
          }
        } catch (error) {
          console.error("Webhook trigger failed:", error);
          stepInstruction.textContent = `❌ Failed to trigger analysis. Please contact support.`;
        }
      }

      // Lighting check
      function checkLighting() {
        if (!inspectionStarted || video.readyState < 2) return;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth || 100;
        canvas.height = video.videoHeight || 100;

        if (video.videoWidth > 0) {
          ctx.drawImage(video, 0, 0);
          const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
          let total = 0;

          for (let i = 0; i < frame.data.length; i += 4) {
            const brightness =
              0.299 * frame.data[i] +
              0.587 * frame.data[i + 1] +
              0.114 * frame.data[i + 2];
            total += brightness;
          }

          const avg = total / (frame.data.length / 4);
          const lightOK = avg > 30 && avg < 200;

          if (!recordedBlob) {
            statusBar.textContent = `Lighting: ${
              lightOK ? "🟢 OK" : "🔴 Check"
            } | Ready for photo`;
          }
        } else {
          statusBar.textContent = "📷 Camera ready - Take photo";
        }
      }

      function loopStatus() {
        checkLighting();
        requestAnimationFrame(loopStatus);
      }

      // Event listeners
      photoButton.addEventListener("click", () => {
        if (isTestMode) {
          handleUpload();
        } else {
          capturePhoto();
        }
      });

      retryButton.addEventListener("click", () => {
        retryButton.style.display = "none";
        statusBar.textContent = "📸 Ready to take photo";
      });

      nextButton.addEventListener("click", async () => {
        if (currentStep < steps.length - 1) {
          currentStep++;
          updateStep();
        } else {
          const vehicleText = vehicleInfo.make ? 
            `${vehicleInfo.make} ${vehicleInfo.model} ${vehicleInfo.year}` : 
            "Vehicle";
          stepInstruction.textContent = `🎉 ${vehicleText} inspection completed! Processing...`;
          nextButton.style.display = "none";
          photoButton.style.display = "none";
          retryButton.style.display = "none";

          await triggerInspectionComplete();
        }
      });

      // Legacy function for test mode compatibility
      async function handleUpload() {
        if (isTestMode) {
          const uploadResult = testFolderPhotos[currentStep] || testFolderPhotos[0];
          
          uploadedVideoUrls.push({
            step: currentStep + 1,
            stepName: steps[currentStep],
            url: uploadResult,
            type: "photo",
            timestamp: new Date().toISOString(),
            fileSize: Math.floor(Math.random() * 150 + 100) + " KB",
          });

          nextButton.disabled = false;
          statusBar.textContent = `Lighting: 🟢 OK | Photo uploaded! ✅ (Test photo)`;
          console.log("Test file available at:", uploadResult);
        }
      }

      // Initialize app
      startCamera();
      loopStatus();
    </script>
    
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/dashboard.html";
            });
          }
        });
      }
    </script>
  </body>
</html>
                <label>Make:</label>
                <input type="text" id="vehicle-make" required>
              </div>
              <div class="form-group">
                <label>Model:</label>
                <input type="text" id="vehicle-model" required>
              </div>
              <div class="form-group">
                <label>Year:</label>
                <input type="number" id="vehicle-year" min="1990" max="2025" required>
              </div>
              <div class="form-group">
                <label>Color:</label>
                <input type="text" id="vehicle-color" required>
              </div>
              <div class="form-group">
                <label>License Plate:</label>
                <input type="text" id="vehicle-plate" required>
              </div>
              <div class="modal-buttons">
                <button type="submit" class="modal-button btn-primary">
                  Continue Inspection
                </button>
              </div>
            </form>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Handle form submission
        document.getElementById('manual-vehicle-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          detectedVehicle = {
            make: document.getElementById('vehicle-make').value,
            model: document.getElementById('vehicle-model').value,
            year: document.getElementById('vehicle-year').value,
            color: document.getElementById('vehicle-color').value,
            plate: document.getElementById('vehicle-plate').value,
            confidence: 1.0,
            condition: "Manual Entry",
            notes: "Entered manually by user"
          };
          
          vehicleInfo = detectedVehicle;
          hideModal();
          
          await uploadToR2();
          proceedToNextStep();
        });
      }

      // Show error modal
      function showErrorModal(message) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'error-modal';
        modal.innerHTML = `
          <div class="modal-content">
            <h3>❌ Error</h3>
            <p>${message}</p>
            <div class="modal-buttons">
              <button class="modal-button btn-primary" onclick="hideModal()">
                OK
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // Global modal functions
      window.confirmVehicle = async function(isCorrect) {
        hideModal();
        
        if (isCorrect) {
          vehicleInfo = detectedVehicle;
          await uploadToR2();
          proceedToNextStep();
        } else {
          showManualVehicleEntry("Please enter correct vehicle information:");
        }
      };

      window.editVehicleInfo = function() {
        hideModal();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content">
            <h3>Edit Vehicle Information</h3>
            <form id="edit-vehicle-form">
              <div class="form-group">
                <label>Make:</label>
                <input type="text" id="edit-make" value="${detectedVehicle.make}" required>
              </div>
              <div class="form-group">
                <label>Model:</label>
                <input type="text" id="edit-model" value="${detectedVehicle.model}" required>
              </div>
              <div class="form-group">
                <label>Year:</label>
                <input type="text" id="edit-year" value="${detectedVehicle.year}" required>
              </div>
              <div class="form-group">
                <label>Color:</label>
                <input type="text" id="edit-color" value="${detectedVehicle.color}" required>
              </div>
              <div class="form-group">
