<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Car Inspection - Enterprise Functions</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: black;
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }
      
      video {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
        background: #000;
      }
      
      /* Simple user selection */
      #user-selection-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000000;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        z-index: 100;
        padding: 2rem;
      }
      
      #user-selection-screen h1 {
        font-size: 2rem;
        margin-bottom: 2rem;
      }
      
      .user-buttons {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
        max-width: 400px;
      }
      
      .user-btn {
        padding: 1rem;
        background: #333;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.2s;
      }
      
      .user-btn:hover {
        background: #555;
      }
      
      /* Simple start screen */
      #start-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000000;
        color: white;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        z-index: 100;
        padding: 2rem;
      }
      
      #start-screen h1 {
        font-size: 2rem;
        margin-bottom: 2rem;
      }
      
      .btn {
        padding: 1rem 2rem;
        background: #444;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        margin: 0.5rem;
        transition: background 0.2s;
      }
      
      .btn:hover {
        background: #666;
      }
      
      /* Simple UI elements */
      #status-bar {
        position: fixed;
        top: 20px;
        left: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        z-index: 50;
        display: none;
      }
      
      #step-instruction {
        position: fixed;
        bottom: 140px;
        left: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        z-index: 50;
        display: none;
      }
      
      #photo-button,
      #next-button {
        position: fixed;
        bottom: 30px;
        padding: 1rem 2rem;
        font-size: 1.2rem;
        border-radius: 8px;
        border: none;
        color: white;
        cursor: pointer;
        z-index: 50;
        display: none;
        transition: background 0.2s;
      }
      
      #photo-button {
        left: 50%;
        transform: translateX(-50%);
        background: #007bff;
      }
      
      #photo-button:hover {
        background: #0056b3;
      }
      
      #next-button {
        right: 30px;
        background: #28a745;
      }
      
      #next-button:hover {
        background: #1e7e34;
      }
      
      #next-button:disabled {
        background: #666;
        cursor: not-allowed;
      }
      
      .flash-effect {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        z-index: 200;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.1s;
      }
      
      .flash-effect.active {
        opacity: 0.8;
      }
      
      /* Simple popup */
      .vehicle-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2rem;
        border-radius: 8px;
        z-index: 500;
        text-align: center;
        max-width: 400px;
        width: 90%;
        color: #333;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      }
      
      .popup-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
      }
      
      .popup-btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.2s;
      }
      
      .btn-yes {
        background: #28a745;
        color: white;
      }
      
      .btn-yes:hover {
        background: #1e7e34;
      }
      
      .btn-no {
        background: #dc3545;
        color: white;
      }
      
      .btn-no:hover {
        background: #c82333;
      }
      
      .manual-form {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        text-align: left;
      }
      
      .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      
      .form-row input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      
      .form-row label {
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
      }
      
      @media (max-width: 768px) {
        .form-row {
          flex-direction: column;
          gap: 0.5rem;
        }
        
        .popup-buttons {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <video id="video" autoplay muted playsinline></video>
    <div id="flash-effect" class="flash-effect"></div>

    <!-- User Selection Screen -->
    <div id="user-selection-screen">
      <h1>Select User Account</h1>
      <div class="user-buttons">
        <button id="user1-btn" class="user-btn" data-user="1">
          User 1 - Your Real Account (2016 Cadillac SRX - License: 1393)
        </button>
        <button id="user2-btn" class="user-btn" data-user="2">
          User 2 - Test Account (No vehicles)
        </button>
        <button id="user3-btn" class="user-btn" data-user="3">
          User 3 - Test Account (No vehicles)
        </button>
      </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen">
      <h1>Car Inspection - Enterprise Functions</h1>
      <p>Professional API: api.rentalshield.net | CDN: cdn.rentalshield.net</p>
      <button id="start-inspection-btn" class="btn">Start Inspection</button>
      <button id="test-mode-btn" class="btn">Test Mode</button>
      <button id="back-to-users-btn" class="btn">‚Üê Back to Users</button>
    </div>

    <!-- Status and Controls -->
    <div id="status-bar">Ready</div>
    <div id="step-instruction">Loading...</div>
    <button id="photo-button">Take Photo</button>
    <button id="next-button" disabled>Next Step</button>

    <script>
      console.log('üè¢ Enterprise Functions Starting with Professional API...');
      
      // FIXED: Professional API Configuration
      const API_ENDPOINTS = {
        getConfig: 'https://api.rentalshield.net/.netlify/functions/get-config',
        detectVehicle: 'https://api.rentalshield.net/.netlify/functions/gpt-vehicle-detect',
        uploadPhoto: 'https://api.rentalshield.net/.netlify/functions/upload-to-r2',
        vehicleHybrid: 'https://api.rentalshield.net/.netlify/functions/vehicle-hybrid'
      };
      
      // Fallback to direct Netlify URLs if API subdomain fails
      const FALLBACK_ENDPOINTS = {
        getConfig: '/.netlify/functions/get-config',
        detectVehicle: '/.netlify/functions/gpt-vehicle-detect',
        uploadPhoto: '/.netlify/functions/upload-to-r2',
        vehicleHybrid: '/.netlify/functions/vehicle-hybrid'
      };
      
      let useApiSubdomain = true;
      
      function getEndpoint(name) {
        return useApiSubdomain ? API_ENDPOINTS[name] : FALLBACK_ENDPOINTS[name];
      }
      
      // Test users
      const TEST_USERS = {
        1: { id: '11111111-1111-1111-1111-111111111111', email: 'user1@test.com', name: 'User 1' },
        2: { id: '22222222-2222-2222-2222-222222222222', email: 'user2@test.com', name: 'User 2' },
        3: { id: '33333333-3333-3333-3333-333333333333', email: 'user3@test.com', name: 'User 3' }
      };

      // Global variables
      let supabase = null;
      let currentUser = null;
      let currentStep = -1;
      let vehicleInfo = null;
      let detectedVehicle = null;
      let inspectionStarted = false;
      let uploadedFiles = [];
      let isTestMode = false;
      let currentVehicleId = null;
      let currentInspectionId = null;
      
      const steps = [
        { name: "front_bumper", category: "exterior" },
        { name: "driver_side_front_fender", category: "exterior" },
        { name: "driver_side_front_wheel", category: "exterior" },
        { name: "driver_side_doors", category: "exterior" },
        { name: "driver_side_rear_wheel", category: "exterior" },
        { name: "driver_side_rear_fender", category: "exterior" },
        { name: "rear_bumper", category: "exterior" },
        { name: "passenger_side_rear_fender", category: "exterior" },
        { name: "passenger_side_rear_wheel", category: "exterior" },
        { name: "passenger_side_doors", category: "exterior" },
        { name: "passenger_side_front_wheel", category: "exterior" },
        { name: "passenger_side_front_fender", category: "exterior" },
        { name: "front_windshield", category: "exterior" },
        { name: "interior_dashboard", category: "interior" },
        { name: "interior_front_seats", category: "interior" },
        { name: "interior_rear_seats", category: "interior" },
        { name: "odometer", category: "documents" },
        { name: "trunk_cargo_area", category: "cargo" }
      ];

      // Get elements
      const video = document.getElementById("video");
      const statusBar = document.getElementById("status-bar");
      const stepInstruction = document.getElementById("step-instruction");
      const nextButton = document.getElementById("next-button");
      const photoButton = document.getElementById("photo-button");
      const userSelectionScreen = document.getElementById("user-selection-screen");
      const startScreen = document.getElementById("start-screen");
      const flashEffect = document.getElementById("flash-effect");

      // Initialize Supabase with fallback
      async function initSupabase() {
        try {
          console.log('üîó Trying API subdomain...');
          const configResponse = await fetch(getEndpoint('getConfig'));
          
          if (!configResponse.ok) {
            throw new Error('API subdomain failed');
          }
          
          const config = await configResponse.json();
          supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
          console.log('‚úÖ Supabase initialized via API subdomain');
        } catch (error) {
          console.log('‚ö†Ô∏è API subdomain failed, trying fallback...');
          useApiSubdomain = false;
          
          try {
            const configResponse = await fetch(getEndpoint('getConfig'));
            const config = await configResponse.json();
            supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
            console.log('‚úÖ Supabase initialized via fallback');
          } catch (fallbackError) {
            console.error('‚ùå Both API endpoints failed:', fallbackError);
          }
        }
      }

      // Start camera
      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
            audio: false,
          });
          video.srcObject = stream;
          console.log("‚úÖ Camera started");
        } catch (e) {
          console.log("‚ùå Camera failed, using front camera");
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: "user" },
              audio: false,
            });
            video.srcObject = stream;
          } catch (e2) {
            console.log("‚ùå All cameras failed");
            video.style.display = 'none';
          }
        }
      }

      // Generate UUID
      function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      // Select user
      function selectUser(userNumber) {
        currentUser = TEST_USERS[userNumber];
        console.log('‚úÖ Selected:', currentUser.name, currentUser.email);
        userSelectionScreen.style.display = "none";
        startScreen.style.display = "flex";
      }

      // Back to users
      function backToUserSelection() {
        startScreen.style.display = "none";
        userSelectionScreen.style.display = "flex";
        currentUser = null;
        inspectionStarted = false;
        currentStep = -1;
        statusBar.style.display = "none";
        stepInstruction.style.display = "none";
        photoButton.style.display = "none";
        nextButton.style.display = "none";
      }

      // Check vehicle with hybrid system
      async function checkSpecificVehicle(detectedPlate) {
        try {
          console.log('üîç Checking vehicle for plate:', detectedPlate);
          
          const response = await fetch(getEndpoint('vehicleHybrid'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'find_vehicle',
              userId: currentUser.id,
              vehicleData: { license_plate: detectedPlate }
            })
          });
          
          const result = await response.json();
          
          if (result.found) {
            console.log('‚úÖ Found existing vehicle:', result.vehicle);
            return result.vehicle;
          } else {
            console.log('‚ùå No vehicle found for plate:', detectedPlate);
            return null;
          }
        } catch (error) {
          console.error('‚ùå Error checking vehicle:', error);
          return null;
        }
      }

      // Create inspection
      async function createInspection() {
        try {
          console.log('üìù Creating inspection...');
          
          const response = await fetch(getEndpoint('vehicleHybrid'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'create_inspection',
              userId: currentUser.id,
              vehicleData: { vehicle_id: currentVehicleId },
              inspectionData: {
                inspection_date: new Date().toISOString(),
                status: 'pending'
              }
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            currentInspectionId = result.inspectionId;
            console.log('‚úÖ Created inspection:', result.inspectionId);
          } else {
            currentInspectionId = generateUUID();
            console.log('‚ö†Ô∏è Using fallback inspection ID');
          }
        } catch (error) {
          console.error('‚ùå Error creating inspection:', error);
          currentInspectionId = generateUUID();
        }
      }

      // Start inspection
      async function startInspection() {
        console.log('üöÄ Starting inspection');
        isTestMode = false;
        inspectionStarted = true;
        
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        photoButton.style.display = "block";
        nextButton.style.display = "block";
        
        currentStep = -1;
        updateStep();
      }

      // Test mode
      async function startTestMode() {
        console.log('üß™ Starting test mode');
        isTestMode = true;
        inspectionStarted = true;
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        photoButton.style.display = "block";
        nextButton.style.display = "block";
        
        statusBar.textContent = "üß™ Test mode active";
        stepInstruction.textContent = "üß™ TEST MODE: Using sample data";

        detectedVehicle = {
          make: "Cadillac", model: "SRX", year: 2016,
          color: "Dark Blue Gray", license_plate: "TEST123"
        };
        vehicleInfo = detectedVehicle;
        currentVehicleId = generateUUID();
        currentInspectionId = generateUUID();
        
        // Skip license plate, go to first photo step
        currentStep = 0;
        updateStep();
      }

      // Update step
      function updateStep() {
        if (currentStep === -1) {
          stepInstruction.textContent = "Step 0: Take license plate photo";
          statusBar.textContent = "License plate detection ready";
        } else {
          const step = steps[currentStep];
          stepInstruction.textContent = `Step ${currentStep + 1}/18: ${step.name.replace(/_/g, ' ')} (${step.category})`;
          statusBar.textContent = "Ready for photo";
        }
        nextButton.disabled = true;
      }

      // License plate detection
      async function detectLicensePlate() {
        try {
          statusBar.textContent = "ü§ñ Analyzing with GPT-4o...";
          
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          
          const imageData = canvas.toDataURL('image/jpeg', 0.8);
          const base64 = imageData.split(',')[1];
          
          const response = await fetch(getEndpoint('detectVehicle'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              imageBase64: base64,
              userId: currentUser.id
            })
          });
          
          const result = await response.json();
          console.log('ü§ñ GPT result:', result);
          
          if (result.success && result.vehicle) {
            statusBar.textContent = "‚úÖ Vehicle detected - checking database...";
            
            const existingVehicle = await checkSpecificVehicle(result.vehicle.license_plate);
            
            if (existingVehicle) {
              console.log('üìã Found existing vehicle');
              result.vehicle.id = existingVehicle.id;
              result.vehicle.inspectionHistory = existingVehicle.inspectionHistory || [];
              result.vehicle.totalInspections = existingVehicle.inspectionHistory?.length || 0;
              result.vehicle.lastInspection = existingVehicle.inspectionHistory?.[0] || null;
              
              showVehicleHistoryConfirmation(result.vehicle);
            } else {
              console.log('üÜï New vehicle detected');
              result.vehicle.id = generateUUID();
              result.vehicle.inspectionHistory = [];
              result.vehicle.totalInspections = 0;
              
              showNewVehicleConfirmation(result.vehicle);
            }
          } else {
            console.log('‚ùå Detection failed, showing manual entry');
            statusBar.textContent = "Detection failed - manual entry";
            showSimpleVehicleEntry();
          }
          
        } catch (error) {
          console.error('‚ùå Detection error:', error);
          statusBar.textContent = "Detection failed - manual entry";
          showSimpleVehicleEntry();
        }
      }

      // Show vehicle confirmation popups
      function showVehicleHistoryConfirmation(vehicleData) {
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'vehicle-confirmation';
        
        let lastInspectionText = '';
        if (vehicleData.lastInspection) {
          const lastDate = new Date(vehicleData.lastInspection.inspection_date || vehicleData.lastInspection.timestamp).toLocaleDateString();
          lastInspectionText = `<p>Last inspection: ${lastDate}</p>`;
        }
        
        popup.innerHTML = `
          <h3>Found Existing Vehicle</h3>
          <p><strong>${vehicleData.make} ${vehicleData.model} ${vehicleData.year}</strong></p>
          <p>${vehicleData.color} ‚Ä¢ ${vehicleData.license_plate}</p>
          ${lastInspectionText}
          <p>${vehicleData.totalInspections} previous inspections</p>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="confirmVehicle(true)">Yes, correct</button>
            <button class="popup-btn btn-no" onclick="confirmVehicle(false)">No, different</button>
          </div>
        `;
        
        detectedVehicle = vehicleData;
        document.body.appendChild(popup);
      }

      function showNewVehicleConfirmation(vehicleData) {
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'vehicle-confirmation';
        
        popup.innerHTML = `
          <h3>New Vehicle Detected</h3>
          <p><strong>${vehicleData.make} ${vehicleData.model} ${vehicleData.year}</strong></p>
          <p>${vehicleData.color} ‚Ä¢ ${vehicleData.license_plate}</p>
          <p>First inspection for this vehicle</p>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="confirmVehicle(true)">Add vehicle</button>
            <button class="popup-btn btn-no" onclick="confirmVehicle(false)">Correct info</button>
          </div>
        `;
        
        detectedVehicle = vehicleData;
        document.body.appendChild(popup);
      }

      function showSimpleVehicleEntry() {
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'vehicle-entry';
        popup.innerHTML = `
          <h3>Enter Vehicle Details</h3>
          <div class="manual-form">
            <div class="form-row">
              <div><label>License Plate</label><input type="text" id="manual-plate" placeholder="1393"></div>
            </div>
            <div class="form-row">
              <div><label>Make</label><input type="text" id="manual-make" placeholder="Cadillac"></div>
              <div><label>Model</label><input type="text" id="manual-model" placeholder="SRX"></div>
            </div>
            <div class="form-row">
              <div><label>Year</label><input type="number" id="manual-year" placeholder="2016"></div>
              <div><label>Color</label><input type="text" id="manual-color" placeholder="Dark Blue Gray"></div>
            </div>
          </div>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="saveVehicleDetails()">Save</button>
          </div>
        `;
        
        document.body.appendChild(popup);
      }

      // Global popup functions
      window.confirmVehicle = async function(confirmed) {
        const popup = document.getElementById('vehicle-confirmation');
        if (popup) popup.remove();
        
        if (confirmed) {
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.id;
          
          await createInspection();
          
          const isNew = detectedVehicle.totalInspections === 0;
          statusBar.textContent = isNew ? 
            "‚úÖ New vehicle added" : 
            `‚úÖ Vehicle confirmed - inspection #${detectedVehicle.totalInspections + 1}`;
          
          currentStep = 0;
          updateStep();
          nextButton.disabled = false;
        } else {
          showSimpleVehicleEntry();
        }
      };

      window.saveVehicleDetails = async function() {
        const make = document.getElementById('manual-make').value.trim();
        const model = document.getElementById('manual-model').value.trim();
        const year = parseInt(document.getElementById('manual-year').value.trim());
        const color = document.getElementById('manual-color').value.trim();
        const license_plate = document.getElementById('manual-plate').value.trim();
        
        if (!make || !model || !year || !color || !license_plate) {
          alert('Please fill all fields');
          return;
        }
        
        const existingVehicle = await checkSpecificVehicle(license_plate);
        
        if (existingVehicle) {
          detectedVehicle = {
            make, model, year, color, license_plate,
            id: existingVehicle.id,
            inspectionHistory: existingVehicle.inspectionHistory || [],
            totalInspections: existingVehicle.inspectionHistory?.length || 0
          };
          statusBar.textContent = `‚úÖ Vehicle found - inspection #${detectedVehicle.totalInspections + 1}`;
        } else {
          detectedVehicle = { make, model, year, color, license_plate };
          detectedVehicle.id = generateUUID();
          detectedVehicle.inspectionHistory = [];
          detectedVehicle.totalInspections = 0;
          statusBar.textContent = "‚úÖ New vehicle created";
        }
        
        vehicleInfo = detectedVehicle;
        currentVehicleId = detectedVehicle.id;
        
        const popup = document.getElementById('vehicle-entry');
        if (popup) popup.remove();
        
        await createInspection();
        
        currentStep = 0;
        updateStep();
        nextButton.disabled = false;
      };

      // Upload to R2 with enterprise structure
      async function uploadToR2() {
        try {
          const step = steps[currentStep];
          statusBar.textContent = `üì§ Uploading ${step.category} photo...`;
          
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          
          canvas.toBlob(async (blob) => {
            if (!blob) {
              statusBar.textContent = "‚ùå Failed to capture photo";
              return;
            }
            
            const stepName = step.name;
            const stepNumber = currentStep + 1;
            const fileName = `step-${stepNumber.toString().padStart(2, '0')}_${stepName.replace(/_/g, '-')}.jpg`;
            
            console.log(`üì§ Uploading: Step ${stepNumber} (${Math.round(blob.size / 1024)} KB)`);

            try {
              const formData = new FormData();
              formData.append('file', blob, fileName);
              formData.append('fileName', fileName);
              formData.append('vehicleId', currentVehicleId);
              formData.append('inspectionId', currentInspectionId);
              formData.append('stepName', stepName);
              formData.append('stepNumber', stepNumber);
              formData.append('userId', currentUser.id);

              const response = await fetch(getEndpoint('uploadPhoto'), {
                method: 'POST',
                body: formData
              });

              if (response.ok) {
                const result = await response.json();
                
                const fileInfo = {
                  step: stepNumber,
                  stepName: stepName,
                  fileName: result.fileName,
                  url: result.url,
                  cloudflare_path: result.path,
                  subFolder: result.subFolder,
                  category: step.category,
                  type: "photo",
                  timestamp: new Date().toISOString(),
                  fileSize: Math.round(blob.size / 1024) + " KB",
                  vehicleId: currentVehicleId,
                  inspectionId: currentInspectionId
                };
                
                uploadedFiles.push(fileInfo);

                statusBar.textContent = `‚úÖ ${step.category} photo uploaded to CDN!`;
                nextButton.disabled = false;
                console.log('‚úÖ Upload successful:', result.path);
              } else {
                throw new Error(`Upload failed: ${response.status}`);
              }
            } catch (uploadError) {
              console.error('‚ùå Upload failed:', uploadError);
              statusBar.textContent = "‚ö†Ô∏è Upload failed - continuing";
              nextButton.disabled = false;
            }
          }, 'image/jpeg', 0.8);
          
        } catch (error) {
          console.error('‚ùå Upload error:', error);
          statusBar.textContent = "‚ö†Ô∏è Upload error - continuing";
          nextButton.disabled = false;
        }
      }

      // Capture photo
      function capturePhoto() {
        console.log('üì∏ Capturing photo for step:', currentStep === -1 ? 'license plate' : steps[currentStep].name);
        
        flashEffect.classList.add("active");
        setTimeout(() => flashEffect.classList.remove("active"), 100);

        if (currentStep === -1) {
          detectLicensePlate();
        } else {
          uploadToR2();
        }
      }

      // Next step
      function nextStep() {
        console.log('‚û°Ô∏è Next step...');
        if (currentStep < steps.length - 1) {
          currentStep++;
          updateStep();
        } else {
          stepInstruction.textContent = "üéâ Inspection completed!";
          nextButton.style.display = "none";
          photoButton.style.display = "none";
          statusBar.textContent = "‚úÖ All photos uploaded to enterprise CDN!";
          
          console.log('‚úÖ Inspection complete:', uploadedFiles.length, 'files uploaded');
          console.log('üìä Uploaded files:', uploadedFiles);
        }
      }

      // Event listeners with error handling
      function addEventListeners() {
        try {
          document.getElementById('user1-btn').addEventListener('click', (e) => {
            e.preventDefault();
            console.log('üë§ User 1 clicked');
            selectUser(1);
          });
          
          document.getElementById('user2-btn').addEventListener('click', (e) => {
            e.preventDefault();
            console.log('üë§ User 2 clicked');
            selectUser(2);
          });
          
          document.getElementById('user3-btn').addEventListener('click', (e) => {
            e.preventDefault();
            console.log('üë§ User 3 clicked');
            selectUser(3);
          });
          
          document.getElementById('start-inspection-btn').addEventListener("click", (e) => {
            e.preventDefault();
            console.log('üöÄ Start inspection clicked');
            startInspection();
          });
          
          document.getElementById('test-mode-btn').addEventListener("click", (e) => {
            e.preventDefault();
            console.log('üß™ Test mode clicked');
            startTestMode();
          });
          
          document.getElementById('back-to-users-btn').addEventListener("click", (e) => {
            e.preventDefault();
            console.log('‚¨ÖÔ∏è Back to users clicked');
            backToUserSelection();
          });
          
          document.getElementById('photo-button').addEventListener("click", (e) => {
            e.preventDefault();
            console.log('üì∏ Photo button clicked');
            capturePhoto();
          });
          
          document.getElementById('next-button').addEventListener("click", (e) => {
            e.preventDefault();
            console.log('‚û°Ô∏è Next button clicked');
            nextStep();
          });
          
          console.log('‚úÖ All event listeners attached');
        } catch (error) {
          console.error('‚ùå Error attaching event listeners:', error);
        }
      }

      // Initialize everything
      async function initializeApp() {
        console.log('üè¢ Initializing enterprise functions...');
        console.log('üîó API Endpoint:', useApiSubdomain ? 'api.rentalshield.net' : 'local functions');
        
        try {
          // Add event listeners first
          addEventListeners();
          
          // Initialize camera
          await startCamera();
          
          // Initialize Supabase with fallback
          await initSupabase();
          
          console.log('‚úÖ Enterprise functions ready!');
          console.log('üì± Ready for user selection');
          
        } catch (error) {
          console.error('‚ùå Setup failed:', error);
          console.log('‚ö†Ô∏è Running in limited mode');
          
          // Still try to start camera and add listeners
          addEventListeners();
          await startCamera();
        }
      }

      // Start the app when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }

    </script>
  </body>
</html>
