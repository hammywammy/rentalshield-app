<!DOCTYPE html>
<html lang="en">
  <head>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Car Inspection Recorder - Photo Only</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        background: black;
      }
      video {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 0;
      }
      #start-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        z-index: 15;
        padding: 2rem;
      }
      #start-screen h1 {
        font-size: 2rem;
        margin-bottom: 1rem;
      }
      #start-screen p {
        font-size: 1.2rem;
        margin-bottom: 2rem;
        opacity: 0.8;
        line-height: 1.4;
      }
      #start-inspection-btn, #test-mode-btn {
        padding: 1rem 2rem;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 1.2rem;
        cursor: pointer;
        margin: 0.5rem;
      }
      #test-mode-btn {
        background: #ff9800;
        font-size: 1rem;
      }
      #status-bar {
        position: fixed;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 1rem;
        font-size: 1.2rem;
        border-radius: 0.75rem;
        text-align: center;
        z-index: 10;
        user-select: none;
        display: none;
      }
      #step-instruction {
        position: fixed;
        bottom: 8rem;
        left: 1rem;
        right: 1rem;
        margin: 0 auto;
        background: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 1rem;
        border-radius: 0.75rem;
        font-size: 1.5rem;
        text-align: center;
        z-index: 10;
        line-height: 1.4;
        user-select: none;
        box-sizing: border-box;
        word-wrap: break-word;
        display: none;
      }
      #photo-button,
      #next-button {
        position: fixed;
        bottom: 1.5rem;
        padding: 0.8rem 1.6rem;
        font-size: 1.5rem;
        border-radius: 1rem;
        border: none;
        color: white;
        cursor: pointer;
        z-index: 10;
        user-select: none;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
        transition: background-color 0.3s, opacity 0.3s;
        display: none;
      }
      #photo-button {
        left: 50%;
        transform: translateX(-50%);
        background-color: #2196f3;
        font-size: 1.8rem;
        padding: 1rem 2rem;
      }
      #next-button {
        right: 1rem;
        background-color: #4caf50;
      }
      #next-button:disabled {
        background-color: #888;
        opacity: 0.5;
        cursor: not-allowed;
      }
      .flash-effect {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        z-index: 20;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.1s;
      }
      .flash-effect.active {
        opacity: 0.8;
      }
      
      /* Simple vehicle confirmation popup */
      .vehicle-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        z-index: 1000;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        max-width: 400px;
        width: 90%;
      }
      .vehicle-popup h3 {
        margin: 0 0 1rem 0;
        color: #333;
      }
      .vehicle-popup p {
        margin: 0.5rem 0;
        color: #666;
      }
      .popup-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
      }
      .popup-btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.2s;
      }
      .btn-yes {
        background: #4caf50;
        color: white;
      }
      .btn-no {
        background: #f44336;
        color: white;
      }
      .btn-yes:hover {
        background: #45a049;
      }
      .btn-no:hover {
        background: #da190b;
      }
      
      /* Manual vehicle form (only shows when needed) */
      .manual-form {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        text-align: left;
      }
      .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .form-row input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 0.25rem;
      }
      .form-row label {
        display: block;
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.25rem;
      }
    </style>
  </head>
  <body>
    <script>
      let currentUser = null;

      // Check authentication on page load
      netlifyIdentity.on('init', user => {
          if (!user) {
              window.location.href = '/auth.html';
              return;
          }
          
          currentUser = user;
          console.log('Authenticated user:', user);
          initializeApp();
      });

      function initializeApp() {
          startCamera();
          loopStatus();
      }

      netlifyIdentity.init();
    </script>
    
    <video id="video" autoplay muted playsinline></video>
    <div id="flash-effect" class="flash-effect"></div>

    <!-- Start Screen -->
    <div id="start-screen">
      <h1>üöó Car Inspection</h1>
      <p>Welcome to the vehicle inspection app.<br><br>
      <strong>Instructions:</strong><br>
      ‚Ä¢ First, take a clear photo of your license plate<br>
      ‚Ä¢ Then follow the 18-step inspection process<br>
      ‚Ä¢ Each photo will be automatically uploaded and analyzed</p>
      <button id="start-inspection-btn">Start Inspection</button>
      <button id="test-mode-btn">üß™ Test Mode</button>
    </div>

    <!-- Status and Controls -->
    <div id="status-bar">Lighting: ...</div>
    <div id="step-instruction">Loading...</div>
    <button id="photo-button">üì∏ Take Photo</button>
    <button id="next-button" disabled>Next Step</button>

    <script>
      const steps = [
        "Front bumper",
        "Driver side front fender", 
        "Driver side front wheel",
        "Driver side doors",
        "Driver side rear wheel",
        "Driver side rear fender",
        "Rear bumper",
        "Passenger side rear fender",
        "Passenger side rear wheel", 
        "Passenger side doors",
        "Passenger side front wheel",
        "Passenger side front fender",
        "Front windshield",
        "Interior: dashboard",
        "Interior: front seats",
        "Interior: rear seats",
        "Odometer",
        "Trunk/cargo area",
      ];

      const testFolderPhotos = [
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-bumper.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-left-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-left-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/left-side-doors.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-left-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-left-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-bumper.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-right-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-right-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/right-side-doors.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-right-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-right-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-windshield.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/dashboard.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-seats.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-seats.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/odometer.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/trunk.jpg",
      ];

      let currentStep = -1; // -1 = license plate step, 0-17 = inspection steps
      let recordedBlob = null;
      let vehicleInfo = null;
      let detectedVehicle = null;
      let inspectionStarted = false;
      let uploadedVideoUrls = [];
      let isTestMode = false;
      let userVehicles = []; // Store user's previous vehicles

      const video = document.getElementById("video");
      const statusBar = document.getElementById("status-bar");
      const stepInstruction = document.getElementById("step-instruction");
      const nextButton = document.getElementById("next-button");
      const photoButton = document.getElementById("photo-button");
      const startScreen = document.getElementById("start-screen");
      const startInspectionBtn = document.getElementById("start-inspection-btn");
      const testModeBtn = document.getElementById("test-mode-btn");
      const flashEffect = document.getElementById("flash-effect");

      // Start camera
      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280, max: 1280 },
              height: { ideal: 720, max: 720 },
              frameRate: { ideal: 30 },
            },
            audio: false,
          });
          video.srcObject = stream;
          console.log("Camera started successfully");
        } catch (e) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "environment",
                width: { ideal: 1024, max: 1024 },
                height: { ideal: 576, max: 576 },
                frameRate: { ideal: 30 },
              },
              audio: false,
            });
            video.srcObject = stream;
            console.log("Camera started with fallback settings");
          } catch (e2) {
            console.log("Camera not available:", e2);
            // Still allow test mode to work
          }
        }
      }

      // Load user's previous vehicles
      async function loadUserVehicles() {
        try {
          // Call your API to get user's previous vehicles
          const response = await fetch('/.netlify/functions/get-user-vehicles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentUser?.id })
          });
          
          if (response.ok) {
            const data = await response.json();
            userVehicles = data.vehicles || [];
          }
        } catch (error) {
          console.log("Couldn't load previous vehicles:", error);
          userVehicles = [];
        }
      }

      // Start inspection event listeners
      startInspectionBtn.addEventListener("click", async () => {
        isTestMode = false;
        await loadUserVehicles();
        startInspection();
      });

      testModeBtn.addEventListener("click", async () => {
        isTestMode = true;
        await autoSendTestPhotos();
      });

      // Start inspection
      function startInspection() {
        inspectionStarted = true;
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        photoButton.style.display = "block";
        nextButton.style.display = "block";
        
        currentStep = -1; // Start with license plate
        updateStep();
      }

      // Auto-send test photos
      async function autoSendTestPhotos() {
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        
        statusBar.textContent = "üß™ Creating test data...";
        stepInstruction.textContent = "üß™ TEST MODE: Auto-sending test folder photos...";

        // Create test vehicle data
        detectedVehicle = {
          make: "Toyota",
          model: "Camry", 
          year: "2023",
          color: "Silver",
          plate: "TEST123",
          confidence: 0.95
        };
        vehicleInfo = detectedVehicle;

        // Create test data
        uploadedVideoUrls = [];
        for (let i = 0; i < steps.length; i++) {
          uploadedVideoUrls.push({
            step: i + 1,
            stepName: steps[i],
            url: testFolderPhotos[i] || testFolderPhotos[0],
            type: "photo",
            timestamp: new Date().toISOString(),
            fileSize: Math.floor(Math.random() * 150 + 100) + " KB",
          });
        }

        await new Promise((resolve) => setTimeout(resolve, 1000));
        await triggerInspectionComplete();
      }

      // Update step display
      function updateStep() {
        if (currentStep === -1) {
          // License plate step
          stepInstruction.textContent = "üìã Step 0: Take a clear photo of your license plate";
          statusBar.textContent = "üì∏ License plate detection - Make sure plate is clearly visible";
        } else {
          // Regular inspection steps
          const vehicleText = detectedVehicle ? 
            `${detectedVehicle.make} ${detectedVehicle.model} ${detectedVehicle.year}` : 
            "Vehicle";
          stepInstruction.textContent = `${vehicleText} - Step ${currentStep + 1} of ${steps.length}: ${steps[currentStep]}`;
        }
        
        nextButton.disabled = true;
        recordedBlob = null;
      }

      // Capture photo
      async function capturePhoto() {
        try {
          // Flash effect
          flashEffect.classList.add("active");
          setTimeout(() => flashEffect.classList.remove("active"), 100);

          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          
          canvas.toBlob(async (blob) => {
            recordedBlob = blob;
            
            if (currentStep === -1) {
            statusBar.textContent = `Lighting: ${lightOK ? "üü¢ Good" : "üü° Check"} | License plate detection ready`;
          } else if (!recordedBlob) {
            statusBar.textContent = `Lighting: ${lightOK ? "üü¢ Good" : "üü° Check"} | Ready for photo`;
          }
        } else {
          if (currentStep === -1) {
            statusBar.textContent = "üì∑ License plate detection ready";
          } else {
            statusBar.textContent = "üì∑ Ready for photo";
          }
        }
      }

      function loopStatus() {
        checkLighting();
        requestAnimationFrame(loopStatus);
      }

      // Event listeners
      photoButton.addEventListener("click", () => {
        if (isTestMode) {
          handleTestUpload();
        } else {
          capturePhoto();
        }
      });

      nextButton.addEventListener("click", async () => {
        if (currentStep < steps.length - 1) {
          currentStep++;
          updateStep();
        } else {
          const vehicleText = vehicleInfo.make ? 
            `${vehicleInfo.make} ${vehicleInfo.model} ${vehicleInfo.year}` : 
            "Vehicle";
          stepInstruction.textContent = `üéâ ${vehicleText} inspection completed! Processing...`;
          nextButton.style.display = "none";
          photoButton.style.display = "none";

          await triggerInspectionComplete();
        }
      });

      // Test mode upload handler
      async function handleTestUpload() {
        const uploadResult = testFolderPhotos[Math.max(0, currentStep)] || testFolderPhotos[0];
        
        if (currentStep >= 0) {
          uploadedVideoUrls.push({
            step: currentStep + 1,
            stepName: steps[currentStep],
            url: uploadResult,
            type: "photo",
            timestamp: new Date().toISOString(),
            fileSize: Math.floor(Math.random() * 150 + 100) + " KB",
          });
        }

        statusBar.textContent = "‚úÖ Test photo uploaded";
        proceedToNextStep();
      }

      // Initialize app
      window.addEventListener('load', () => {
        startCamera();
        loopStatus();
      });
    </script>
    
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/dashboard.html";
            });
          }
        });
      }
    </script>
  </body>
</html> {
              // License plate detection
              await detectLicensePlate(blob);
            } else {
              // Regular inspection photo
              await uploadToR2();
              proceedToNextStep();
            }
          }, 'image/jpeg', 0.8);
          
        } catch (error) {
          console.error('Error capturing photo:', error);
          statusBar.textContent = "‚ùå Photo capture failed - try again";
        }
      }

      // Detect license plate and vehicle
      async function detectLicensePlate(photoBlob) {
        try {
          statusBar.textContent = "üîç Analyzing license plate...";
          
          const base64 = await blobToBase64(photoBlob);
          
          const response = await fetch('/.netlify/functions/detect-vehicle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              imageBase64: base64.split(',')[1],
              checkPlateOnly: true
            })
          });
          
          const result = await response.json();
          
          if (result.success && result.vehicle) {
            // Check if this matches a previous vehicle
            const matchingVehicle = userVehicles.find(v => 
              v.plate.toLowerCase() === result.vehicle.plate.toLowerCase()
            );
            
            if (matchingVehicle) {
              // Show confirmation for existing vehicle
              showVehicleConfirmation(matchingVehicle, true);
            } else {
              // Show confirmation for new vehicle with GPT prediction
              showVehicleConfirmation(result.vehicle, false);
            }
          } else {
            // No plate detected, show manual entry
            statusBar.textContent = "‚ö†Ô∏è No license plate detected - manual entry required";
            showManualVehicleEntry();
          }
          
        } catch (error) {
          console.error('License plate detection error:', error);
          statusBar.textContent = "‚ö†Ô∏è Detection failed - manual entry required";
          showManualVehicleEntry();
        }
      }

      // Show simple vehicle confirmation popup
      function showVehicleConfirmation(vehicleData, isExistingVehicle) {
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.innerHTML = `
          <h3>${isExistingVehicle ? 'üöó Is this your vehicle?' : 'üÜï New vehicle detected'}</h3>
          <p><strong>${vehicleData.make} ${vehicleData.model} ${vehicleData.year}</strong></p>
          <p>${vehicleData.color} ‚Ä¢ ${vehicleData.plate}</p>
          ${isExistingVehicle ? 
            '<p style="color: #666; font-size: 0.9rem;">Found in your previous inspections</p>' : 
            '<p style="color: #666; font-size: 0.9rem;">Auto-detected from license plate</p>'
          }
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="confirmVehicle(true)">‚úÖ Yes</button>
            <button class="popup-btn btn-no" onclick="confirmVehicle(false)">‚ùå No</button>
          </div>
        `;
        
        detectedVehicle = vehicleData;
        document.body.appendChild(popup);
      }

      // Show manual vehicle entry (only when detection fails)
      function showManualVehicleEntry() {
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.innerHTML = `
          <h3>üìù Enter Vehicle Details</h3>
          <div class="manual-form">
            <div class="form-row">
              <div>
                <label>Make</label>
                <input type="text" id="manual-make" placeholder="Toyota" required>
              </div>
              <div>
                <label>Model</label>
                <input type="text" id="manual-model" placeholder="Camry" required>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Year</label>
                <input type="number" id="manual-year" min="1990" max="2025" placeholder="2023" required>
              </div>
              <div>
                <label>Color</label>
                <input type="text" id="manual-color" placeholder="Silver" required>
              </div>
            </div>
            <div class="form-row">
              <div style="flex: 1;">
                <label>License Plate</label>
                <input type="text" id="manual-plate" placeholder="ABC123" required>
              </div>
            </div>
          </div>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="saveManualVehicle()">üíæ Save & Continue</button>
          </div>
        `;
        
        document.body.appendChild(popup);
      }

      // Global functions for popup interactions
      window.confirmVehicle = async function(confirmed) {
        const popup = document.querySelector('.vehicle-popup');
        if (popup) popup.remove();
        
        if (confirmed) {
          vehicleInfo = detectedVehicle;
          statusBar.textContent = "‚úÖ Vehicle confirmed - ready for inspection";
          
          // Upload license plate photo
          await uploadToR2();
          
          // Move to first inspection step
          currentStep = 0;
          updateStep();
          proceedToNextStep();
        } else {
          // Show manual entry
          showManualVehicleEntry();
        }
      };

      window.saveManualVehicle = async function() {
        const make = document.getElementById('manual-make').value.trim();
        const model = document.getElementById('manual-model').value.trim();
        const year = document.getElementById('manual-year').value.trim();
        const color = document.getElementById('manual-color').value.trim();
        const plate = document.getElementById('manual-plate').value.trim();
        
        if (!make || !model || !year || !color || !plate) {
          alert('Please fill in all fields');
          return;
        }
        
        detectedVehicle = { make, model, year, color, plate, confidence: 1.0 };
        vehicleInfo = detectedVehicle;
        
        const popup = document.querySelector('.vehicle-popup');
        if (popup) popup.remove();
        
        statusBar.textContent = "‚úÖ Vehicle details saved - ready for inspection";
        
        // Upload license plate photo
        await uploadToR2();
        
        // Move to first inspection step
        currentStep = 0;
        updateStep();
        proceedToNextStep();
      };

      // Helper function
      function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      // Upload to R2
      async function uploadToR2() {
        try {
          if (!recordedBlob && !isTestMode) {
            console.error('No recorded blob available');
            return;
          }

          statusBar.textContent = "üì§ Uploading photo...";

          let uploadResult;

          if (isTestMode) {
            uploadResult = testFolderPhotos[Math.max(0, currentStep)] || testFolderPhotos[0];
            await new Promise((resolve) => setTimeout(resolve, 300));
          } else {
            // Create file path
            let fileName;
            if (detectedVehicle) {
              const vehicleId = `${detectedVehicle.make}_${detectedVehicle.model}_${detectedVehicle.year}_${detectedVehicle.plate}`.replace(/[^a-zA-Z0-9]/g, '_');
              const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
              const userId = currentUser?.id || 'anonymous';
              
              if (currentStep === -1) {
                fileName = `${userId}/${vehicleId}/${timestamp}/license-plate.jpg`;
              } else {
                fileName = `${userId}/${vehicleId}/${timestamp}/step-${currentStep + 1}-${steps[currentStep].replace(/\s+/g, '-').toLowerCase()}.jpg`;
              }
            } else {
              fileName = `inspection-${Date.now()}-step-${currentStep === -1 ? 'plate' : currentStep + 1}.jpg`;
            }

            // Your R2 upload logic here
            uploadResult = `https://your-r2-bucket.com/${fileName}`;
            console.log('Would upload to:', fileName);
          }

          if (uploadResult) {
            if (currentStep >= 0) {
              // Only add to inspection list for actual inspection steps
              uploadedVideoUrls.push({
                step: currentStep + 1,
                stepName: steps[currentStep],
                url: uploadResult,
                type: "photo",
                timestamp: new Date().toISOString(),
                fileSize: isTestMode
                  ? Math.floor(Math.random() * 150 + 100) + " KB"
                  : Math.round(recordedBlob.size / 1024) + " KB",
              });
            }

            statusBar.textContent = "‚úÖ Photo uploaded successfully";
            return uploadResult;
          } else {
            statusBar.textContent = "‚ùå Upload failed - try again";
            return null;
          }
        } catch (error) {
          console.error('Upload error:', error);
          statusBar.textContent = "‚ùå Upload failed - try again";
          return null;
        }
      }

      // Proceed to next step
      function proceedToNextStep() {
        nextButton.disabled = false;
      }

      // Trigger inspection completion
      async function triggerInspectionComplete() {
        const inspectionId = Date.now();
        const completionData = {
          inspectionId: inspectionId,
          vehicleInfo: vehicleInfo,
          completedAt: new Date().toISOString(),
          totalSteps: steps.length,
          uploadedFiles: uploadedVideoUrls,
          summary: {
            totalFiles: uploadedVideoUrls.length,
            totalSize: uploadedVideoUrls.reduce((sum, file) => {
              return sum + parseInt(file.fileSize.replace(" KB", ""));
            }, 0) + " KB",
            photoCount: uploadedVideoUrls.length,
            videoCount: 0,
          },
          readyForAIAnalysis: true,
          status: "inspection_complete",
          testMode: isTestMode,
        };

        try {
          const webhookUrl = "https://hamzaw.app.n8n.cloud/webhook-test/50903630-1eac-46a7-a041-6b5614e9f533";

          const response = await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(completionData),
          });

          if (response.ok) {
            const vehicleText = vehicleInfo.make ? 
              `${vehicleInfo.make} ${vehicleInfo.model} ${vehicleInfo.year}` : 
              "Vehicle";
            stepInstruction.textContent = `‚úÖ ${vehicleText} inspection sent for AI analysis!`;
            statusBar.textContent = "Processing complete - AI analysis started! ü§ñ";
            console.log("‚úÖ Webhook sent successfully!");
          } else {
            stepInstruction.textContent = "‚ùå Failed to trigger analysis. Please contact support.";
            console.error("‚ùå Webhook failed:", response.status);
          }
        } catch (error) {
          console.error("Webhook trigger failed:", error);
          stepInstruction.textContent = "‚ùå Failed to trigger analysis. Please contact support.";
        }
      }

      // Lighting check
      function checkLighting() {
        if (!inspectionStarted || video.readyState < 2) return;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth || 100;
        canvas.height = video.videoHeight || 100;

        if (video.videoWidth > 0) {
          ctx.drawImage(video, 0, 0);
          const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
          let total = 0;

          for (let i = 0; i < frame.data.length; i += 4) {
            const brightness =
              0.299 * frame.data[i] +
              0.587 * frame.data[i + 1] +
              0.114 * frame.data[i + 2];
            total += brightness;
          }

          const avg = total / (frame.data.length / 4);
          const lightOK = avg > 30 && avg < 200;

          if (currentStep === -1)
