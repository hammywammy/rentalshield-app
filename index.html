<!DOCTYPE html>
<html lang="en">
  <head>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Car Inspection Recorder</title>
    <style>
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: black;
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }
      
      video {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 0;
        background: #000;
      }
      
      #start-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        z-index: 15;
        padding: 2rem;
      }
      
      #start-screen h1 {
        font-size: clamp(1.5rem, 5vw, 2.5rem);
        margin-bottom: 1rem;
        font-weight: 600;
      }
      
      #start-screen p {
        font-size: clamp(1rem, 3vw, 1.2rem);
        margin-bottom: 2rem;
        opacity: 0.9;
        line-height: 1.5;
        max-width: 500px;
      }
      
      .btn {
        padding: 1rem 2rem;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: clamp(1rem, 4vw, 1.2rem);
        font-weight: 600;
        cursor: pointer;
        margin: 0.5rem;
        transition: all 0.2s;
        min-height: 48px;
        min-width: 120px;
        touch-action: manipulation;
      }
      
      .btn:active {
        transform: scale(0.95);
        background: #45a049;
      }
      
      .btn-test {
        background: #ff9800;
        font-size: clamp(0.9rem, 3.5vw, 1rem);
      }
      
      .btn-test:active {
        background: #e68900;
      }
      
      #status-bar {
        position: fixed;
        top: env(safe-area-inset-top, 1rem);
        left: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 1rem;
        font-size: clamp(1rem, 3.5vw, 1.2rem);
        border-radius: 12px;
        text-align: center;
        z-index: 10;
        user-select: none;
        display: none;
        backdrop-filter: blur(10px);
      }
      
      #step-instruction {
        position: fixed;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 120px);
        left: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        font-size: clamp(1.2rem, 4vw, 1.5rem);
        text-align: center;
        z-index: 10;
        line-height: 1.4;
        user-select: none;
        word-wrap: break-word;
        display: none;
        backdrop-filter: blur(10px);
        font-weight: 500;
      }
      
      #photo-button,
      #next-button {
        position: fixed;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 20px);
        padding: 1rem 2rem;
        font-size: clamp(1.2rem, 4vw, 1.5rem);
        font-weight: 600;
        border-radius: 50px;
        border: none;
        color: white;
        cursor: pointer;
        z-index: 10;
        user-select: none;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        transition: all 0.2s;
        display: none;
        min-height: 60px;
        touch-action: manipulation;
      }
      
      #photo-button {
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(45deg, #2196f3, #1976d2);
        font-size: clamp(1.3rem, 4.5vw, 1.8rem);
        padding: 1.2rem 2.5rem;
        min-width: 160px;
      }
      
      #photo-button:active {
        transform: translateX(-50%) scale(0.95);
        background: linear-gradient(45deg, #1976d2, #1565c0);
      }
      
      #next-button {
        right: 1rem;
        background: linear-gradient(45deg, #4caf50, #388e3c);
        min-width: 120px;
      }
      
      #next-button:active {
        transform: scale(0.95);
        background: linear-gradient(45deg, #388e3c, #2e7d32);
      }
      
      #next-button:disabled {
        background: #666;
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .flash-effect {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        z-index: 20;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.1s;
      }
      
      .flash-effect.active {
        opacity: 0.9;
      }
      
      /* Mobile-optimized popup */
      .vehicle-popup {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }
      
      .vehicle-popup-content {
        background: white;
        padding: 2rem;
        border-radius: 16px;
        text-align: center;
        max-width: 400px;
        width: 100%;
        color: #333;
        max-height: 80vh;
        overflow-y: auto;
      }
      
      .vehicle-popup h3 {
        margin: 0 0 1rem 0;
        color: #333;
        font-size: clamp(1.3rem, 5vw, 1.5rem);
        font-weight: 600;
      }
      
      .vehicle-popup p {
        margin: 0.5rem 0;
        color: #666;
        font-size: clamp(1rem, 4vw, 1.1rem);
        line-height: 1.4;
      }
      
      .vehicle-popup strong {
        color: #333;
        font-size: clamp(1.1rem, 4.5vw, 1.2rem);
      }
      
      .popup-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
        flex-wrap: wrap;
      }
      
      .popup-btn {
        padding: 1rem 1.5rem;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: clamp(1rem, 4vw, 1.1rem);
        font-weight: 600;
        transition: all 0.2s;
        min-height: 48px;
        min-width: 100px;
        touch-action: manipulation;
      }
      
      .popup-btn:active {
        transform: scale(0.95);
      }
      
      .btn-yes {
        background: #4caf50;
        color: white;
      }
      
      .btn-no {
        background: #f44336;
        color: white;
      }
      
      .btn-yes:active {
        background: #45a049;
      }
      
      .btn-no:active {
        background: #da190b;
      }
      
      /* Manual vehicle form - mobile optimized */
      .manual-form {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1rem 0;
        text-align: left;
      }
      
      .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }
      
      .form-row > div {
        flex: 1;
        min-width: 120px;
      }
      
      .form-row input {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: clamp(1rem, 4vw, 1.1rem);
        transition: border-color 0.2s;
      }
      
      .form-row input:focus {
        outline: none;
        border-color: #4caf50;
      }
      
      .form-row label {
        display: block;
        font-size: clamp(0.9rem, 3.5vw, 1rem);
        color: #666;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }
      
      /* Loading states */
      .loading {
        opacity: 0.7;
        pointer-events: none;
      }
      
      @media (max-width: 480px) {
        .form-row {
          flex-direction: column;
          gap: 0.5rem;
        }
        
        .popup-buttons {
          flex-direction: column;
          align-items: stretch;
        }
        
        .popup-btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <video id="video" autoplay muted playsinline></video>
    <div id="flash-effect" class="flash-effect"></div>

    <!-- Start Screen -->
    <div id="start-screen">
      <h1>🚗 Car Inspection</h1>
      <p>Welcome to the vehicle inspection app.<br><br>
      <strong>Instructions:</strong><br>
      • First, take a clear photo of your license plate<br>
      • Then follow the 18-step inspection process<br>
      • Each photo will be automatically uploaded and analyzed</p>
      <button id="start-inspection-btn" class="btn">Start Inspection</button>
      <button id="test-mode-btn" class="btn btn-test">🧪 Test Mode</button>
    </div>

    <!-- Status and Controls -->
    <div id="status-bar">Ready to start...</div>
    <div id="step-instruction">Loading...</div>
    <button id="photo-button">📸 Take Photo</button>
    <button id="next-button" disabled>Next Step</button>

    <script>
      console.log('🚀 Car Inspection App Starting...');
      console.log('📱 User Agent:', navigator.userAgent);
      console.log('🌐 URL:', window.location.href);
      
      // Mobile detection
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      console.log('📱 Device Type:', { isMobile, isTouchDevice });
      
      // MOBILE-FIRST AUTHENTICATION
      let currentUser = null;
      let authInitialized = false;
      let authCheckComplete = false;
      let loginInProgress = false;
      
      // Check for auth callback parameters
      const urlParams = new URLSearchParams(window.location.search);
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const hasAuthToken = urlParams.has('access_token') || 
                          hashParams.has('access_token') || 
                          urlParams.has('confirmation_token') ||
                          window.location.href.includes('#access_token');
      
      console.log('🔐 Auth callback detected:', hasAuthToken);
      
      if (hasAuthToken) {
        console.log('⏳ Auth callback in URL - preventing immediate redirects');
        loginInProgress = true;
      }
      
      // Initialize Netlify Identity
      if (window.netlifyIdentity) {
        console.log('🔐 Initializing Netlify Identity...');
        
        // CRITICAL: Handle login event FIRST
        netlifyIdentity.on('login', (user) => {
          console.log('✅ LOGIN EVENT FIRED:', user.email);
          currentUser = user;
          loginInProgress = false;
          authCheckComplete = true;
          
          // Clean URL
          if (hasAuthToken) {
            console.log('🧹 Cleaning auth parameters from URL');
            const cleanUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
          }
          
          console.log('🎉 Login successful - user can use app');
        });
        
        // Handle logout
        netlifyIdentity.on('logout', () => {
          console.log('🚪 Logout event');
          currentUser = null;
          authCheckComplete = false;
          loginInProgress = false;
          window.location.href = '/auth.html';
        });
        
        // Handle initialization
        netlifyIdentity.on('init', (user) => {
          console.log('🔐 Identity initialized with user:', user ? user.email : 'none');
          authInitialized = true;
          
          if (user) {
            console.log('✅ User already logged in from init');
            currentUser = user;
            authCheckComplete = true;
          } else if (!hasAuthToken && !loginInProgress) {
            console.log('❌ No user and no auth token - need to redirect');
            startAuthCheck();
          } else {
            console.log('⏳ Auth callback or login in progress - waiting...');
            startAuthCheck();
          }
        });
        
        // Enhanced error handling
        netlifyIdentity.on('error', (err) => {
          console.error('🚨 Netlify Identity Error:', err);
          loginInProgress = false;
        });
        
        // Mobile-specific events
        netlifyIdentity.on('open', () => {
          console.log('📱 Login popup opened');
          loginInProgress = true;
        });
        
        netlifyIdentity.on('close', () => {
          console.log('📱 Login popup closed');
          setTimeout(() => {
            if (!currentUser && !loginInProgress) {
              const user = netlifyIdentity.currentUser();
              if (user) {
                console.log('✅ User found after popup close');
                currentUser = user;
                authCheckComplete = true;
              }
            }
          }, 1000);
        });
        
        // Initialize
        netlifyIdentity.init();
        
      } else {
        console.log('❌ Netlify Identity not available');
        currentUser = { id: 'test-user', email: 'test@example.com' };
        authCheckComplete = true;
      }
      
      // Auth checking with mobile-optimized timing
      function startAuthCheck() {
        if (authCheckComplete) {
          console.log('✅ Auth already complete');
          return;
        }
        
        const baseDelay = isMobile ? 3000 : 2000;
        const authDelay = hasAuthToken ? baseDelay * 2 : baseDelay;
        
        console.log(`⏰ Starting auth check in ${authDelay}ms...`);
        
        setTimeout(() => {
          performAuthCheck();
        }, authDelay);
      }
      
      function performAuthCheck() {
        if (authCheckComplete || currentUser) {
          console.log('✅ Auth complete or user found - skipping check');
          return;
        }
        
        console.log('🔍 Performing auth check...');
        const user = netlifyIdentity.currentUser();
        
        if (user) {
          console.log('✅ User found in auth check:', user.email);
          currentUser = user;
          authCheckComplete = true;
        } else if (hasAuthToken && !authCheckComplete) {
          console.log('⏳ Auth token present but no user yet - waiting longer...');
          setTimeout(() => {
            const retryUser = netlifyIdentity.currentUser();
            if (retryUser) {
              console.log('✅ User found on retry:', retryUser.email);
              currentUser = retryUser;
              authCheckComplete = true;
            } else {
              console.log('❌ Auth token failed to resolve - redirecting');
              redirectToAuth();
            }
          }, 3000);
        } else {
          console.log('❌ No user found - redirecting to auth');
          redirectToAuth();
        }
      }
      
      function redirectToAuth() {
        if (!authCheckComplete && !currentUser && !loginInProgress) {
          console.log('🔄 Redirecting to auth page...');
          window.location.href = '/auth.html';
        }
      }
      
      // App variables
      const steps = [
        "Front bumper", "Driver side front fender", "Driver side front wheel",
        "Driver side doors", "Driver side rear wheel", "Driver side rear fender",
        "Rear bumper", "Passenger side rear fender", "Passenger side rear wheel", 
        "Passenger side doors", "Passenger side front wheel", "Passenger side front fender",
        "Front windshield", "Interior: dashboard", "Interior: front seats",
        "Interior: rear seats", "Odometer", "Trunk/cargo area"
      ];

      const testFolderPhotos = [
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-bumper.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-left-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-left-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/left-side-doors.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-left-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-left-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-bumper.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-right-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-right-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/right-side-doors.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-right-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-right-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-windshield.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/dashboard.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-seats.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-seats.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/odometer.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/trunk.jpg"
      ];

      let currentStep = -1;
      let recordedBlob = null;
      let vehicleInfo = null;
      let detectedVehicle = null;
      let inspectionStarted = false;
      let uploadedVideoUrls = [];
      let isTestMode = false;
      let userVehicles = [];
      let currentVehicleId = null;

      // Get DOM elements
      const video = document.getElementById("video");
      const statusBar = document.getElementById("status-bar");
      const stepInstruction = document.getElementById("step-instruction");
      const nextButton = document.getElementById("next-button");
      const photoButton = document.getElementById("photo-button");
      const startScreen = document.getElementById("start-screen");
      const startInspectionBtn = document.getElementById("start-inspection-btn");
      const testModeBtn = document.getElementById("test-mode-btn");
      const flashEffect = document.getElementById("flash-effect");

      console.log('🎛️ DOM elements loaded:', {
        video: !!video,
        startInspectionBtn: !!startInspectionBtn,
        testModeBtn: !!testModeBtn,
        photoButton: !!photoButton,
        nextButton: !!nextButton
      });

      // Mobile-optimized camera
      async function startCamera() {
        try {
          console.log('📹 Requesting camera access...');
          
          const constraints = {
            video: {
              facingMode: "environment",
              width: { ideal: isMobile ? 1280 : 1920, max: 1920 },
              height: { ideal: isMobile ? 720 : 1080, max: 1080 },
              frameRate: { ideal: 30 }
            },
            audio: false
          };
          
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;
          
          video.onloadedmetadata = () => {
            console.log('📹 Camera ready:', video.videoWidth + 'x' + video.videoHeight);
          };
          
          console.log('✅ Camera started successfully');
          
        } catch (error) {
          console.error('❌ Camera error:', error);
          
          // Try fallback constraints
          try {
            console.log('📹 Trying fallback camera settings...');
            const fallbackStream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: "environment" },
              audio: false
            });
            video.srcObject = fallbackStream;
            console.log('✅ Camera started with fallback');
          } catch (fallbackError) {
            console.error('❌ Camera fallback failed:', fallbackError);
            statusBar.textContent = "📷 Camera access required - please enable in browser settings";
            statusBar.style.display = "block";
          }
        }
      }

      // Vehicle UUID generation
      function generateVehicleUUID() {
        return `veh-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      }

      function findUserVehicle(vehicleData) {
        return userVehicles.find(v => 
          v.plate.toLowerCase() === vehicleData.plate.toLowerCase() &&
          v.make.toLowerCase() === vehicleData.make.toLowerCase() &&
          v.model.toLowerCase() === vehicleData.model.toLowerCase()
        );
      }

      function generateInspectionId() {
        const date = new Date().toISOString().split('T')[0];
        const time = Date.now();
        return `inspection-${date}-${time}`;
      }

      // Load user vehicles
      async function loadUserVehicles() {
        try {
          if (!currentUser) {
            console.log('❌ No user for vehicle loading');
            userVehicles = [];
            return;
          }
          
          console.log('📂 Loading user vehicles...');
          const response = await fetch('/.netlify/functions/get-user-vehicles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              userId: currentUser.id,
              vehiclesPath: `rental-shield/users/${currentUser.id}/vehicles/`
            })
          });
          
          if (response.ok) {
            const data = await response.json();
            userVehicles = data.vehicles || [];
            console.log('✅ Loaded vehicles:', userVehicles.length);
          }
        } catch (error) {
          console.log("⚠️ Couldn't load user vehicles:", error);
          userVehicles = [];
        }
      }

      // Ensure user folder exists
      async function ensureUserFolder() {
        try {
          if (!currentUser?.id) return;

          console.log('📁 Ensuring user folder exists...');
          
          const response = await fetch('/.netlify/functions/create-user-folder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: currentUser.id,
              userEmail: currentUser.email,
              folderPath: `rental-shield/users/${currentUser.id}/`,
              createSubfolders: ['vehicles', 'profile']
            })
          });

          if (response.ok) {
            console.log('✅ User folder ready');
          }
        } catch (error) {
          console.error('⚠️ User folder creation failed:', error);
        }
      }

      // Ensure vehicle folder exists
      async function ensureVehicleFolder() {
        try {
          if (!currentUser || !currentVehicleId || !vehicleInfo) return;

          console.log('🚗 Creating vehicle folder...');
          
          const response = await fetch('/.netlify/functions/create-vehicle-folder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: currentUser.id,
              vehicleUUID: currentVehicleId,
              vehicleData: vehicleInfo,
              folderPath: `rental-shield/users/${currentUser.id}/vehicles/${currentVehicleId}/`,
              createSubfolders: ['inspections']
            })
          });

          if (response.ok) {
            console.log('✅ Vehicle folder ready');
          }
        } catch (error) {
          console.error('⚠️ Vehicle folder creation failed:', error);
        }
      }

      // Start inspection
      async function startInspection() {
        console.log('🚀 Starting inspection...');
        isTestMode = false;
        inspectionStarted = true;
        
        await loadUserVehicles();
        await ensureUserFolder();
        
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        photoButton.style.display = "block";
        nextButton.style.display = "block";
        
        currentStep = -1;
        updateStep();
      }

      // Test mode
      async function startTestMode() {
        console.log('🧪 Starting test mode...');
        isTestMode = true;
        inspectionStarted = true;
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        
        statusBar.textContent = "🧪 Creating test data...";
        stepInstruction.textContent = "🧪 TEST MODE: Auto-sending test photos...";

        detectedVehicle = {
          make: "Toyota", model: "Camry", year: "2023",
          color: "Silver", plate: "TEST123", confidence: 0.95
        };
        vehicleInfo = detectedVehicle;
        currentVehicleId = "veh-test123";

        uploadedVideoUrls = [];
        const testInspectionId = generateInspectionId();
        
        for (let i = 0; i < steps.length; i++) {
          uploadedVideoUrls.push({
            step: i + 1, stepName: steps[i],
            url: testFolderPhotos[i] || testFolderPhotos[0],
            type: "photo", timestamp: new Date().toISOString(),
            fileSize: Math.floor(Math.random() * 150 + 100) + " KB",
            vehicleId: currentVehicleId, inspectionId: testInspectionId,
            filePath: `rental-shield/users/test-user/vehicles/${currentVehicleId}/inspections/${testInspectionId}/step-${i + 1}.jpg`
          });
        }

        await new Promise(resolve => setTimeout(resolve, 1000));
        await triggerInspectionComplete();
      }

      // Update step display
      function updateStep() {
        if (currentStep === -1) {
          stepInstruction.textContent = "📋 Step 0: Take a clear photo of your license plate";
          statusBar.textContent = "📸 License plate detection - Make sure plate is clearly visible";
        } else {
      // Update step display
      function updateStep() {
        if (currentStep === -1) {
          stepInstruction.textContent = "📋 Step 0: Take a clear photo of your license plate";
          statusBar.textContent = "📸 License plate detection - Make sure plate is clearly visible";
        } else {
          const vehicleText = detectedVehicle ? 
            `${detectedVehicle.make} ${detectedVehicle.model} ${detectedVehicle.year}` : 
            "Vehicle";
          stepInstruction.textContent = `${vehicleText} - Step ${currentStep + 1} of ${steps.length}: ${steps[currentStep]}`;
          statusBar.textContent = "📸 Ready to take photo";
        }
        
        nextButton.disabled = true;
        recordedBlob = null;
      }

      // Capture photo
      function capturePhoto() {
        console.log('📸 Capturing photo...');
        
        flashEffect.classList.add("active");
        setTimeout(() => flashEffect.classList.remove("active"), 150);

        if (currentStep === -1) {
          detectLicensePlate();
        } else {
          uploadToR2();
        }
      }

      // License plate detection
      async function detectLicensePlate() {
        try {
          statusBar.textContent = "🔍 Analyzing license plate...";
          
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          
          const imageData = canvas.toDataURL('image/jpeg', 0.8);
          const base64 = imageData.split(',')[1];
          
          console.log('🤖 Calling vehicle detection API...');
          
          const response = await fetch('/.netlify/functions/detect-vehicle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              imageBase64: base64,
              checkPlateOnly: true,
              userId: currentUser?.id,
              vehiclesPath: `rental-shield/users/${currentUser?.id || 'anonymous'}/vehicles/`
            })
          });
          
          const result = await response.json();
          console.log('🤖 Detection result:', result);
          
          if (result.success && result.vehicle && result.vehicle.plate) {
            statusBar.textContent = "✅ Vehicle detected - confirming details...";
            
            const existingVehicle = findUserVehicle(result.vehicle);
            
            if (existingVehicle) {
              result.vehicle.vehicleUUID = existingVehicle.vehicleUUID;
              result.vehicle.inspectionHistory = existingVehicle.inspectionHistory || [];
              showVehicleConfirmation(result.vehicle, true);
            } else {
              result.vehicle.vehicleUUID = generateVehicleUUID();
              result.vehicle.inspectionHistory = [];
              showVehicleConfirmation(result.vehicle, false);
            }
          } else {
            console.log('❌ No clear vehicle detection');
            statusBar.textContent = "⚠️ Could not detect vehicle details - manual entry required";
            
            setTimeout(() => {
              showManualVehicleEntry();
            }, 1500);
          }
          
        } catch (error) {
          console.error('❌ License plate detection error:', error);
          statusBar.textContent = "⚠️ Detection failed - manual entry required";
          
          setTimeout(() => {
            showManualVehicleEntry();
          }, 1500);
        }
      }

      // Show vehicle confirmation popup
      function showVehicleConfirmation(vehicleData, isExistingInFleet) {
        console.log('🚗 Showing vehicle confirmation:', vehicleData);
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'vehicle-confirmation';
        
        let historyText = '';
        if (isExistingInFleet && vehicleData.inspectionHistory && vehicleData.inspectionHistory.length > 0) {
          const lastInspection = vehicleData.inspectionHistory[vehicleData.inspectionHistory.length - 1];
          const inspectionDate = new Date(lastInspection.date).toLocaleDateString();
          historyText = `<p style="color: #666; font-size: 0.9rem;">Last inspection: ${inspectionDate} (${vehicleData.inspectionHistory.length} total)</p>`;
        } else if (isExistingInFleet) {
          historyText = '<p style="color: #666; font-size: 0.9rem;">Found in your fleet (no previous inspections)</p>';
        } else {
          historyText = '<p style="color: #666; font-size: 0.9rem;">New vehicle - will be added to your fleet</p>';
        }
        
        popup.innerHTML = `
          <div class="vehicle-popup-content">
            <h3>${isExistingInFleet ? '🚗 Is this your vehicle?' : '🆕 New vehicle detected'}</h3>
            <p><strong>${vehicleData.make} ${vehicleData.model} ${vehicleData.year}</strong></p>
            <p>${vehicleData.color} • ${vehicleData.plate}</p>
            ${historyText}
            <div class="popup-buttons">
              <button class="popup-btn btn-yes" onclick="confirmVehicle(true)">✅ Yes</button>
              <button class="popup-btn btn-no" onclick="confirmVehicle(false)">❌ No</button>
            </div>
          </div>
        `;
        
        detectedVehicle = vehicleData;
        document.body.appendChild(popup);
      }

      // Show manual vehicle entry
      function showManualVehicleEntry() {
        console.log('📝 Showing manual vehicle entry');
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'manual-vehicle-entry';
        popup.innerHTML = `
          <div class="vehicle-popup-content">
            <h3>📝 Enter Vehicle Details</h3>
            <div class="manual-form">
              <div class="form-row">
                <div>
                  <label>Make</label>
                  <input type="text" id="manual-make" placeholder="Toyota" required>
                </div>
                <div>
                  <label>Model</label>
                  <input type="text" id="manual-model" placeholder="Camry" required>
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label>Year</label>
                  <input type="number" id="manual-year" min="1990" max="2025" placeholder="2023" required>
                </div>
                <div>
                  <label>Color</label>
                  <input type="text" id="manual-color" placeholder="Silver" required>
                </div>
              </div>
              <div class="form-row">
                <div style="flex: 1;">
                  <label>License Plate</label>
                  <input type="text" id="manual-plate" placeholder="ABC123" required>
                </div>
              </div>
            </div>
            <div class="popup-buttons">
              <button class="popup-btn btn-yes" onclick="saveManualVehicle()">💾 Save & Continue</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(popup);
      }

      // Global popup functions
      window.confirmVehicle = async function(confirmed) {
        console.log('🚗 Vehicle confirmation:', confirmed);
        const popup = document.getElementById('vehicle-confirmation');
        if (popup) popup.remove();
        
        if (confirmed) {
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.vehicleUUID;
          console.log('✅ Using vehicle UUID:', currentVehicleId);
          
          await ensureVehicleFolder();
          
          statusBar.textContent = "✅ Vehicle confirmed - ready for inspection";
          currentStep = 0;
          updateStep();
          nextButton.disabled = false;
        } else {
          showManualVehicleEntry();
        }
      };

      window.saveManualVehicle = async function() {
        console.log('💾 Saving manual vehicle...');
        const make = document.getElementById('manual-make').value.trim();
        const model = document.getElementById('manual-model').value.trim();
        const year = document.getElementById('manual-year').value.trim();
        const color = document.getElementById('manual-color').value.trim();
        const plate = document.getElementById('manual-plate').value.trim();
        
        if (!make || !model || !year || !color || !plate) {
          alert('Please fill in all fields');
          return;
        }
        
        detectedVehicle = { make, model, year, color, plate, confidence: 1.0 };
        detectedVehicle.vehicleUUID = generateVehicleUUID();
        vehicleInfo = detectedVehicle;
        currentVehicleId = detectedVehicle.vehicleUUID;
        console.log('✅ Created new vehicle UUID:', currentVehicleId);
        
        const popup = document.getElementById('manual-vehicle-entry');
        if (popup) popup.remove();
        
        await ensureVehicleFolder();
        
        statusBar.textContent = "✅ Vehicle details saved - ready for inspection";
        currentStep = 0;
        updateStep();
        nextButton.disabled = false;
      };

      // Upload to R2
      async function uploadToR2() {
        try {
          statusBar.textContent = "📤 Uploading photo...";
          
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          
          canvas.toBlob(async (blob) => {
            if (!blob) {
              statusBar.textContent = "❌ Failed to capture photo";
              return;
            }
            
            const userId = currentUser?.id || 'anonymous';
            const vehicleId = currentVehicleId || 'unknown-vehicle';
            const inspectionId = generateInspectionId();
            
            let fileName;
            if (currentStep === -1) {
              fileName = `rental-shield/users/${userId}/vehicles/${vehicleId}/inspections/${inspectionId}/license-plate.jpg`;
            } else {
              fileName = `rental-shield/users/${userId}/vehicles/${vehicleId}/inspections/${inspectionId}/step-${currentStep + 1}-${steps[currentStep].replace(/\s+/g, '-').toLowerCase()}.jpg`;
            }

            console.log('📤 Uploading to:', fileName);

            try {
              const formData = new FormData();
              formData.append('file', blob, fileName);
              formData.append('fileName', fileName);
              formData.append('bucketName', 'rental-shield');
              formData.append('metadata', JSON.stringify({
                vehicleId: vehicleId,
                inspectionId: inspectionId,
                userId: userId,
                vehicleData: detectedVehicle,
                stepNumber: currentStep + 1,
                stepName: steps[currentStep],
                isLicensePlate: currentStep === -1
              }));

              const response = await fetch('/.netlify/functions/upload-to-r2', {
                method: 'POST',
                body: formData
              });

              if (response.ok) {
                const result = await response.json();
                const uploadUrl = result.url;
                
                if (currentStep >= 0) {
                  const fileInfo = {
                    step: currentStep + 1,
                    stepName: steps[currentStep],
                    url: uploadUrl,
                    type: "photo",
                    timestamp: new Date().toISOString(),
                    fileSize: Math.round(blob.size / 1024) + " KB",
                    vehicleId: vehicleId,
                    inspectionId: inspectionId,
                    filePath: fileName
                  };
                  
                  uploadedVideoUrls.push(fileInfo);
                }

                statusBar.textContent = `✅ Photo uploaded! (${Math.round(blob.size / 1024)} KB)`;
                nextButton.disabled = false;
                console.log('✅ Upload successful:', uploadUrl);
              } else {
                throw new Error(`Upload failed: ${response.status}`);
              }
            } catch (uploadError) {
              console.error('❌ R2 upload failed:', uploadError);
              statusBar.textContent = "⚠️ Upload failed - continuing anyway";
              nextButton.disabled = false;
            }
          }, 'image/jpeg', 0.8);
          
        } catch (error) {
          console.error('❌ Upload error:', error);
          statusBar.textContent = "⚠️ Upload error - continuing anyway";
          nextButton.disabled = false;
        }
      }

      // Next step
      function nextStep() {
        console.log('▶️ Next step...');
        if (currentStep < steps.length - 1) {
          currentStep++;
          updateStep();
        } else {
          stepInstruction.textContent = "🎉 Inspection completed! Processing...";
          nextButton.style.display = "none";
          photoButton.style.display = "none";
          statusBar.textContent = "Sending to AI analysis...";
          
          triggerInspectionComplete();
        }
      }

      // Trigger inspection completion
      async function triggerInspectionComplete() {
        const inspectionId = uploadedVideoUrls[0]?.inspectionId || generateInspectionId();
        const completionData = {
          inspectionId: inspectionId,
          vehicleInfo: {
            ...vehicleInfo,
            vehicleId: currentVehicleId,
            isNewVehicle: !userVehicles.find(v => v.vehicleId === currentVehicleId)
          },
          userInfo: {
            userId: currentUser?.id || 'anonymous',
            email: currentUser?.email || 'unknown'
          },
          completedAt: new Date().toISOString(),
          totalSteps: steps.length,
          uploadedFiles: uploadedVideoUrls,
          folderStructure: {
            basePath: `rental-shield/users/${currentUser?.id || 'anonymous'}/vehicles/${currentVehicleId}/inspections/${inspectionId}/`,
            licensePlatePhoto: `rental-shield/users/${currentUser?.id || 'anonymous'}/vehicles/${currentVehicleId}/inspections/${inspectionId}/license-plate.jpg`,
            inspectionPhotos: uploadedVideoUrls.map(file => file.filePath)
          },
          summary: {
            totalFiles: uploadedVideoUrls.length,
            totalSize: uploadedVideoUrls.reduce((sum, file) => {
              return sum + parseInt(file.fileSize.replace(" KB", ""));
            }, 0) + " KB",
            photoCount: uploadedVideoUrls.length,
            videoCount: 0,
          },
          readyForAIAnalysis: true,
          status: "inspection_complete",
          testMode: isTestMode,
        };

        try {
          const webhookUrl = "https://hamzaw.app.n8n.cloud/webhook-test/50903630-1eac-46a7-a041-6b5614e9f533";

          console.log("🚀 Triggering completion webhook...");

          const response = await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(completionData),
          });

          if (response.ok) {
            const vehicleText = vehicleInfo.make ? 
              `${vehicleInfo.make} ${vehicleInfo.model} ${vehicleInfo.year}` : 
              "Vehicle";
            stepInstruction.textContent = `✅ ${vehicleText} inspection sent for AI analysis!`;
            statusBar.textContent = "Processing complete - AI analysis started! 🤖";
            console.log("✅ Webhook sent successfully!");

            if (!userVehicles.find(v => v.vehicleId === currentVehicleId)) {
              userVehicles.push({
                vehicleId: currentVehicleId,
                ...vehicleInfo,
                inspectionHistory: [{ date: new Date().toISOString(), inspectionId }]
              });
            }
          } else {
            throw new Error(`Webhook failed: ${response.status}`);
          }
        } catch (error) {
          console.error("❌ Webhook failed:", error);
          stepInstruction.textContent = "⚠️ Analysis trigger failed - inspection data saved locally";
          statusBar.textContent = "Inspection complete - please contact support if needed";
        }
      }

      // Lighting check
      function checkLighting() {
        if (!inspectionStarted || video.readyState < 2) return;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth || 100;
        canvas.height = video.videoHeight || 100;

        if (video.videoWidth > 0) {
          ctx.drawImage(video, 0, 0);
          const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
          let total = 0;

          for (let i = 0; i < frame.data.length; i += 4) {
            const brightness =
              0.299 * frame.data[i] +
              0.587 * frame.data[i + 1] +
              0.114 * frame.data[i + 2];
            total += brightness;
          }

          const avg = total / (frame.data.length / 4);
          const lightOK = avg > 30 && avg < 200;

          if (currentStep === -1) {
            if (!statusBar.textContent.includes("✅") && !statusBar.textContent.includes("📤") && !statusBar.textContent.includes("🔍")) {
              statusBar.textContent = `Lighting: ${lightOK ? "🟢 Good" : "🟡 Check"} | License plate detection ready`;
            }
          } else if (!statusBar.textContent.includes("✅") && !statusBar.textContent.includes("📤")) {
            statusBar.textContent = `Lighting: ${lightOK ? "🟢 Good" : "🟡 Check"} | Ready for photo`;
          }
        }
      }

      function loopStatus() {
        checkLighting();
        requestAnimationFrame(loopStatus);
      }

      // Event listeners
      startInspectionBtn.addEventListener("click", function() {
        console.log('🚀 Start button clicked');
        startInspection();
      });

      testModeBtn.addEventListener("click", function() {
        console.log('🧪 Test button clicked');
        startTestMode();
      });

      photoButton.addEventListener("click", function() {
        console.log('📸 Photo button clicked');
        capturePhoto();
      });

      nextButton.addEventListener("click", function() {
        console.log('▶️ Next button clicked');
        nextStep();
      });

      // Initialize app
      console.log('🎬 Initializing camera and lighting detection...');
      startCamera();
      loopStatus();
      console.log('✅ App setup complete!');
    </script>
    
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/dashboard.html";
            });
          }
        });
      }
    </script>
  </body>
</html>
