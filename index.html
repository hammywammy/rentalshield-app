<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Car Inspection Recorder</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: black;
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }
      
      video {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
        background: #000;
      }
      
      #start-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000000;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        z-index: 100;
        padding: 2rem;
      }
      
      #start-screen h1 {
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
        font-weight: 700;
      }
      
      #start-screen p {
        font-size: 1.2rem;
        margin-bottom: 2rem;
        opacity: 0.9;
        line-height: 1.6;
        max-width: 600px;
      }
      
      .btn {
        padding: 1rem 2rem;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        margin: 0.5rem;
        transition: all 0.2s;
        min-width: 180px;
      }
      
      .btn:hover {
        background: #45a049;
        transform: translateY(-1px);
      }
      
      .btn-test {
        background: #ff9800;
        font-size: 1rem;
      }
      
      .btn-test:hover {
        background: #e68900;
      }
      
      #status-bar {
        position: fixed;
        top: 20px;
        left: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 1rem;
        font-size: 1.1rem;
        border-radius: 12px;
        text-align: center;
        z-index: 50;
        user-select: none;
        display: none;
        backdrop-filter: blur(10px);
      }
      
      #step-instruction {
        position: fixed;
        bottom: 140px;
        left: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        font-size: 1.3rem;
        text-align: center;
        z-index: 50;
        line-height: 1.4;
        user-select: none;
        word-wrap: break-word;
        display: none;
        backdrop-filter: blur(10px);
        font-weight: 500;
      }
      
      #photo-button,
      #next-button {
        position: fixed;
        bottom: 30px;
        padding: 1rem 2rem;
        font-size: 1.4rem;
        font-weight: 600;
        border-radius: 50px;
        border: none;
        color: white;
        cursor: pointer;
        z-index: 50;
        user-select: none;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        transition: all 0.2s;
        display: none;
      }
      
      #photo-button {
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(45deg, #2196f3, #1976d2);
        font-size: 1.6rem;
        padding: 1.2rem 2.5rem;
        min-width: 180px;
      }
      
      #photo-button:hover {
        transform: translateX(-50%) translateY(-2px);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.5);
      }
      
      #next-button {
        right: 30px;
        background: linear-gradient(45deg, #4caf50, #388e3c);
        min-width: 140px;
      }
      
      #next-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.5);
      }
      
      #next-button:disabled {
        background: #666;
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .flash-effect {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        z-index: 200;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.1s;
      }
      
      .flash-effect.active {
        opacity: 0.9;
      }
      
      /* Vehicle confirmation popup */
      .vehicle-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2rem;
        border-radius: 16px;
        z-index: 500;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        max-width: 400px;
        width: 90%;
        color: #333;
      }
      
      .vehicle-popup h3 {
        margin: 0 0 1rem 0;
        color: #333;
        font-size: 1.4rem;
        font-weight: 600;
      }
      
      .vehicle-popup p {
        margin: 0.5rem 0;
        color: #666;
        font-size: 1rem;
        line-height: 1.4;
      }
      
      .vehicle-popup strong {
        color: #333;
        font-size: 1.1rem;
      }
      
      .popup-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }
      
      .popup-btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.2s;
        min-width: 120px;
      }
      
      .popup-btn:hover {
        transform: translateY(-1px);
      }
      
      .btn-yes {
        background: #4caf50;
        color: white;
      }
      
      .btn-no {
        background: #f44336;
        color: white;
      }
      
      .btn-yes:hover {
        background: #45a049;
      }
      
      .btn-no:hover {
        background: #da190b;
      }
      
      /* Manual vehicle form */
      .manual-form {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1rem 0;
        text-align: left;
      }
      
      .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      
      .form-row input {
        flex: 1;
        padding: 0.8rem;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
      }
      
      .form-row input:focus {
        outline: none;
        border-color: #4caf50;
      }
      
      .form-row label {
        display: block;
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }
      
      /* Mobile responsive */
      @media (max-width: 768px) {
        #start-screen h1 {
          font-size: 2rem;
        }
        
        #start-screen p {
          font-size: 1.1rem;
        }
        
        .btn {
          padding: 1rem 1.5rem;
          font-size: 1.1rem;
        }
        
        #step-instruction {
          bottom: 120px;
          font-size: 1.2rem;
        }
        
        .form-row {
          flex-direction: column;
          gap: 0.5rem;
        }
        
        .popup-buttons {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <video id="video" autoplay muted playsinline></video>
    <div id="flash-effect" class="flash-effect"></div>

    <!-- Start Screen -->
    <div id="start-screen">
      <h1>üöó Car Inspection</h1>
      <p>Welcome to the vehicle inspection app.<br><br>
      <strong>Instructions:</strong><br>
      ‚Ä¢ First, take a clear photo of your license plate<br>
      ‚Ä¢ Then follow the 18-step inspection process<br>
      ‚Ä¢ Each photo will be automatically uploaded and analyzed</p>
      <button id="start-inspection-btn" class="btn">Start Inspection</button>
      <button id="test-mode-btn" class="btn btn-test">üß™ Test Mode</button>
    </div>

    <!-- Status and Controls -->
    <div id="status-bar">Ready to start...</div>
    <div id="step-instruction">Loading...</div>
    <button id="photo-button">üì∏ Take Photo</button>
    <button id="next-button" disabled>Next Step</button>

    <script>
      console.log('Script starting...');
      
      // Global variables - declared once
      let supabase = null;
      let currentUser = null;
      let currentStep = -1;
      let vehicleInfo = null;
      let detectedVehicle = null;
      let inspectionStarted = false;
      let uploadedFiles = [];
      let isTestMode = false;
      let userVehicles = [];
      let currentVehicleId = null;
      let currentInspectionId = null;
      
      const steps = [
        "front_bumper",
        "driver_side_front_fender", 
        "driver_side_front_wheel",
        "driver_side_doors",
        "driver_side_rear_wheel",
        "driver_side_rear_fender",
        "rear_bumper",
        "passenger_side_rear_fender",
        "passenger_side_rear_wheel", 
        "passenger_side_doors",
        "passenger_side_front_wheel",
        "passenger_side_front_fender",
        "front_windshield",
        "interior_dashboard",
        "interior_front_seats",
        "interior_rear_seats",
        "odometer",
        "trunk_cargo_area",
      ];

      // Get elements
      const video = document.getElementById("video");
      const statusBar = document.getElementById("status-bar");
      const stepInstruction = document.getElementById("step-instruction");
      const nextButton = document.getElementById("next-button");
      const photoButton = document.getElementById("photo-button");
      const startScreen = document.getElementById("start-screen");
      const startInspectionBtn = document.getElementById("start-inspection-btn");
      const testModeBtn = document.getElementById("test-mode-btn");
      const flashEffect = document.getElementById("flash-effect");

      console.log('Elements found:', {
        startInspectionBtn: !!startInspectionBtn,
        testModeBtn: !!testModeBtn,
        photoButton: !!photoButton,
        nextButton: !!nextButton
      });

      // Initialize Supabase connection
      async function initSupabase() {
        try {
          const configResponse = await fetch('/.netlify/functions/get-config');
          const config = await configResponse.json();
          
          supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
          console.log('‚úÖ Supabase initialized');
          
          currentUser = { 
            id: 'test-user-' + Date.now(), 
            email: 'test@example.com' 
          };
          console.log('‚úÖ Using test user:', currentUser.email);
        } catch (error) {
          console.error('‚ùå Supabase initialization failed:', error);
          currentUser = { id: 'offline-user', email: 'offline@example.com' };
        }
      }

      // Start camera
      async function startCamera() {
        try {
          console.log('Requesting camera...');
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280, max: 1280 },
              height: { ideal: 720, max: 720 },
              frameRate: { ideal: 30 },
            },
            audio: false,
          });
          video.srcObject = stream;
          console.log("Camera started successfully");
        } catch (e) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "environment",
                width: { ideal: 1024, max: 1024 },
                height: { ideal: 576, max: 576 },
                frameRate: { ideal: 30 },
              },
              audio: false,
            });
            video.srcObject = stream;
            console.log("Camera started with fallback settings");
          } catch (e2) {
            console.log("Camera not available:", e2);
            video.style.display = 'none';
          }
        }
      }

      // Generate UUID
      function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      // Vehicle matching functions
      function cleanPlate(plate) {
        return plate.replace(/[^A-Z0-9]/g, '').toUpperCase();
      }

      function findExistingVehicle(detectedVehicle) {
        const cleanDetectedPlate = cleanPlate(detectedVehicle.license_plate || detectedVehicle.plate);
        
        return userVehicles.find(vehicle => {
          const cleanStoredPlate = cleanPlate(vehicle.license_plate);
          
          if (cleanDetectedPlate === cleanStoredPlate) {
            return true;
          }
          
          const platesSimilar = cleanDetectedPlate.length >= 3 && 
            cleanStoredPlate.includes(cleanDetectedPlate.substring(0, 3));
          const makeModelMatch = vehicle.make.toLowerCase() === detectedVehicle.make.toLowerCase() &&
            vehicle.model.toLowerCase() === detectedVehicle.model.toLowerCase();
          
          return platesSimilar && makeModelMatch;
        });
      }

      // Load user vehicles from Supabase
      async function loadUserVehicles() {
        try {
          if (!supabase || !currentUser) {
            console.log('No Supabase connection, skipping vehicle load');
            userVehicles = [];
            return;
          }
          
          console.log('Loading user vehicles from Supabase...');
          const { data, error } = await supabase
            .from('vehicles')
            .select(`
              *,
              inspections(*)
            `)
            .eq('user_id', currentUser.id);
          
          if (error) throw error;
          
          userVehicles = (data || []).map(vehicle => ({
            ...vehicle,
            inspectionHistory: vehicle.inspections || [],
            totalInspections: vehicle.inspections?.length || 0
          }));
          
          console.log('Loaded user vehicles:', userVehicles);
        } catch (error) {
          console.error("Couldn't load user vehicles:", error);
          userVehicles = [];
        }
      }

      // Start inspection
      async function startInspection() {
        console.log('Starting inspection...');
        isTestMode = false;
        inspectionStarted = true;
        
        await loadUserVehicles();
        
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        photoButton.style.display = "block";
        nextButton.style.display = "block";
        
        currentStep = -1;
        updateStep();
      }

      // Test mode
      async function startTestMode() {
        console.log('Starting test mode...');
        isTestMode = true;
        inspectionStarted = true;
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        
        statusBar.textContent = "üß™ Test mode - using sample data";
        stepInstruction.textContent = "üß™ TEST MODE: Simulating inspection complete";

        detectedVehicle = {
          make: "Toyota",
          model: "Camry",
          year: 2023,
          color: "Silver",
          license_plate: "TEST123",
          confidence: 0.95
        };
        vehicleInfo = detectedVehicle;
        currentVehicleId = generateUUID();
        currentInspectionId = generateUUID();

        await new Promise((resolve) => setTimeout(resolve, 1000));

        statusBar.textContent = "üß™ Test inspection completed!";
        stepInstruction.textContent = "üß™ TEST MODE: Test data ready for analysis";
      }

      // Update step display
      function updateStep() {
        if (currentStep === -1) {
          stepInstruction.textContent = "üìã Step 0: Take a clear photo of your license plate";
          statusBar.textContent = "üì∏ License plate detection - Make sure plate is clearly visible";
        } else {
          let vehicleText = "Vehicle";
          let inspectionContext = "";
          
          if (detectedVehicle) {
            vehicleText = `${detectedVehicle.make} ${detectedVehicle.model} ${detectedVehicle.year}`;
            
            if (detectedVehicle.totalInspections > 0) {
              inspectionContext = ` (Inspection #${detectedVehicle.totalInspections + 1})`;
            } else {
              inspectionContext = " (First inspection)";
            }
          }
          
          stepInstruction.textContent = `${vehicleText}${inspectionContext} - Step ${currentStep + 1} of ${steps.length}: ${steps[currentStep].replace(/_/g, ' ')}`;
          statusBar.textContent = "üì∏ Ready to take photo";
        }
        
        nextButton.disabled = true;
      }

      // License plate detection
      async function detectLicensePlate() {
        try {
          statusBar.textContent = "üîç Analyzing license plate with AI...";
          
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          
          const imageData = canvas.toDataURL('image/jpeg', 0.8);
          const base64 = imageData.split(',')[1];
          
          console.log('ü§ñ Calling GPT-4 Vision for vehicle detection...');
          
          const response = await fetch('/.netlify/functions/gpt-vehicle-detect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              imageBase64: base64,
              userId: currentUser.id
            })
          });
          
          const result = await response.json();
          console.log('ü§ñ GPT-4 Detection result:', result);
          
          if (result.success && result.vehicle) {
            statusBar.textContent = "‚úÖ Vehicle detected - checking history...";
            
            const existingVehicle = findExistingVehicle(result.vehicle);
            
            if (existingVehicle) {
              console.log('üìã Found existing vehicle:', existingVehicle.license_plate);
              result.vehicle.id = existingVehicle.id;
              result.vehicle.inspectionHistory = existingVehicle.inspectionHistory || [];
              result.vehicle.totalInspections = existingVehicle.inspectionHistory?.length || 0;
              result.vehicle.lastInspection = existingVehicle.inspectionHistory?.length > 0 ? 
                existingVehicle.inspectionHistory[existingVehicle.inspectionHistory.length - 1] : null;
              
              showVehicleHistoryConfirmation(result.vehicle);
            } else {
              console.log('üÜï New vehicle detected:', result.vehicle.license_plate);
              result.vehicle.id = generateUUID();
              result.vehicle.inspectionHistory = [];
              result.vehicle.totalInspections = 0;
              
              showNewVehicleConfirmation(result.vehicle);
            }
          } else {
            console.log('‚ùå No clear detection - manual entry');
            statusBar.textContent = "üîç Couldn't detect clearly - please confirm details";
            showSimpleVehicleEntry();
          }
          
        } catch (error) {
          console.error('‚ùå License plate detection error:', error);
          statusBar.textContent = "üîç Detection failed - please enter details";
          showSimpleVehicleEntry();
        }
      }

      // Show popups
      function showVehicleHistoryConfirmation(vehicleData) {
        console.log('üìã Showing vehicle history confirmation:', vehicleData);
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'vehicle-history-confirmation';
        
        let lastInspectionText = '';
        if (vehicleData.lastInspection) {
          const lastDate = new Date(vehicleData.lastInspection.inspection_date || vehicleData.lastInspection.timestamp).toLocaleDateString();
          lastInspectionText = `<p style="color: #2e7d32; font-size: 0.9rem; font-weight: 500;">
            üìÖ Last inspection: ${lastDate}
          </p>`;
        }
        
        popup.innerHTML = `
          <h3>üöó Found existing vehicle!</h3>
          <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
            <p style="margin: 0.5rem 0; font-size: 1.1rem;"><strong>${vehicleData.make} ${vehicleData.model} ${vehicleData.year}</strong></p>
            <p style="margin: 0.5rem 0; color: #666;">${vehicleData.color} ‚Ä¢ ${vehicleData.license_plate}</p>
            ${lastInspectionText}
            <p style="color: #1976d2; font-size: 0.9rem; font-weight: 500;">
              üìä ${vehicleData.totalInspections} previous inspection${vehicleData.totalInspections !== 1 ? 's' : ''} on record
            </p>
          </div>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Is this the correct vehicle?</p>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="confirmVehicle(true)">‚úÖ Yes, this is correct</button>
            <button class="popup-btn btn-no" onclick="confirmVehicle(false)">‚ùå No, different vehicle</button>
          </div>
        `;
        
        detectedVehicle = vehicleData;
        document.body.appendChild(popup);
      }

      function showNewVehicleConfirmation(vehicleData) {
        console.log('üÜï Showing new vehicle confirmation:', vehicleData);
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'new-vehicle-confirmation';
        
        popup.innerHTML = `
          <h3>üÜï New vehicle detected</h3>
          <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
            <p style="margin: 0.5rem 0; font-size: 1.1rem;"><strong>${vehicleData.make} ${vehicleData.model} ${vehicleData.year}</strong></p>
            <p style="margin: 0.5rem 0; color: #666;">${vehicleData.color} ‚Ä¢ ${vehicleData.license_plate}</p>
            <p style="color: #ed6c02; font-size: 0.9rem; font-weight: 500;">
              üìù This will be your first inspection of this vehicle
            </p>
          </div>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Does this look correct?</p>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="confirmVehicle(true)">‚úÖ Yes, add to my vehicles</button>
            <button class="popup-btn btn-no" onclick="confirmVehicle(false)">‚ùå No, let me correct this</button>
          </div>
        `;
        
        detectedVehicle = vehicleData;
        document.body.appendChild(popup);
      }

      function showSimpleVehicleEntry() {
        console.log('Showing simple vehicle entry');
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'simple-vehicle-entry';
        popup.innerHTML = `
          <h3>üìù Confirm Vehicle Details</h3>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Please enter your vehicle information:</p>
          <div class="manual-form">
            <div class="form-row">
              <div>
                <label>License Plate</label>
                <input type="text" id="manual-plate" placeholder="ABC123" required>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Make</label>
                <input type="text" id="manual-make" placeholder="Toyota" required>
              </div>
              <div>
                <label>Model</label>
                <input type="text" id="manual-model" placeholder="Camry" required>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Year</label>
                <input type="number" id="manual-year" min="1990" max="2025" placeholder="2023" required>
              </div>
              <div>
                <label>Color</label>
                <input type="text" id="manual-color" placeholder="Silver" required>
              </div>
            </div>
          </div>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="saveVehicleDetails()">üíæ Save & Continue</button>
          </div>
        `;
        
        document.body.appendChild(popup);
      }

      // Global functions for popups
      window.confirmVehicle = async function(confirmed) {
        console.log('üöó Vehicle confirmation:', confirmed);
        
        const popups = ['vehicle-history-confirmation', 'new-vehicle-confirmation'];
        popups.forEach(id => {
          const popup = document.getElementById(id);
          if (popup) popup.remove();
        });
        
        if (confirmed) {
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.id;
          
          await createInspection();
          
          const isNew = detectedVehicle.totalInspections === 0;
          statusBar.textContent = isNew ? 
            "‚úÖ New vehicle added - first inspection" : 
            `‚úÖ Vehicle confirmed - inspection #${detectedVehicle.totalInspections + 1}`;
          
          currentStep = 0;
          updateStep();
          nextButton.disabled = false;
        } else {
          console.log('‚ùå User says vehicle info is wrong');
          showSimpleVehicleEntry();
        }
      };

      window.saveVehicleDetails = async function() {
        console.log('üíæ Saving vehicle details...');
        const make = document.getElementById('manual-make').value.trim();
        const model = document.getElementById('manual-model').value.trim();
        const year = parseInt(document.getElementById('manual-year').value.trim());
        const color = document.getElementById('manual-color').value.trim();
        const license_plate = document.getElementById('manual-plate').value.trim();
        
        if (!make || !model || !year || !color || !license_plate) {
          alert('Please fill in all fields');
          return;
        }
        
        const manualVehicle = { make, model, year, color, license_plate, confidence: 1.0 };
        const existingVehicle = findExistingVehicle(manualVehicle);
        
        if (existingVehicle) {
          console.log('üìã Manual entry matches existing vehicle');
          detectedVehicle = {
            ...manualVehicle,
            id: existingVehicle.id,
            inspectionHistory: existingVehicle.inspectionHistory || [],
            totalInspections: existingVehicle.inspectionHistory?.length || 0
          };
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.id;
          statusBar.textContent = `‚úÖ Vehicle found - inspection #${detectedVehicle.totalInspections + 1}`;
        } else {
          console.log('üÜï Creating new vehicle from manual entry');
          detectedVehicle = manualVehicle;
          detectedVehicle.id = generateUUID();
          detectedVehicle.inspectionHistory = [];
          detectedVehicle.totalInspections = 0;
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.id;
          
          statusBar.textContent = "‚úÖ New vehicle created - first inspection";
        }
        
        const popup = document.getElementById('simple-vehicle-entry');
        if (popup) popup.remove();
        
        await createInspection();
        
        currentStep = 0;
        updateStep();
        nextButton.disabled = false;
      };

      // Create inspection in Supabase
      async function createInspection() {
        try {
          if (!supabase) {
            console.log('No Supabase connection, skipping database operations');
            currentInspectionId = generateUUID();
            return;
          }

          console.log('Creating inspection in Supabase...');
          
          const { data: existingVehicle, error: vehicleCheckError } = await supabase
            .from('vehicles')
            .select('id')
            .eq('id', currentVehicleId)
            .single();

          if (vehicleCheckError && vehicleCheckError.code === 'PGRST116') {
            console.log('Creating new vehicle in database...');
            const { error: vehicleError } = await supabase
              .from('vehicles')
              .insert({
                id: currentVehicleId,
                user_id: currentUser.id,
                make: vehicleInfo.make,
                model: vehicleInfo.model,
                year: vehicleInfo.year,
                license_plate: vehicleInfo.license_plate,
                created_at: new Date().toISOString()
              });

            if (vehicleError) throw vehicleError;
            console.log('‚úÖ Vehicle created in database');
          }

          currentInspectionId = generateUUID();
          const { error: inspectionError } = await supabase
            .from('inspections')
            .insert({
              id: currentInspectionId,
              vehicle_id: currentVehicleId,
              user_id: currentUser.id,
              inspection_date: new Date().toISOString(),
              status: 'pending',
              notes: isTestMode ? 'Test inspection' : null
            });

          if (inspectionError) throw inspectionError;
          
          console.log('‚úÖ Inspection created in database:', currentInspectionId);
          
        } catch (error) {
          console.error('‚ùå Error creating inspection:', error);
          currentInspectionId = generateUUID();
        }
      }

      // Upload to R2
      async function uploadToR2() {
        try {
          statusBar.textContent = "üì§ Uploading photo...";
          
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          
          canvas.toBlob(async (blob) => {
            if (!blob) {
              statusBar.textContent = "‚ùå Failed to capture photo";
              return;
            }
            
            const stepName = steps[currentStep];
            const fileName = `${stepName}_${currentVehicleId}.jpg`;
            
            console.log('Uploading file:', fileName);

            try {
              const formData = new FormData();
              formData.append('file', blob, fileName);
              formData.append('fileName', fileName);
              formData.append('vehicleId', currentVehicleId);
              formData.append('inspectionId', currentInspectionId);
              formData.append('stepName', stepName);
              formData.append('stepNumber', currentStep + 1);
              formData.append('userId', currentUser.id);

              const response = await fetch('/.netlify/functions/upload-to-r2', {
                method: 'POST',
                body: formData
              });

              if (response.ok) {
                const result = await response.json();
                
                const fileInfo = {
                  step: currentStep + 1,
                  stepName: stepName,
                  fileName: fileName,
                  url: result.url,
                  cloudflare_path: result.path,
                  type: "photo",
                  timestamp: new Date().toISOString(),
                  fileSize: Math.round(blob.size / 1024) + " KB",
                  vehicleId: currentVehicleId,
                  inspectionId: currentInspectionId
                };
                
                uploadedFiles.push(fileInfo);

                statusBar.textContent = `‚úÖ Photo uploaded! (${Math.round(blob.size / 1024)} KB)`;
                nextButton.disabled = false;
                console.log('Upload successful:', result.url);
              } else {
                throw new Error(`Upload failed: ${response.status}`);
              }
            } catch (uploadError) {
              console.error('R2 upload failed:', uploadError);
              statusBar.textContent = "‚ö†Ô∏è Upload failed - continuing anyway";
              nextButton.disabled = false;
            }
          }, 'image/jpeg', 0.8);
          
        } catch (error) {
          console.error('Upload error:', error);
          statusBar.textContent = "‚ö†Ô∏è Upload error - continuing anyway";
          nextButton.disabled = false;
        }
      }

      // Capture photo
      function capturePhoto() {
        console.log('Capturing photo...');
        
        flashEffect.classList.add("active");
        setTimeout(() => flashEffect.classList.remove("active"), 100);

        if (currentStep === -1) {
          detectLicensePlate();
        } else {
          uploadToR2();
        }
      }

      // Next step
      function nextStep() {
        console.log('Next step...');
        if (currentStep < steps.length - 1) {
          currentStep++;
          updateStep();
        } else {
          stepInstruction.textContent = "üéâ Inspection completed! Processing...";
          nextButton.style.display = "none";
          photoButton.style.display = "none";
          statusBar.textContent = "Finalizing inspection...";
          
          completeInspection();
        }
      }

      // Complete inspection
      async function completeInspection() {
        try {
          if (supabase && currentInspectionId) {
            const { error } = await supabase
              .from('inspections')
              .update({ 
                status: 'complete',
                notes: `Inspection completed with ${uploadedFiles.length} photos`
              })
              .eq('id', currentInspectionId);

            if (error) throw error;
            console.log('‚úÖ Inspection marked as complete in database');
          }

          const vehicleText = vehicleInfo.make ? 
            `${vehicleInfo.make} ${vehicleInfo.model} ${vehicleInfo.year}` : 
            "Vehicle";
          stepInstruction.textContent = `‚úÖ ${vehicleText} inspection completed!`;
          statusBar.textContent = `Complete! ${uploadedFiles.length} photos uploaded üéâ`;
          
        } catch (error) {
          console.error('Error completing inspection:', error);
          stepInstruction.textContent = "‚ö†Ô∏è Inspection completed but database update failed";
          statusBar.textContent = "Inspection complete - data saved locally";
        }
      }

      // Lighting check
      function checkLighting() {
        if (!inspectionStarted || video.readyState < 2) return;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth || 100;
        canvas.height = video.videoHeight || 100;

        if (video.videoWidth > 0) {
          ctx.drawImage(video, 0, 0);
          const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
          let total = 0;

          for (let i = 0; i < frame.data.length; i += 4) {
            const brightness =
              0.299 * frame.data[i] +
              0.587 * frame.data[i + 1] +
              0.114 * frame.data[i + 2];
            total += brightness;
          }

          const avg = total / (frame.data.length / 4);
          const lightOK = avg > 30 && avg < 200;

          if (currentStep === -1) {
            if (!statusBar.textContent.includes("‚úÖ") && !statusBar.textContent.includes("üì§") && !statusBar.textContent.includes("üîç")) {
              statusBar.textContent = `Lighting: ${lightOK ? "üü¢ Good" : "üü° Check"} | License plate detection ready`;
            }
          } else if (!statusBar.textContent.includes("‚úÖ") && !statusBar.textContent.includes("üì§")) {
            statusBar.textContent = `Lighting: ${lightOK ? "üü¢ Good" : "üü° Check"} | Ready for photo`;
          }
        }
      }

      function loopStatus() {
        checkLighting();
        requestAnimationFrame(loopStatus);
      }

      // Event listeners
      startInspectionBtn.addEventListener("click", function() {
        console.log('Start button clicked!');
        startInspection();
      });

      testModeBtn.addEventListener("click", function() {
        console.log('Test button clicked!');
        startTestMode();
      });

      photoButton.addEventListener("click", function() {
        console.log('Photo button clicked!');
        capturePhoto();
      });

      nextButton.addEventListener("click", function() {
        console.log('Next button clicked!');
        nextStep();
      });

      // Initialize
      console.log('Setting up app...');
      console.log('currentUser before init:', typeof currentUser);
      
      initSupabase().then(() => {
        console.log('currentUser after init:', currentUser);
        startCamera();
        loopStatus();
        console.log('Setup complete!');
      }).catch(error => {
        console.error('Setup failed:', error);
        currentUser = { id: 'fallback-user', email: 'fallback@test.com' };
        startCamera();
        loopStatus();
        console.log('Setup complete with fallback!');
      });
    </script>
  </body>
</html>
