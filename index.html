<!DOCTYPE html>
<html lang="en">
  <head>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Car Inspection Recorder - Photo Only</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        background: black;
      }
      video {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 0;
      }
      #vehicle-info {
        position: fixed;
        top: 2rem;
        left: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 1rem;
        border-radius: 0.75rem;
        text-align: center;
        z-index: 10;
        font-size: 1.2rem;
      }
      #vehicle-input {
        width: 100%;
        padding: 0.5rem;
        font-size: 1rem;
        border-radius: 0.5rem;
        border: none;
        margin-bottom: 0.5rem;
      }
      #start-inspection {
        padding: 0.5rem 1rem;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
      }
      #status-bar {
        position: fixed;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 1rem;
        font-size: 1.2rem;
        border-radius: 0.75rem;
        text-align: center;
        z-index: 10;
        user-select: none;
        display: none;
      }
      #step-instruction {
        position: fixed;
        bottom: 8rem;
        left: 1rem;
        right: 1rem;
        margin: 0 auto;
        background: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 1rem;
        border-radius: 0.75rem;
        font-size: 1.5rem;
        text-align: center;
        z-index: 10;
        line-height: 1.4;
        user-select: none;
        box-sizing: border-box;
        word-wrap: break-word;
        display: none;
      }
      #photo-button,
      #next-button {
        position: fixed;
        bottom: 1.5rem;
        padding: 0.8rem 1.6rem;
        font-size: 1.5rem;
        border-radius: 1rem;
        border: none;
        color: white;
        cursor: pointer;
        z-index: 10;
        user-select: none;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
        transition: background-color 0.3s, opacity 0.3s;
        display: none;
      }
      #photo-button {
        left: 50%;
        transform: translateX(-50%);
        background-color: #2196f3;
        font-size: 1.8rem;
        padding: 1rem 2rem;
      }
      #next-button {
        right: 1rem;
        background-color: #4caf50;
      }
      #next-button:disabled {
        background-color: #888;
        opacity: 0.5;
        cursor: not-allowed;
      }
      .flash-effect {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        z-index: 20;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.1s;
      }
      .flash-effect.active {
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
  <script>
    let currentUser = null;

    // Check authentication on page load
    netlifyIdentity.on('init', user => {
        if (!user) {
            // No user logged in, redirect to auth
            window.location.href = '/auth.html';
            return;
        }
        
        currentUser = user;
        console.log('Authenticated user:', user);
        
        // Continue with your existing app initialization
        initializeApp();
    });

    // Your existing initialization code goes in this function
    function initializeApp() {
        // Move your existing window.onload code here
        startCamera();
        loopStatus();
        // ... rest of your existing code
    }

    netlifyIdentity.init();
</script>
    <video id="video" autoplay muted playsinline></video>

    <!-- Camera flash effect -->
    <div id="flash-effect" class="flash-effect"></div>

    <!-- Vehicle Info Input -->
    <div id="vehicle-info">
      <div style="margin-bottom: 0.5rem; font-weight: bold">
        Enter Vehicle Information
      </div>
      <input
        type="text"
        id="vehicle-input"
        placeholder="e.g., Chevy Silverado 2023 (or type TEST for demo)"
      />
      <button id="start-inspection">Start Inspection</button>
    </div>

    <!-- Status and Controls -->
    <div id="status-bar">Lighting: ...</div>
    <div id="step-instruction">Loading steps...</div>
    <button id="photo-button">📸 Take Photo</button>
    <button id="next-button" disabled>Next Step</button>

    <script>
      const steps = [
        "Front bumper",
        "Driver side front fender",
        "Driver side front wheel",
        "Driver side doors",
        "Driver side rear wheel",
        "Driver side rear fender",
        "Rear bumper",
        "Passenger side rear fender",
        "Passenger side rear wheel",
        "Passenger side doors",
        "Passenger side front wheel",
        "Passenger side front fender",
        "Front windshield",
        "Interior: dashboard",
        "Interior: front seats",
        "Interior: rear seats",
        "Odometer",
        "Trunk/cargo area",
      ];

      // Test folder photos - your R2 bucket URLs
      const testFolderPhotos = [
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-bumper.jpg", // Front bumper
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-left-fender.jpg", // Driver side front fender
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-left-wheel.jpg", // Driver side front wheel
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/left-side-doors.jpg", // Driver side doors
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-left-wheel.jpg", // Driver side rear wheel
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-left-fender.jpg", // Driver side rear fender
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-bumper.jpg", // Rear bumper
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-right-fender.jpg", // Passenger side rear fender
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-right-wheel.jpg", // Passenger side rear wheel
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/right-side-doors.jpg", // Passenger side doors
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-right-wheel.jpg", // Passenger side front wheel
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-right-fender.jpg", // Passenger side front fender
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-windshield.jpg", // Front windshield
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/dashboard.jpg", // Dashboard
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/front-seats.jpg", // Front seats
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/rear-seats.jpg", // Rear seats
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/odometer.jpg", // Odometer
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/test-videos/trunk.jpg", // Trunk
      ];

      let currentStep = 0;
      let recordedBlob = null;
      let vehicleInfo = null;
      let inspectionStarted = false;
      let uploadedVideoUrls = []; // Track all uploaded files
      let isTestMode = false;

      const video = document.getElementById("video");
      const statusBar = document.getElementById("status-bar");
      const stepInstruction = document.getElementById("step-instruction");
      const nextButton = document.getElementById("next-button");
      const photoButton = document.getElementById("photo-button");
      const vehicleInfoDiv = document.getElementById("vehicle-info");
      const vehicleInput = document.getElementById("vehicle-input");
      const startInspectionBtn = document.getElementById("start-inspection");
      const flashEffect = document.getElementById("flash-effect");

      // Upload to Cloudflare R2 using Worker
      async function uploadToR2(blob, isPhoto = true) {
        const cleanVehicleName = vehicleInfo.replace(/[^a-zA-Z0-9]/g, "_");
        const fileName = `${cleanVehicleName}/${cleanVehicleName}-step-${
          currentStep + 1
        }-${Date.now()}.jpg`;

        try {
          const formData = new FormData();
          formData.append("file", blob, fileName);
          formData.append("fileName", fileName);

          const response = await fetch(
            "https://uploadworker.hwmodels14.workers.dev/",
            {
              method: "POST",
              body: formData,
            }
          );

          const result = await response.json();

          if (result.success) {
            console.log("Upload successful to R2!");
            return result.url;
          } else {
            console.error("R2 upload failed:", result.error);
            return false;
          }
        } catch (error) {
          console.error("R2 upload error:", error);
          return false;
        }
      }

      // Start camera with optimized settings for smaller file sizes
      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280, max: 1280 }, // Reduced from 1920
              height: { ideal: 720, max: 720 }, // Reduced from 1080
              frameRate: { ideal: 30 },
            },
            audio: false,
          });
          video.srcObject = stream;
        } catch (e) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "environment",
                width: { ideal: 1024, max: 1024 }, // Further reduced fallback
                height: { ideal: 576, max: 576 },
                frameRate: { ideal: 30 },
              },
              audio: false,
            });
            video.srcObject = stream;
          } catch (e2) {
            console.log("Camera not available, test mode will work anyway");
          }
        }
      }

      // Start inspection
      startInspectionBtn.addEventListener("click", async () => {
        vehicleInfo = vehicleInput.value.trim();
        if (!vehicleInfo) {
          alert("Please enter vehicle information");
          return;
        }

        // Check for test mode
        isTestMode = vehicleInfo.toUpperCase() === "TEST";

        if (isTestMode) {
          vehicleInfo = "Test Vehicle 2023";

          // Auto-send test folder photos immediately
          stepInstruction.textContent =
            "🧪 TEST MODE: Auto-sending test folder photos...";
          stepInstruction.style.display = "block";
          vehicleInfoDiv.style.display = "none";
          statusBar.style.display = "block";
          statusBar.textContent = "🧪 TEST MODE: Preparing test data...";

          await autoSendTestPhotos();
          return; // Exit early, don't show manual inspection UI
        }

        inspectionStarted = true;

        vehicleInfoDiv.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        photoButton.style.display = "block";
        nextButton.style.display = "block";

        updateStep();
      });

      // Auto-send test photos from test folder
      async function autoSendTestPhotos() {
        statusBar.textContent = "🧪 Creating test data from folder...";

        // Create test data with photos from your test folder
        uploadedVideoUrls = [];
        for (let i = 0; i < steps.length; i++) {
          uploadedVideoUrls.push({
            step: i + 1,
            stepName: steps[i],
            url: testFolderPhotos[i] || testFolderPhotos[0], // Use test folder photos
            type: "photo",
            timestamp: new Date().toISOString(),
            fileSize: Math.floor(Math.random() * 150 + 100) + " KB", // Smaller realistic file sizes
          });
        }

        console.log("Test folder data created:", uploadedVideoUrls);

        // Small delay for visual feedback
        await new Promise((resolve) => setTimeout(resolve, 1000));

        statusBar.textContent = "🧪 Test data ready! Triggering webhook...";
        stepInstruction.textContent =
          "🧪 TEST MODE: Sending 18 test photos to AI analysis...";

        // Auto-trigger the webhook with test data
        await triggerInspectionComplete();

        // Hide all buttons since we're done
        photoButton.style.display = "none";
        nextButton.style.display = "none";
      }

      function updateStep() {
        stepInstruction.textContent = `${vehicleInfo} - Step ${
          currentStep + 1
        } of ${steps.length}: Photo — ${steps[currentStep]}`;
        nextButton.disabled = true;
        recordedBlob = null;

        if (isTestMode) {
          stepInstruction.textContent += ` (TEST MODE - Real photos will be used)`;
          nextButton.disabled = false; // In test mode, allow skipping photos
        }
      }

      // Optimized photo capture with reduced quality for smaller file sizes
      // Add this to your existing JavaScript in index.html

let detectedVehicle = null;

// Modify your existing capturePhoto function
async function capturePhoto() {
    try {
        // Your existing photo capture code...
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        // Convert to blob
        canvas.toBlob(async (blob) => {
            recordedBlob = blob;
            
            // NEW: If this is step 1 (front bumper), detect vehicle
            if (currentStep === 0) {
                await detectVehicleFromPhoto(blob);
            } else {
                // Continue with normal flow
                await uploadToR2();
                proceedToNextStep();
            }
        }, 'image/jpeg', 0.8);
        
    } catch (error) {
        console.error('Error capturing photo:', error);
    }
}

// NEW: Vehicle detection function
async function detectVehicleFromPhoto(photoBlob) {
    try {
        // Show loading state
        showVehicleDetectionLoading();
        
        // Convert blob to base64
        const base64 = await blobToBase64(photoBlob);
        
        // Call our Netlify function
        const response = await fetch('/.netlify/functions/detect-vehicle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                imageBase64: base64.split(',')[1] // Remove data:image/jpeg;base64, prefix
            })
        });
        
        const result = await response.json();
        
        if (result.success && result.vehicle) {
            detectedVehicle = result.vehicle;
            showVehicleConfirmation(result.vehicle);
        } else {
            // Detection failed, continue with manual entry
            showManualVehicleEntry();
        }
        
    } catch (error) {
        console.error('Vehicle detection error:', error);
        // Fallback to manual entry
        showManualVehicleEntry();
    }
}

// Helper function to convert blob to base64
function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

// Show loading state during detection
function showVehicleDetectionLoading() {
    const modal = document.createElement('div');
    modal.id = 'detection-modal';
    modal.innerHTML = `
        <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:flex; align-items:center; justify-content:center;">
            <div style="background:white; padding:2rem; border-radius:1rem; text-align:center; max-width:400px;">
                <div style="animation: spin 1s linear infinite; width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #667eea; border-radius:50%; margin:0 auto 1rem;"></div>
                <h3>🔍 Detecting Vehicle...</h3>
                <p>AI is analyzing your photo</p>
            </div>
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    `;
    document.body.appendChild(modal);
}

// Show vehicle confirmation dialog
function showVehicleConfirmation(vehicleInfo) {
    // Remove loading modal
    const loadingModal = document.getElementById('detection-modal');
    if (loadingModal) loadingModal.remove();
    
    const modal = document.createElement('div');
    modal.id = 'vehicle-confirmation';
    modal.innerHTML = `
        <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:flex; align-items:center; justify-content:center;">
            <div style="background:white; padding:2rem; border-radius:1rem; text-align:center; max-width:500px; margin:1rem;">
                <h3>🚗 Vehicle Detected!</h3>
                <div style="text-align:left; margin:1rem 0; padding:1rem; background:#f8f9fa; border-radius:8px;">
                    <p><strong>Make:</strong> ${vehicleInfo.make}</p>
                    <p><strong>Model:</strong> ${vehicleInfo.model}</p>
                    <p><strong>Year:</strong> ${vehicleInfo.year}</p>
                    <p><strong>Color:</strong> ${vehicleInfo.color}</p>
                    <p><strong>License:</strong> ${vehicleInfo.plate}</p>
                    <p><strong>Confidence:</strong> ${Math.round(vehicleInfo.confidence * 100)}%</p>
                </div>
                <p style="font-size:14px; color:#666; margin-bottom:1rem;">
                    ${vehicleInfo.notes || 'No additional notes'}
                </p>
                <div style="display:flex; gap:1rem; justify-content:center;">
                    <button onclick="confirmVehicle(true)" style="background:#28a745; color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer;">
                        ✅ Correct
                    </button>
                    <button onclick="confirmVehicle(false)" style="background:#dc3545; color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer;">
                        ❌ Wrong
                    </button>
                    <button onclick="editVehicleInfo()" style="background:#ffc107; color:black; border:none; padding:12px 24px; border-radius:6px; cursor:pointer;">
                        ✏️ Edit
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Handle vehicle confirmation
async function confirmVehicle(isCorrect) {
    const modal = document.getElementById('vehicle-confirmation');
    if (modal) modal.remove();
    
    if (isCorrect) {
        // Use detected vehicle info
        vehicleInfo = detectedVehicle;
        
        // Update your existing uploadToR2 function to use this info
        await uploadToR2();
        proceedToNextStep();
    } else {
        // Show manual entry form
        showManualVehicleEntry();
    }
}

// Manual vehicle entry fallback
function showManualVehicleEntry() {
    // Remove any existing modals
    const existingModal = document.getElementById('detection-modal') || document.getElementById('vehicle-confirmation');
    if (existingModal) existingModal.remove();
    
    const modal = document.createElement('div');
    modal.id = 'manual-vehicle-modal';
    modal.innerHTML = `
        <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:flex; align-items:center; justify-content:center;">
            <div style="background:white; padding:2rem; border-radius:1rem; max-width:400px; margin:1rem;">
                <h3>Enter Vehicle Information</h3>
                <form id="manual-vehicle-form" style="text-align:left;">
                    <div style="margin-bottom:1rem;">
                        <label>Make:</label>
                        <input type="text" id="vehicle-make" required style="width:100%; padding:8px; margin-top:4px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label>Model:</label>
                        <input type="text" id="vehicle-model" required style="width:100%; padding:8px; margin-top:4px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label>Year:</label>
                        <input type="number" id="vehicle-year" min="1990" max="2025" required style="width:100%; padding:8px; margin-top:4px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label>Color:</label>
                        <input type="text" id="vehicle-color" required style="width:100%; padding:8px; margin-top:4px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label>License Plate:</label>
                        <input type="text" id="vehicle-plate" required style="width:100%; padding:8px; margin-top:4px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div style="text-align:center;">
                        <button type="submit" style="background:#667eea; color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer;">
                            Continue Inspection
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Handle form submission
    document.getElementById('manual-vehicle-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Create vehicle info from form
        detectedVehicle = {
            make: document.getElementById('vehicle-make').value,
            model: document.getElementById('vehicle-model').value,
            year: document.getElementById('vehicle-year').value,
            color: document.getElementById('vehicle-color').value,
            plate: document.getElementById('vehicle-plate').value,
            confidence: 1.0,
            condition: "Manual Entry",
            notes: "Entered manually by user"
        };
        
        vehicleInfo = detectedVehicle;
        
        // Remove modal
        modal.remove();
        
        // Continue with inspection
        await uploadToR2();
        proceedToNextStep();
    });
}

// Add edit functionality
function editVehicleInfo() {
    const modal = document.getElementById('vehicle-confirmation');
    if (modal) modal.remove();
    
    // Show manual form pre-filled with detected values
    const editModal = document.createElement('div');
    editModal.innerHTML = `
        <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:flex; align-items:center; justify-content:center;">
            <div style="background:white; padding:2rem; border-radius:1rem; max-width:400px; margin:1rem;">
                <h3>Edit Vehicle Information</h3>
                <form id="edit-vehicle-form" style="text-align:left;">
                    <div style="margin-bottom:1rem;">
                        <label>Make:</label>
                        <input type="text" id="edit-make" value="${detectedVehicle.make}" required style="width:100%; padding:8px; margin-top:4px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label>Model:</label>
                        <input type="text" id="edit-model" value="${detectedVehicle.model}" required style="width:100%; padding:8px; margin-top:4px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label>Year:</label>
                        <input type="text" id="edit-year" value="${detectedVehicle.year}" required style="width:100%; padding:8px; margin-top:4px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label>Color:</label>
                        <input type="text" id="edit-color" value="${detectedVehicle.color}" required style="width:100%; padding:8px; margin-top:4px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label>License Plate:</label>
                        <input type="text" id="edit-plate" value="${detectedVehicle.plate}" required style="width:100%; padding:8px; margin-top:4px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div style="text-align:center;">
                        <button type="submit" style="background:#667eea; color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer;">
                            Save & Continue
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(editModal);
    
    // Handle edit form submission
    document.getElementById('edit-vehicle-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Update vehicle info with edited values
        detectedVehicle = {
            make: document.getElementById('edit-make').value,
            model: document.getElementById('edit-model').value,
            year: document.getElementById('edit-year').value,
            color: document.getElementById('edit-color').value,
            plate: document.getElementById('edit-plate').value,
            confidence: detectedVehicle.confidence,
            condition: "Edited",
            notes: "Edited by user"
        };
        
        vehicleInfo = detectedVehicle;
        
        // Remove modal
        editModal.remove();
        
        // Continue with inspection
        await uploadToR2();
        proceedToNextStep();
    });
}

      // Handle upload and track URLs
      async function handleUpload() {
        if (recordedBlob || isTestMode) {
          statusBar.textContent = `Lighting: 🟢 OK | Uploading photo...`;

          let uploadResult;

          if (isTestMode) {
            // In test mode, simulate upload with test photo URL
            uploadResult = testFolderPhotos[currentStep] || testFolderPhotos[0];

            // Simulate upload delay
            await new Promise((resolve) => setTimeout(resolve, 500));
          } else {
            uploadResult = await uploadToR2(recordedBlob, true);
          }

          if (uploadResult) {
            // Store the uploaded URL
            uploadedVideoUrls.push({
              step: currentStep + 1,
              stepName: steps[currentStep],
              url: uploadResult,
              type: "photo",
              timestamp: new Date().toISOString(),
              fileSize: isTestMode
                ? Math.floor(Math.random() * 150 + 100) + " KB"
                : Math.round(recordedBlob.size / 1024) + " KB",
            });

            nextButton.disabled = false;
            statusBar.textContent = `Lighting: 🟢 OK | Photo uploaded! ✅ (${
              isTestMode
                ? "Test photo"
                : Math.round(recordedBlob.size / 1024) + " KB"
            })`;
            console.log("File available at:", uploadResult);
          } else {
            statusBar.textContent = `Lighting: 🟢 OK | Upload failed ❌ - try again`;
          }
        }
      }

      // Trigger when all 18 steps are complete
      async function triggerInspectionComplete() {
        const inspectionId = Date.now();
        const completionData = {
          inspectionId: inspectionId,
          vehicleInfo: vehicleInfo,
          completedAt: new Date().toISOString(),
          totalSteps: steps.length,
          uploadedFiles: uploadedVideoUrls,
          summary: {
            totalFiles: uploadedVideoUrls.length,
            totalSize:
              uploadedVideoUrls.reduce((sum, file) => {
                return sum + parseInt(file.fileSize.replace(" KB", ""));
              }, 0) + " KB",
            photoCount: uploadedVideoUrls.length,
            videoCount: 0,
          },
          readyForAIAnalysis: true,
          status: "inspection_complete",
          testMode: isTestMode,
        };

        try {
          const webhookUrl =
            "https://hamzaw.app.n8n.cloud/webhook-test/50903630-1eac-46a7-a041-6b5614e9f533";

          console.log("🚀 Triggering inspection completion webhook...");
          console.log("Completion data:", completionData);

          const response = await fetch(webhookUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(completionData),
          });

          if (response.ok) {
            stepInstruction.textContent = `✅ ${vehicleInfo} inspection sent for AI analysis!`;
            statusBar.textContent =
              "Processing complete - AI analysis started! 🤖";
            console.log("✅ Webhook sent successfully to n8n!");
          } else {
            stepInstruction.textContent = `❌ Failed to trigger analysis. Please contact support.`;
            console.error(
              "❌ Webhook failed:",
              response.status,
              response.statusText
            );
          }
        } catch (error) {
          console.error("Webhook trigger failed:", error);
          stepInstruction.textContent = `❌ Failed to trigger analysis. Please contact support.`;
        }
      }

      // Lighting check (simplified for photo mode)
      function checkLighting() {
        if (!inspectionStarted || video.readyState < 2) return;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth || 100;
        canvas.height = video.videoHeight || 100;

        if (video.videoWidth > 0) {
          ctx.drawImage(video, 0, 0);
          const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
          let total = 0;

          for (let i = 0; i < frame.data.length; i += 4) {
            const brightness =
              0.299 * frame.data[i] +
              0.587 * frame.data[i + 1] +
              0.114 * frame.data[i + 2];
            total += brightness;
          }

          const avg = total / (frame.data.length / 4);
          const lightOK = avg > 30 && avg < 200;

          if (!recordedBlob) {
            statusBar.textContent = `Lighting: ${
              lightOK ? "🟢 OK" : "🔴 Check"
            } | Ready for photo`;
          }
        } else {
          statusBar.textContent = "📷 Test mode - Ready for photo";
        }
      }

      function loopStatus() {
        checkLighting();
        requestAnimationFrame(loopStatus);
      }

      // Event listeners
      photoButton.addEventListener("click", () => {
        if (isTestMode) {
          // In test mode, simulate photo capture
          handleUpload();
        } else {
          capturePhoto();
        }
      });

      nextButton.addEventListener("click", async () => {
        if (currentStep < steps.length - 1) {
          currentStep++;
          updateStep();
        } else {
          stepInstruction.textContent = `🎉 ${vehicleInfo} inspection completed! Processing...`;
          nextButton.style.display = "none";
          photoButton.style.display = "none";

          await triggerInspectionComplete();
        }
      });

      // Initialize app
      startCamera();
      loopStatus();
    </script>
    <script>
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on("init", user => {
      if (!user) {
        window.netlifyIdentity.on("login", () => {
          document.location.href = "/dashboard.html";
        });
      }
    });
  }
</script>
  </body>
</html>
