<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Car Inspection Recorder</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: black;
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }
      
      video {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
        background: #000;
      }
      
      #start-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000000;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        z-index: 100;
        padding: 2rem;
      }
      
      #start-screen h1 {
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
        font-weight: 700;
      }
      
      #start-screen p {
        font-size: 1.2rem;
        margin-bottom: 2rem;
        opacity: 0.9;
        line-height: 1.6;
        max-width: 600px;
      }
      
      .btn {
        padding: 1rem 2rem;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        margin: 0.5rem;
        transition: all 0.2s;
        min-width: 180px;
      }
      
      .btn:hover {
        background: #45a049;
        transform: translateY(-1px);
      }
      
      .btn-test {
        background: #ff9800;
        font-size: 1rem;
      }
      
      .btn-test:hover {
        background: #e68900;
      }
      
      #status-bar {
        position: fixed;
        top: 20px;
        left: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 1rem;
        font-size: 1.1rem;
        border-radius: 12px;
        text-align: center;
        z-index: 50;
        user-select: none;
        display: none;
        backdrop-filter: blur(10px);
      }
      
      #step-instruction {
        position: fixed;
        bottom: 140px;
        left: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        font-size: 1.3rem;
        text-align: center;
        z-index: 50;
        line-height: 1.4;
        user-select: none;
        word-wrap: break-word;
        display: none;
        backdrop-filter: blur(10px);
        font-weight: 500;
      }
      
      #photo-button,
      #next-button {
        position: fixed;
        bottom: 30px;
        padding: 1rem 2rem;
        font-size: 1.4rem;
        font-weight: 600;
        border-radius: 50px;
        border: none;
        color: white;
        cursor: pointer;
        z-index: 50;
        user-select: none;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        transition: all 0.2s;
        display: none;
      }
      
      #photo-button {
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(45deg, #2196f3, #1976d2);
        font-size: 1.6rem;
        padding: 1.2rem 2.5rem;
        min-width: 180px;
      }
      
      #photo-button:hover {
        transform: translateX(-50%) translateY(-2px);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.5);
      }
      
      #next-button {
        right: 30px;
        background: linear-gradient(45deg, #4caf50, #388e3c);
        min-width: 140px;
      }
      
      #next-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.5);
      }
      
      #next-button:disabled {
        background: #666;
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .flash-effect {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        z-index: 200;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.1s;
      }
      
      .flash-effect.active {
        opacity: 0.9;
      }
      
      /* Vehicle confirmation popup */
      .vehicle-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2rem;
        border-radius: 16px;
        z-index: 500;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        max-width: 400px;
        width: 90%;
        color: #333;
      }
      
      .vehicle-popup h3 {
        margin: 0 0 1rem 0;
        color: #333;
        font-size: 1.4rem;
        font-weight: 600;
      }
      
      .vehicle-popup p {
        margin: 0.5rem 0;
        color: #666;
        font-size: 1rem;
        line-height: 1.4;
      }
      
      .vehicle-popup strong {
        color: #333;
        font-size: 1.1rem;
      }
      
      .popup-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }
      
      .popup-btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.2s;
        min-width: 120px;
      }
      
      .popup-btn:hover {
        transform: translateY(-1px);
      }
      
      .btn-yes {
        background: #4caf50;
        color: white;
      }
      
      .btn-no {
        background: #f44336;
        color: white;
      }
      
      .btn-yes:hover {
        background: #45a049;
      }
      
      .btn-no:hover {
        background: #da190b;
      }
      
      /* Manual vehicle form */
      .manual-form {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1rem 0;
        text-align: left;
      }
      
      .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      
      .form-row input {
        flex: 1;
        padding: 0.8rem;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
      }
      
      .form-row input:focus {
        outline: none;
        border-color: #4caf50;
      }
      
      .form-row label {
        display: block;
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }
      
      /* Mobile responsive */
      @media (max-width: 768px) {
        #start-screen h1 {
          font-size: 2rem;
        }
        
        #start-screen p {
          font-size: 1.1rem;
        }
        
        .btn {
          padding: 1rem 1.5rem;
          font-size: 1.1rem;
        }
        
        #step-instruction {
          bottom: 120px;
          font-size: 1.2rem;
        }
        
        .form-row {
          flex-direction: column;
          gap: 0.5rem;
        }
        
        .popup-buttons {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <video id="video" autoplay muted playsinline></video>
    <div id="flash-effect" class="flash-effect"></div>

    <!-- Start Screen -->
    <div id="start-screen">
      <h1>üöó Car Inspection</h1>
      <p>Welcome to the vehicle inspection app.<br><br>
      <strong>Instructions:</strong><br>
      ‚Ä¢ First, take a clear photo of your license plate<br>
      ‚Ä¢ Then follow the 18-step inspection process<br>
      ‚Ä¢ Each photo will be automatically uploaded and analyzed</p>
      <button id="start-inspection-btn" class="btn">Start Inspection</button>
      <button id="test-mode-btn" class="btn btn-test">üß™ Test Mode</button>
    </div>

    <!-- Status and Controls -->
    <div id="status-bar">Ready to start...</div>
    <div id="step-instruction">Loading...</div>
    <button id="photo-button">üì∏ Take Photo</button>
    <button id="next-button" disabled>Next Step</button>

    <script>
      console.log('Script starting...');
      
      // Initialize Supabase and user
      let supabase = null;
      let currentUser = null;
      
      // Initialize Supabase connection
      async function initSupabase() {
        try {
          // Get config from backend
          const configResponse = await fetch('/.netlify/functions/get-config');
          const config = await configResponse.json();
          
          supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
          console.log('‚úÖ Supabase initialized');
          
          // Set test user
          currentUser = { 
            id: 'test-user-' + Date.now(), 
            email: 'test@example.com' 
          };
          console.log('‚úÖ Using test user:', currentUser.email);
        } catch (error) {
          console.error('‚ùå Supabase initialization failed:', error);
          // Fallback to offline mode
          currentUser = { id: 'offline-user', email: 'offline@example.com' };
        }
      }
      const steps = [
        "front_bumper",
        "driver_side_front_fender", 
        "driver_side_front_wheel",
        "driver_side_doors",
        "driver_side_rear_wheel",
        "driver_side_rear_fender",
        "rear_bumper",
        "passenger_side_rear_fender",
        "passenger_side_rear_wheel", 
        "passenger_side_doors",
        "passenger_side_front_wheel",
        "passenger_side_front_fender",
        "front_windshield",
        "interior_dashboard",
        "interior_front_seats",
        "interior_rear_seats",
        "odometer",
        "trunk_cargo_area",
      ];

      let currentStep = -1; // -1 = license plate step, 0-17 = inspection steps
      let vehicleInfo = null;
      let detectedVehicle = null;
      let inspectionStarted = false;
      let uploadedFiles = [];
      let isTestMode = false;
      let userVehicles = [];
      let currentVehicleId = null;
      let currentInspectionId = null;

      // Get elements
      const video = document.getElementById("video");
      const statusBar = document.getElementById("status-bar");
      const stepInstruction = document.getElementById("step-instruction");
      const nextButton = document.getElementById("next-button");
      const photoButton = document.getElementById("photo-button");
      const startScreen = document.getElementById("start-screen");
      const startInspectionBtn = document.getElementById("start-inspection-btn");
      const testModeBtn = document.getElementById("test-mode-btn");
      const flashEffect = document.getElementById("flash-effect");

      console.log('Elements found:', {
        startInspectionBtn: !!startInspectionBtn,
        testModeBtn: !!testModeBtn,
        photoButton: !!photoButton,
        nextButton: !!nextButton
      });

      // Start camera
      async function startCamera() {
        try {
          console.log('Requesting camera...');
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280, max: 1280 },
              height: { ideal: 720, max: 720 },
              frameRate: { ideal: 30 },
            },
            audio: false,
          });
          video.srcObject = stream;
          console.log("Camera started successfully");
        } catch (e) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "environment",
                width: { ideal: 1024, max: 1024 },
                height: { ideal: 576, max: 576 },
                frameRate: { ideal: 30 },
              },
              audio: false,
            });
            video.srcObject = stream;
            console.log("Camera started with fallback settings");
          } catch (e2) {
            console.log("Camera not available:", e2);
            video.style.display = 'none';
          }
        }
      }

      // Generate UUID
      function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      // PHASE 1: Vehicle matching functions
      function cleanPlate(plate) {
        return plate.replace(/[^A-Z0-9]/g, '').toUpperCase();
      }

      function findExistingVehicle(detectedVehicle) {
        const cleanDetectedPlate = cleanPlate(detectedVehicle.license_plate || detectedVehicle.plate);
        
        return userVehicles.find(vehicle => {
          const cleanStoredPlate = cleanPlate(vehicle.license_plate);
          
          // Exact plate match
          if (cleanDetectedPlate === cleanStoredPlate) {
            return true;
          }
          
          // Similar plate + make/model match (handles OCR errors)
          const platesSimilar = cleanDetectedPlate.length >= 3 && 
            cleanStoredPlate.includes(cleanDetectedPlate.substring(0, 3));
          const makeModelMatch = vehicle.make.toLowerCase() === detectedVehicle.make.toLowerCase() &&
            vehicle.model.toLowerCase() === detectedVehicle.model.toLowerCase();
          
          return platesSimilar && makeModelMatch;
        });
      }

      // Load user vehicles from Supabase
      async function loadUserVehicles() {
        try {
          if (!supabase || !currentUser) {
            console.log('No Supabase connection, skipping vehicle load');
            userVehicles = [];
            return;
          }
          
          console.log('Loading user vehicles from Supabase...');
          const { data, error } = await supabase
            .from('vehicles')
            .select(`
              *,
              inspections(*)
            `)
            .eq('user_id', currentUser.id);
          
          if (error) throw error;
          
          userVehicles = (data || []).map(vehicle => ({
            ...vehicle,
            inspectionHistory: vehicle.inspections || [],
            totalInspections: vehicle.inspections?.length || 0
          }));
          
          console.log('Loaded user vehicles:', userVehicles);
        } catch (error) {
          console.error("Couldn't load user vehicles:", error);
          userVehicles = [];
        }
      }

      // Start inspection
      async function startInspection() {
        console.log('Starting inspection...');
        isTestMode = false;
        inspectionStarted = true;
        
        await loadUserVehicles();
        
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        photoButton.style.display = "block";
        nextButton.style.display = "block";
        
        currentStep = -1; // Start with license plate
        updateStep();
      }

      // Test mode
      async function startTestMode() {
        console.log('Starting test mode...');
        isTestMode = true;
        inspectionStarted = true;
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        
        statusBar.textContent = "üß™ Test mode - using sample data";
        stepInstruction.textContent = "üß™ TEST MODE: Simulating inspection complete";

        // Create test vehicle data
        detectedVehicle = {
          make: "Toyota",
          model: "Camry",
          year: 2023,
          color: "Silver",
          license_plate: "TEST123",
          confidence: 0.95
        };
        vehicleInfo = detectedVehicle;
        currentVehicleId = generateUUID();
        currentInspectionId = generateUUID();

        await new Promise((resolve) => setTimeout(resolve, 1000));

        statusBar.textContent = "üß™ Test inspection completed!";
        stepInstruction.textContent = "üß™ TEST MODE: Test data ready for analysis";
      }

      // Update step display with vehicle history context
      function updateStep() {
        if (currentStep === -1) {
          stepInstruction.textContent = "üìã Step 0: Take a clear photo of your license plate";
          statusBar.textContent = "üì∏ License plate detection - Make sure plate is clearly visible";
        } else {
          let vehicleText = "Vehicle";
          let inspectionContext = "";
          
          if (detectedVehicle) {
            vehicleText = `${detectedVehicle.make} ${detectedVehicle.model} ${detectedVehicle.year}`;
            
            if (detectedVehicle.totalInspections > 0) {
              inspectionContext = ` (Inspection #${detectedVehicle.totalInspections + 1})`;
            } else {
              inspectionContext = " (First inspection)";
            }
          }
          
          stepInstruction.textContent = `${vehicleText}${inspectionContext} - Step ${currentStep + 1} of ${steps.length}: ${steps[currentStep].replace(/_/g, ' ')}`;
          statusBar.textContent = "üì∏ Ready to take photo";
        }
        
        nextButton.disabled = true;
      }

      // License plate detection with GPT-4 Vision
      async function detectLicensePlate() {
        try {
          statusBar.textContent = "üîç Analyzing license plate with AI...";
          
          // Create a canvas to get image data
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          
          // Convert to base64
          const imageData = canvas.toDataURL('image/jpeg', 0.8);
          const base64 = imageData.split(',')[1];
          
          console.log('ü§ñ Calling GPT-4 Vision for vehicle detection...');
          
          // Call GPT-4 Vision API
          const response = await fetch('/.netlify/functions/gpt-vehicle-detect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              imageBase64: base64,
              userId: currentUser.id
            })
          });
          
          const result = await response.json();
          console.log('ü§ñ GPT-4 Detection result:', result);
          
          if (result.success && result.vehicle) {
            statusBar.textContent = "‚úÖ Vehicle detected - checking history...";
            
            // Check if this vehicle exists in user's history
            const existingVehicle = findExistingVehicle(result.vehicle);
            
            if (existingVehicle) {
              // Found existing vehicle
              console.log('üìã Found existing vehicle:', existingVehicle.license_plate);
              result.vehicle.id = existingVehicle.id;
              result.vehicle.inspectionHistory = existingVehicle.inspectionHistory || [];
              result.vehicle.totalInspections = existingVehicle.inspectionHistory?.length || 0;
              result.vehicle.lastInspection = existingVehicle.inspectionHistory?.length > 0 ? 
                existingVehicle.inspectionHistory[existingVehicle.inspectionHistory.length - 1] : null;
              
              showVehicleHistoryConfirmation(result.vehicle);
            } else {
              // New vehicle detected
              console.log('üÜï New vehicle detected:', result.vehicle.license_plate);
              result.vehicle.id = generateUUID();
              result.vehicle.inspectionHistory = [];
              result.vehicle.totalInspections = 0;
              
              showNewVehicleConfirmation(result.vehicle);
            }
          } else {
            // No clear detection - show manual entry
            console.log('‚ùå No clear detection - manual entry');
            statusBar.textContent = "üîç Couldn't detect clearly - please confirm details";
            showSimpleVehicleEntry();
          }
          
        } catch (error) {
          console.error('‚ùå License plate detection error:', error);
          statusBar.textContent = "üîç Detection failed - please enter details";
          showSimpleVehicleEntry();
        }
      }

      // Show vehicle history confirmation for existing vehicles
      function showVehicleHistoryConfirmation(vehicleData) {
        console.log('üìã Showing vehicle history confirmation:', vehicleData);
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'vehicle-history-confirmation';
        
        // Format last inspection date
        let lastInspectionText = '';
        if (vehicleData.lastInspection) {
          const lastDate = new Date(vehicleData.lastInspection.inspection_date || vehicleData.lastInspection.timestamp).toLocaleDateString();
          lastInspectionText = `<p style="color: #2e7d32; font-size: 0.9rem; font-weight: 500;">
            üìÖ Last inspection: ${lastDate}
          </p>`;
        }
        
        popup.innerHTML = `
          <h3>üöó Found existing vehicle!</h3>
          <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
            <p style="margin: 0.5rem 0; font-size: 1.1rem;"><strong>${vehicleData.make} ${vehicleData.model} ${vehicleData.year}</strong></p>
            <p style="margin: 0.5rem 0; color: #666;">${vehicleData.color} ‚Ä¢ ${vehicleData.license_plate}</p>
            ${lastInspectionText}
            <p style="color: #1976d2; font-size: 0.9rem; font-weight: 500;">
              üìä ${vehicleData.totalInspections} previous inspection${vehicleData.totalInspections !== 1 ? 's' : ''} on record
            </p>
          </div>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Is this the correct vehicle?</p>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="confirmVehicle(true)">‚úÖ Yes, this is correct</button>
            <button class="popup-btn btn-no" onclick="confirmVehicle(false)">‚ùå No, different vehicle</button>
          </div>
        `;
        
        detectedVehicle = vehicleData;
        document.body.appendChild(popup);
      }

      // Show new vehicle confirmation
      function showNewVehicleConfirmation(vehicleData) {
        console.log('üÜï Showing new vehicle confirmation:', vehicleData);
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'new-vehicle-confirmation';
        
        popup.innerHTML = `
          <h3>üÜï New vehicle detected</h3>
          <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
            <p style="margin: 0.5rem 0; font-size: 1.1rem;"><strong>${vehicleData.make} ${vehicleData.model} ${vehicleData.year}</strong></p>
            <p style="margin: 0.5rem 0; color: #666;">${vehicleData.color} ‚Ä¢ ${vehicleData.license_plate}</p>
            <p style="color: #ed6c02; font-size: 0.9rem; font-weight: 500;">
              üìù This will be your first inspection of this vehicle
            </p>
          </div>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Does this look correct?</p>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="confirmVehicle(true)">‚úÖ Yes, add to my vehicles</button>
            <button class="popup-btn btn-no" onclick="confirmVehicle(false)">‚ùå No, let me correct this</button>
          </div>
        `;
        
        detectedVehicle = vehicleData;
        document.body.appendChild(popup);
      }

      // Show simple vehicle entry
      function showSimpleVehicleEntry() {
        console.log('Showing simple vehicle entry');
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'simple-vehicle-entry';
        popup.innerHTML = `
          <h3>üìù Confirm Vehicle Details</h3>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Please enter your vehicle information:</p>
          <div class="manual-form">
            <div class="form-row">
              <div>
                <label>License Plate</label>
                <input type="text" id="manual-plate" placeholder="ABC123" required>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Make</label>
                <input type="text" id="manual-make" placeholder="Toyota" required>
              </div>
              <div>
                <label>Model</label>
                <input type="text" id="manual-model" placeholder="Camry" required>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Year</label>
                <input type="number" id="manual-year" min="1990" max="2025" placeholder="2023" required>
              </div>
              <div>
                <label>Color</label>
                <input type="text" id="manual-color" placeholder="Silver" required>
              </div>
            </div>
          </div>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="saveVehicleDetails()">üíæ Save & Continue</button>
          </div>
        `;
        
        document.body.appendChild(popup);
      }

      // Unified confirmation handler
      window.confirmVehicle = async function(confirmed) {
        console.log('üöó Vehicle confirmation:', confirmed);
        
        // Remove any existing popups
        const popups = ['vehicle-history-confirmation', 'new-vehicle-confirmation'];
        popups.forEach(id => {
          const popup = document.getElementById(id);
          if (popup) popup.remove();
        });
        
        if (confirmed) {
          // User confirmed vehicle is correct
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.id;
          
          // Create inspection in Supabase
          await createInspection();
          
          const isNew = detectedVehicle.totalInspections === 0;
          statusBar.textContent = isNew ? 
            "‚úÖ New vehicle added - first inspection" : 
            `‚úÖ Vehicle confirmed - inspection #${detectedVehicle.totalInspections + 1}`;
          
          // Move to step 1
          currentStep = 0;
          updateStep();
          nextButton.disabled = false;
        } else {
          // User says vehicle is wrong - show manual entry
          console.log('‚ùå User says vehicle info is wrong');
          showSimpleVehicleEntry();
        }
      };

      // Save vehicle details from manual entry
      window.saveVehicleDetails = async function() {
        console.log('üíæ Saving vehicle details...');
        const make = document.getElementById('manual-make').value.trim();
        const model = document.getElementById('manual-model').value.trim();
        const year = parseInt(document.getElementById('manual-year').value.trim());
        const color = document.getElementById('manual-color').value.trim();
        const license_plate = document.getElementById('manual-plate').value.trim();
        
        if (!make || !model || !year || !color || !license_plate) {
          alert('Please fill in all fields');
          return;
        }
        
        // Check if manually entered vehicle already exists
        const manualVehicle = { make, model, year, color, license_plate, confidence: 1.0 };
        const existingVehicle = findExistingVehicle(manualVehicle);
        
        if (existingVehicle) {
          // Found existing vehicle
          console.log('üìã Manual entry matches existing vehicle');
          detectedVehicle = {
            ...manualVehicle,
            id: existingVehicle.id,
            inspectionHistory: existingVehicle.inspectionHistory || [],
            totalInspections: existingVehicle.inspectionHistory?.length || 0
          };
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.id;
          statusBar.textContent = `‚úÖ Vehicle found - inspection #${detectedVehicle.totalInspections + 1}`;
        } else {
          // Create new vehicle from manual entry
          console.log('üÜï Creating new vehicle from manual entry');
          detectedVehicle = manualVehicle;
          detectedVehicle.id = generateUUID();
          detectedVehicle.inspectionHistory = [];
          detectedVehicle.totalInspections = 0;
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.id;
          
          statusBar.textContent = "‚úÖ New vehicle created - first inspection";
        }
        
        const popup = document.getElementById('simple-vehicle-entry');
        if (popup) popup.remove();
        
        // Create inspection in Supabase
        await createInspection();
        
        // Move to step 1
        currentStep = 0;
        updateStep();
        nextButton.disabled = false;
      };

      // Create inspection in Supabase
      async function createInspection() {
        try {
          if (!supabase) {
            console.log('No Supabase connection, skipping database operations');
            currentInspectionId = generateUUID();
            return;
          }

          console.log('Creating inspection in Supabase...');
          
          // First, ensure vehicle exists in database
          const { data: existingVehicle, error: vehicleCheckError } = await supabase
            .from('vehicles')
            .select('id')
            .eq('id', currentVehicleId)
            .single();

          if (vehicleCheckError && vehicleCheckError.code === 'PGRST116') {
            // Vehicle doesn't exist, create it
            console.log('Creating new vehicle in database...');
            const { error: vehicleError } = await supabase
              .from('vehicles')
              .insert({
                id: currentVehicleId,
                user_id: currentUser.id,
                make: vehicleInfo.make,
                model: vehicleInfo.model,
                year: vehicleInfo.year,
                license_plate: vehicleInfo.license_plate,
                created_at: new Date().toISOString()
              });

            if (vehicleError) throw vehicleError;
            console.log('‚úÖ Vehicle created in database');
          }

          // Create inspection
          currentInspectionId = generateUUID();
          const { error: inspectionError } = await supabase
            .from('inspections')
            .insert({
              id: currentInspectionId,
              vehicle_id: currentVehicleId,
              user_id: currentUser.id,
              inspection_date: new Date().toISOString(),
              status: 'pending',
              notes: isTestMode ? 'Test inspection' : null
            });

          if (inspectionError) throw inspectionError;
          
          console.log('‚úÖ Inspection created in database:', currentInspectionId);
          
        } catch (error) {
          console.error('‚ùå Error creating inspection:', error);
          // Continue with local UUID if database fails
          currentInspectionId = generateUUID();
        }
      }

      // Upload to R2 function
      async function uploadToR2() {
        try {
          statusBar.textContent = "üì§ Uploading photo...";
          
          // Create a canvas to get image data
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          
          // Convert to blob
          canvas.toBlob(async (blob) => {
            if (!blob) {
              statusBar.textContent = "‚ùå Failed to capture photo";
              return;
            }
            
            // Create file name using your requested format: stepname_{vehicleid}
            const stepName = steps[currentStep];
            const fileName = `${stepName}_${currentVehicleId}.jpg`;
            
            console.log('Uploading file:', fileName);

            try {
              const formData = new FormData();
              formData.append('file', blob, fileName);
              formData.append('fileName', fileName);
              formData.append('vehicleId', currentVehicleId);
              formData.append('inspectionId', currentInspectionId);
              formData.append('stepName', stepName);
              formData.append('stepNumber', currentStep + 1);
              formData.append('userId', currentUser.id);

              const response = await fetch('/.netlify/functions/upload-to-r2', {
                method: 'POST',
                body: formData
              });

              if (response.ok) {
                const result = await response.json();
                
                // Track the uploaded file
                const fileInfo = {
                  step: currentStep + 1,
                  stepName: stepName,
                  fileName: fileName,
                  url: result.url,
                  cloudflare_path: result.path,
                  type: "photo",
                  timestamp: new Date().toISOString(),
                  fileSize: Math.round(blob.size / 1024) + " KB",
                  vehicleId: currentVehicleId,
                  inspectionId: currentInspectionId
                };
                
                uploadedFiles.push(fileInfo);

                statusBar.textContent = `‚úÖ Photo uploaded! (${Math.round(blob.size / 1024)} KB)`;
                nextButton.disabled = false;
                console.log('Upload successful:', result.url);
              } else {
                throw new Error(`Upload failed: ${response.status}`);
              }
            } catch (uploadError) {
              console.error('R2 upload failed:', uploadError);
              statusBar.textContent = "‚ö†Ô∏è Upload failed - continuing anyway";
              nextButton.disabled = false;
            }
          }, 'image/jpeg', 0.8);
          
        } catch (error) {
          console.error('Upload error:', error);
          statusBar.textContent = "‚ö†Ô∏è Upload error - continuing anyway";
          nextButton.disabled = false;
        }
      }

      // Capture photo
      function capturePhoto() {
        console.log('Capturing photo...');
        
        // Flash effect
        flashEffect.classList.add("active");
        setTimeout(() => flashEffect.classList.remove("active"), 100);

        if (currentStep === -1) {
          // License plate step - detect and match vehicle
          detectLicensePlate();
        } else {
          // Regular inspection photo - upload to R2
          uploadToR2();
        }
      }

      // Next step
      function nextStep() {
        console.log('Next step...');
        if (currentStep < steps.length - 1) {
          currentStep++;
          updateStep();
        } else {
          stepInstruction.textContent = "üéâ Inspection completed! Processing...";
          nextButton.style.display = "none";
          photoButton.style.display = "none";
          statusBar.textContent = "Finalizing inspection...";
          
          completeInspection();
        }
      }

      // Complete inspection
      async function completeInspection() {
        try {
          // Update inspection status in Supabase
          if (supabase && currentInspectionId) {
            const { error } = await supabase
              .from('inspections')
              .update({ 
                status: 'complete',
                notes: `Inspection completed with ${uploadedFiles.length} photos`
              })
              .eq('id', currentInspectionId);

            if (error) throw error;
            console.log('‚úÖ Inspection marked as complete in database');
          }

          const vehicleText = vehicleInfo.make ? 
            `${vehicleInfo.make} ${vehicleInfo.model} ${vehicleInfo.year}` : 
            "Vehicle";
          stepInstruction.textContent = `‚úÖ ${vehicleText} inspection completed!`;
          statusBar.textContent = `Complete! ${uploadedFiles.length} photos uploaded üéâ`;
          
        } catch (error) {
          console.error('Error completing inspection:', error);
          stepInstruction.textContent = "‚ö†Ô∏è Inspection completed but database update failed";
          statusBar.textContent = "Inspection complete - data saved locally";
        }
      }

      // Lighting check function
      function checkLighting() {
        if (!inspectionStarted || video.readyState < 2) return;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth || 100;
        canvas.height = video.videoHeight || 100;

        if (video.videoWidth > 0) {
          ctx.drawImage(video, 0, 0);
          const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
          let total = 0;

          for (let i = 0; i < frame.data.length; i += 4) {
            const brightness =
              0.299 * frame.data[i] +
              0.587 * frame.data[i + 1] +
              0.114 * frame.data[i + 2];
            total += brightness;
          }

          const avg = total / (frame.data.length / 4);
          const lightOK = avg > 30 && avg < 200;

          if (currentStep === -1) {
            if (!statusBar.textContent.includes("‚úÖ") && !statusBar.textContent.includes("üì§") && !statusBar.textContent.includes("üîç")) {
              statusBar.textContent = `Lighting: ${lightOK ? "üü¢ Good" : "üü° Check"} | License plate detection ready`;
            }
          } else if (!statusBar.textContent.includes("‚úÖ") && !statusBar.textContent.includes("üì§")) {
            statusBar.textContent = `Lighting: ${lightOK ? "üü¢ Good" : "üü° Check"} | Ready for photo`;
          }
        }
      }

      function loopStatus() {
        checkLighting();
        requestAnimationFrame(loopStatus);
      }

      // Event listeners
      startInspectionBtn.addEventListener("click", function() {
        console.log('Start button clicked!');
        startInspection();
      });

      testModeBtn.addEventListener("click", function() {
        console.log('Test button clicked!');
        startTestMode();
      });

      photoButton.addEventListener("click", function() {
        console.log('Photo button clicked!');
        capturePhoto();
      });

      nextButton.addEventListener("click", function() {
        console.log('Next button clicked!');
        nextStep();
      });

      // Initialize - simplified without the problematic line
      console.log('Setting up app...');
      
      // Test if currentUser exists
      console.log('currentUser before init:', typeof currentUser);
      
      initSupabase().then(() => {
        console.log('currentUser after init:', currentUser);
        startCamera();
        loopStatus();
        console.log('Setup complete!');
      }).catch(error => {
        console.error('Setup failed:', error);
        // Fallback initialization
        currentUser = { id: 'fallback-user', email: 'fallback@test.com' };
        startCamera();
        loopStatus();
        console.log('Setup complete with fallback!');
      });
    </script>
  </body>
</html>;
        color: white;
      }
      
      .btn-yes:hover {
        background: #45a049;
      }
      
      .btn-no:hover {
        background: #da190b;
      }
      
      /* Manual vehicle form */
      .manual-form {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1rem 0;
        text-align: left;
      }
      
      .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      
      .form-row input {
        flex: 1;
        padding: 0.8rem;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
      }
      
      .form-row input:focus {
        outline: none;
        border-color: #4caf50;
      }
      
      .form-row label {
        display: block;
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }
      
      /* Mobile responsive */
      @media (max-width: 768px) {
        #start-screen h1 {
          font-size: 2rem;
        }
        
        #start-screen p {
          font-size: 1.1rem;
        }
        
        .btn {
          padding: 1rem 1.5rem;
          font-size: 1.1rem;
        }
        
        #step-instruction {
          bottom: 120px;
          font-size: 1.2rem;
        }
        
        .form-row {
          flex-direction: column;
          gap: 0.5rem;
        }
        
        .popup-buttons {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    
    <video id="video" autoplay muted playsinline></video>
    <div id="flash-effect" class="flash-effect"></div>

    <!-- Start Screen -->
    <div id="start-screen">
      <h1>üöó Car Inspection</h1>
      <p>Welcome to the vehicle inspection app.<br><br>
      <strong>Instructions:</strong><br>
      ‚Ä¢ First, take a clear photo of your license plate<br>
      ‚Ä¢ Then follow the 18-step inspection process<br>
      ‚Ä¢ Each photo will be automatically uploaded and analyzed</p>
      <button id="start-inspection-btn" class="btn">Start Inspection</button>
      <button id="test-mode-btn" class="btn btn-test">üß™ Test Mode</button>
    </div>

    <!-- Status and Controls -->
    <div id="status-bar">Ready to start...</div>
    <div id="step-instruction">Loading...</div>
    <button id="photo-button">üì∏ Take Photo</button>
    <button id="next-button" disabled>Next Step</button>

    <script>
      console.log('Script starting...');
      
      // NO AUTH - Use fixed test user
      const currentUser = { 
        id: 'user-test-12345', 
        email: 'test@example.com' 
      };
      console.log('‚úÖ Auth disabled - using test user:', currentUser.email);
      
      const steps = [
        "Front bumper",
        "Driver side front fender", 
        "Driver side front wheel",
        "Driver side doors",
        "Driver side rear wheel",
        "Driver side rear fender",
        "Rear bumper",
        "Passenger side rear fender",
        "Passenger side rear wheel", 
        "Passenger side doors",
        "Passenger side front wheel",
        "Passenger side front fender",
        "Front windshield",
        "Interior: dashboard",
        "Interior: front seats",
        "Interior: rear seats",
        "Odometer",
        "Trunk/cargo area",
      ];

      let currentStep = -1; // -1 = license plate step, 0-17 = inspection steps
      let vehicleInfo = null;
      let detectedVehicle = null;
      let inspectionStarted = false;
      let uploadedVideoUrls = [];
      let isTestMode = false;
      let userVehicles = [];
      let currentVehicleId = null;

      // Test folder photos
      const testFolderPhotos = [
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-bumper.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-left-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-left-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/left-side-doors.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-left-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-left-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-bumper.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-right-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-right-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/right-side-doors.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-right-wheel.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-right-fender.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-windshield.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/dashboard.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/front-seats.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/rear-seats.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/odometer.jpg",
        "https://pub-e59be5da606246259e1876310327852e.r2.dev/rental-shield/test-data/trunk.jpg",
      ];

      // Get elements
      const video = document.getElementById("video");
      const statusBar = document.getElementById("status-bar");
      const stepInstruction = document.getElementById("step-instruction");
      const nextButton = document.getElementById("next-button");
      const photoButton = document.getElementById("photo-button");
      const startScreen = document.getElementById("start-screen");
      const startInspectionBtn = document.getElementById("start-inspection-btn");
      const testModeBtn = document.getElementById("test-mode-btn");
      const flashEffect = document.getElementById("flash-effect");

      console.log('Elements found:', {
        startInspectionBtn: !!startInspectionBtn,
        testModeBtn: !!testModeBtn,
        photoButton: !!photoButton,
        nextButton: !!nextButton
      });

      // Start camera
      async function startCamera() {
        try {
          console.log('Requesting camera...');
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280, max: 1280 },
              height: { ideal: 720, max: 720 },
              frameRate: { ideal: 30 },
            },
            audio: false,
          });
          video.srcObject = stream;
          console.log("Camera started successfully");
        } catch (e) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "environment",
                width: { ideal: 1024, max: 1024 },
                height: { ideal: 576, max: 576 },
                frameRate: { ideal: 30 },
              },
              audio: false,
            });
            video.srcObject = stream;
            console.log("Camera started with fallback settings");
          } catch (e2) {
            console.log("Camera not available:", e2);
            video.style.display = 'none';
          }
        }
      }

      // Generate vehicle UUID
      function generateVehicleUUID() {
        return `veh-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      }

      // PHASE 1: Vehicle matching functions
      function cleanPlate(plate) {
        return plate.replace(/[^A-Z0-9]/g, '').toUpperCase();
      }

      function findExistingVehicle(detectedVehicle) {
        const cleanDetectedPlate = cleanPlate(detectedVehicle.plate);
        
        return userVehicles.find(vehicle => {
          const cleanStoredPlate = cleanPlate(vehicle.plate);
          
          // Exact plate match
          if (cleanDetectedPlate === cleanStoredPlate) {
            return true;
          }
          
          // Similar plate + make/model match (handles OCR errors)
          const platesSimilar = cleanDetectedPlate.length >= 3 && 
            cleanStoredPlate.includes(cleanDetectedPlate.substring(0, 3));
          const makeModelMatch = vehicle.make.toLowerCase() === detectedVehicle.make.toLowerCase() &&
            vehicle.model.toLowerCase() === detectedVehicle.model.toLowerCase();
          
          return platesSimilar && makeModelMatch;
        });
      }

      // Generate inspection ID
      function generateInspectionId() {
        const date = new Date().toISOString().split('T')[0];
        const time = Date.now();
        return `inspection-${date}-${time}`;
      }

      // Load user vehicles from storage
      function loadUserVehicles() {
        try {
          const stored = localStorage.getItem(`vehicles_${currentUser.id}`);
          userVehicles = stored ? JSON.parse(stored) : [];
          console.log('Loaded user vehicles:', userVehicles);
        } catch (error) {
          console.log("Couldn't load user vehicles:", error);
          userVehicles = [];
        }
      }

      // Save user vehicles to storage
      function saveUserVehicles() {
        try {
          localStorage.setItem(`vehicles_${currentUser.id}`, JSON.stringify(userVehicles));
          console.log('Saved user vehicles:', userVehicles);
        } catch (error) {
          console.error("Couldn't save user vehicles:", error);
        }
      }

      // Start inspection
      async function startInspection() {
        console.log('Starting inspection...');
        isTestMode = false;
        inspectionStarted = true;
        
        loadUserVehicles();
        
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        photoButton.style.display = "block";
        nextButton.style.display = "block";
        
        currentStep = -1; // Start with license plate
        updateStep();
      }

      // Test mode
      async function startTestMode() {
        console.log('Starting test mode...');
        isTestMode = true;
        inspectionStarted = true;
        startScreen.style.display = "none";
        statusBar.style.display = "block";
        stepInstruction.style.display = "block";
        
        statusBar.textContent = "üß™ Creating test data from folder...";
        stepInstruction.textContent = "üß™ TEST MODE: Auto-sending test folder photos...";

        // Create test vehicle data
        detectedVehicle = {
          make: "Toyota",
          model: "Camry",
          year: "2023",
          color: "Silver",
          plate: "TEST123",
          confidence: 0.95
        };
        vehicleInfo = detectedVehicle;
        currentVehicleId = "veh-test123";

        // Create test data with photos from test folder
        uploadedVideoUrls = [];
        const testInspectionId = generateInspectionId();
        
        for (let i = 0; i < steps.length; i++) {
          uploadedVideoUrls.push({
            step: i + 1,
            stepName: steps[i],
            url: testFolderPhotos[i] || testFolderPhotos[0],
            type: "photo",
            timestamp: new Date().toISOString(),
            fileSize: Math.floor(Math.random() * 150 + 100) + " KB",
            vehicleId: currentVehicleId,
            inspectionId: testInspectionId,
            filePath: `rental-shield/users/test-user/vehicles/${currentVehicleId}/inspections/${testInspectionId}/step-${i + 1}-${steps[i].replace(/\s+/g, '-').toLowerCase()}.jpg`
          });
        }

        await new Promise((resolve) => setTimeout(resolve, 1000));

        statusBar.textContent = "üß™ Test data ready! Triggering webhook...";
        stepInstruction.textContent = "üß™ TEST MODE: Sending 18 test photos to AI analysis...";

        await triggerInspectionComplete();
      }

      // Update step display with vehicle history context
      function updateStep() {
        if (currentStep === -1) {
          stepInstruction.textContent = "üìã Step 0: Take a clear photo of your license plate";
          statusBar.textContent = "üì∏ License plate detection - Make sure plate is clearly visible";
        } else {
          let vehicleText = "Vehicle";
          let inspectionContext = "";
          
          if (detectedVehicle) {
            vehicleText = `${detectedVehicle.make} ${detectedVehicle.model} ${detectedVehicle.year}`;
            
            if (detectedVehicle.totalInspections > 0) {
              inspectionContext = ` (Inspection #${detectedVehicle.totalInspections + 1})`;
            } else {
              inspectionContext = " (First inspection)";
            }
          }
          
          stepInstruction.textContent = `${vehicleText}${inspectionContext} - Step ${currentStep + 1} of ${steps.length}: ${steps[currentStep]}`;
          statusBar.textContent = "üì∏ Ready to take photo";
        }
        
        nextButton.disabled = true;
      }

      // Capture photo
      function capturePhoto() {
        console.log('Capturing photo...');
        
        // Flash effect
        flashEffect.classList.add("active");
        setTimeout(() => flashEffect.classList.remove("active"), 100);

        if (currentStep === -1) {
          // License plate step - detect and match vehicle
          detectLicensePlate();
        } else {
          // Regular inspection photo - upload to R2
          uploadToR2();
        }
      }

      // License plate detection with vehicle history matching
      async function detectLicensePlate() {
        try {
          statusBar.textContent = "üîç Analyzing license plate...";
          
          // Create a canvas to get image data
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          
          // Convert to base64
          const imageData = canvas.toDataURL('image/jpeg', 0.8);
          const base64 = imageData.split(',')[1];
          
          console.log('ü§ñ Calling GPT vehicle detection...');
          
          // Call GPT for comprehensive vehicle analysis
          const gptResponse = await fetch('/.netlify/functions/gpt-vehicle-detect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              imageBase64: base64,
              prompt: "Analyze this vehicle image. Extract the license plate number and identify the vehicle make, model, year, and color. Be specific about the vehicle details. Return JSON format: {plate: 'ABC123', make: 'Toyota', model: 'Camry', year: '2023', color: 'Silver', confidence: 0.9}"
            })
          });
          
          let detectedData = null;
          
          if (gptResponse.ok) {
            const gptResult = await gptResponse.json();
            console.log('ü§ñ GPT Detection result:', gptResult);
            
            if (gptResult.success && gptResult.vehicle) {
              detectedData = gptResult.vehicle;
            }
          }
          
          // Fallback: Try your existing detection API
          if (!detectedData) {
            console.log('üîÑ Fallback to existing detection...');
            try {
              const fallbackResponse = await fetch('/.netlify/functions/detect-vehicle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  imageBase64: base64,
                  checkPlateOnly: false,
                  userId: currentUser.id
                })
              });
              
              if (fallbackResponse.ok) {
                const fallbackResult = await fallbackResponse.json();
                if (fallbackResult.success && fallbackResult.vehicle) {
                  detectedData = fallbackResult.vehicle;
                }
              }
            } catch (fallbackError) {
              console.log('Fallback detection failed:', fallbackError);
            }
          }
          
          // Process detected data
          if (detectedData && detectedData.plate) {
            statusBar.textContent = "‚úÖ Vehicle detected - checking history...";
            
            // Check if this vehicle exists in user's history
            const existingVehicle = findExistingVehicle(detectedData);
            
            if (existingVehicle) {
              // Found existing vehicle
              console.log('üìã Found existing vehicle:', existingVehicle.plate);
              detectedData.vehicleUUID = existingVehicle.vehicleUUID;
              detectedData.inspectionHistory = existingVehicle.inspectionHistory || [];
              detectedData.totalInspections = existingVehicle.inspectionHistory?.length || 0;
              detectedData.lastInspection = existingVehicle.inspectionHistory?.length > 0 ? 
                existingVehicle.inspectionHistory[existingVehicle.inspectionHistory.length - 1] : null;
              
              showVehicleHistoryConfirmation(detectedData);
            } else {
              // New vehicle detected
              console.log('üÜï New vehicle detected:', detectedData.plate);
              detectedData.vehicleUUID = generateVehicleUUID();
              detectedData.inspectionHistory = [];
              detectedData.totalInspections = 0;
              
              showNewVehicleConfirmation(detectedData);
            }
          } else {
            // No clear detection - show simplified manual entry
            console.log('‚ùå No clear detection - manual entry');
            statusBar.textContent = "üîç Couldn't detect clearly - please confirm details";
            showSimpleVehicleEntry();
          }
          
        } catch (error) {
          console.error('‚ùå License plate detection error:', error);
          statusBar.textContent = "üîç Detection failed - please enter details";
          showSimpleVehicleEntry();
        }
      }

      // Show vehicle history confirmation for existing vehicles
      function showVehicleHistoryConfirmation(vehicleData) {
        console.log('üìã Showing vehicle history confirmation:', vehicleData);
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'vehicle-history-confirmation';
        
        // Format last inspection date
        let lastInspectionText = '';
        if (vehicleData.lastInspection) {
          const lastDate = new Date(vehicleData.lastInspection.date || vehicleData.lastInspection.timestamp).toLocaleDateString();
          lastInspectionText = `<p style="color: #2e7d32; font-size: 0.9rem; font-weight: 500;">
            üìÖ Last inspection: ${lastDate}
          </p>`;
        }
        
        popup.innerHTML = `
          <h3>üöó Found existing vehicle!</h3>
          <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
            <p style="margin: 0.5rem 0; font-size: 1.1rem;"><strong>${vehicleData.make} ${vehicleData.model} ${vehicleData.year}</strong></p>
            <p style="margin: 0.5rem 0; color: #666;">${vehicleData.color} ‚Ä¢ ${vehicleData.plate}</p>
            ${lastInspectionText}
            <p style="color: #1976d2; font-size: 0.9rem; font-weight: 500;">
              üìä ${vehicleData.totalInspections} previous inspection${vehicleData.totalInspections !== 1 ? 's' : ''} on record
            </p>
          </div>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Is this the correct vehicle?</p>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="confirmVehicle(true)">‚úÖ Yes, this is correct</button>
            <button class="popup-btn btn-no" onclick="confirmVehicle(false)">‚ùå No, different vehicle</button>
          </div>
        `;
        
        detectedVehicle = vehicleData;
        document.body.appendChild(popup);
      }

      // Show new vehicle confirmation
      function showNewVehicleConfirmation(vehicleData) {
        console.log('üÜï Showing new vehicle confirmation:', vehicleData);
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'new-vehicle-confirmation';
        
        popup.innerHTML = `
          <h3>üÜï New vehicle detected</h3>
          <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
            <p style="margin: 0.5rem 0; font-size: 1.1rem;"><strong>${vehicleData.make} ${vehicleData.model} ${vehicleData.year}</strong></p>
            <p style="margin: 0.5rem 0; color: #666;">${vehicleData.color} ‚Ä¢ ${vehicleData.plate}</p>
            <p style="color: #ed6c02; font-size: 0.9rem; font-weight: 500;">
              üìù This will be your first inspection of this vehicle
            </p>
          </div>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Does this look correct?</p>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="confirmVehicle(true)">‚úÖ Yes, add to my vehicles</button>
            <button class="popup-btn btn-no" onclick="confirmVehicle(false)">‚ùå No, let me correct this</button>
          </div>
        `;
        
        detectedVehicle = vehicleData;
        document.body.appendChild(popup);
      }

      // Show simple vehicle entry (improved UX)
      function showSimpleVehicleEntry() {
        console.log('Showing simple vehicle entry');
        
        const popup = document.createElement('div');
        popup.className = 'vehicle-popup';
        popup.id = 'simple-vehicle-entry';
        popup.innerHTML = `
          <h3>üìù Confirm Vehicle Details</h3>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Please enter your vehicle information:</p>
          <div class="manual-form">
            <div class="form-row">
              <div>
                <label>License Plate</label>
                <input type="text" id="manual-plate" placeholder="ABC123" required>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Make</label>
                <input type="text" id="manual-make" placeholder="Toyota" required>
              </div>
              <div>
                <label>Model</label>
                <input type="text" id="manual-model" placeholder="Camry" required>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Year</label>
                <input type="number" id="manual-year" min="1990" max="2025" placeholder="2023" required>
              </div>
              <div>
                <label>Color</label>
                <input type="text" id="manual-color" placeholder="Silver" required>
              </div>
            </div>
          </div>
          <div class="popup-buttons">
            <button class="popup-btn btn-yes" onclick="saveVehicleDetails()">üíæ Save & Continue</button>
          </div>
        `;
        
        document.body.appendChild(popup);
      }

      // Unified confirmation handler
      window.confirmVehicle = function(confirmed) {
        console.log('üöó Vehicle confirmation:', confirmed);
        
        // Remove any existing popups
        const popups = ['vehicle-history-confirmation', 'new-vehicle-confirmation'];
        popups.forEach(id => {
          const popup = document.getElementById(id);
          if (popup) popup.remove();
        });
        
        if (confirmed) {
          // User confirmed vehicle is correct
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.vehicleUUID;
          
          // Add to user's vehicle list if new
          if (!userVehicles.find(v => v.vehicleUUID === currentVehicleId)) {
            const newVehicle = {
              vehicleUUID: currentVehicleId,
              make: detectedVehicle.make,
              model: detectedVehicle.model,
              year: detectedVehicle.year,
              color: detectedVehicle.color,
              plate: detectedVehicle.plate,
              inspectionHistory: []
            };
            userVehicles.push(newVehicle);
            saveUserVehicles();
            console.log('‚úÖ Added new vehicle to list');
          }
          
          const isNew = detectedVehicle.totalInspections === 0;
          statusBar.textContent = isNew ? 
            "‚úÖ New vehicle added - first inspection" : 
            `‚úÖ Vehicle confirmed - inspection #${detectedVehicle.totalInspections + 1}`;
          
          // Move to step 1
          currentStep = 0;
          updateStep();
          nextButton.disabled = false;
        } else {
          // User says vehicle is wrong - show manual entry
          console.log('‚ùå User says vehicle info is wrong');
          showSimpleVehicleEntry();
        }
      };

      // Save vehicle details from manual entry
      window.saveVehicleDetails = function() {
        console.log('üíæ Saving vehicle details...');
        const make = document.getElementById('manual-make').value.trim();
        const model = document.getElementById('manual-model').value.trim();
        const year = document.getElementById('manual-year').value.trim();
        const color = document.getElementById('manual-color').value.trim();
        const plate = document.getElementById('manual-plate').value.trim();
        
        if (!make || !model || !year || !color || !plate) {
          alert('Please fill in all fields');
          return;
        }
        
        // Check if manually entered vehicle already exists
        const manualVehicle = { make, model, year, color, plate, confidence: 1.0 };
        const existingVehicle = findExistingVehicle(manualVehicle);
        
        if (existingVehicle) {
          // Found existing vehicle
          console.log('üìã Manual entry matches existing vehicle');
          detectedVehicle = {
            ...manualVehicle,
            vehicleUUID: existingVehicle.vehicleUUID,
            inspectionHistory: existingVehicle.inspectionHistory || [],
            totalInspections: existingVehicle.inspectionHistory?.length || 0
          };
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.vehicleUUID;
          statusBar.textContent = `‚úÖ Vehicle found - inspection #${detectedVehicle.totalInspections + 1}`;
        } else {
          // Create new vehicle from manual entry
          console.log('üÜï Creating new vehicle from manual entry');
          detectedVehicle = manualVehicle;
          detectedVehicle.vehicleUUID = generateVehicleUUID();
          detectedVehicle.inspectionHistory = [];
          detectedVehicle.totalInspections = 0;
          vehicleInfo = detectedVehicle;
          currentVehicleId = detectedVehicle.vehicleUUID;
          
          // Add to user's vehicle list
          const newVehicle = {
            vehicleUUID: currentVehicleId,
            make: detectedVehicle.make,
            model: detectedVehicle.model,
            year: detectedVehicle.year,
            color: detectedVehicle.color,
            plate: detectedVehicle.plate,
            inspectionHistory: []
          };
          userVehicles.push(newVehicle);
          saveUserVehicles();
          
          statusBar.textContent = "‚úÖ New vehicle created - first inspection";
        }
        
        const popup = document.getElementById('simple-vehicle-entry');
        if (popup) popup.remove();
        
        // Move to step 1
        currentStep = 0;
        updateStep();
        nextButton.disabled = false;
      };

      // Upload to R2 function
      async function uploadToR2() {
        try {
          statusBar.textContent = "üì§ Uploading photo...";
          
          // Create a canvas to get image data
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          
          // Convert to blob
          canvas.toBlob(async (blob) => {
            if (!blob) {
              statusBar.textContent = "‚ùå Failed to capture photo";
              return;
            }
            
            // Create new hierarchical file path
            const userId = currentUser.id;
            const vehicleId = currentVehicleId || 'unknown-vehicle';
            const inspectionId = generateInspectionId();
            
            const fileName = `rental-shield/users/${userId}/vehicles/${vehicleId}/inspections/${inspectionId}/step-${currentStep + 1}-${steps[currentStep].replace(/\s+/g, '-').toLowerCase()}.jpg`;

            console.log('Uploading to new structure:', fileName);

            // Try to upload to R2
            try {
              const formData = new FormData();
              formData.append('file', blob, fileName);
              formData.append('fileName', fileName);
              formData.append('bucketName', 'rental-shield');
              formData.append('metadata', JSON.stringify({
                vehicleId: vehicleId,
                inspectionId: inspectionId,
                userId: userId,
                vehicleData: detectedVehicle,
                stepNumber: currentStep + 1,
                stepName: steps[currentStep]
              }));

              const response = await fetch('/.netlify/functions/upload-to-r2', {
                method: 'POST',
                body: formData
              });

              if (response.ok) {
                const result = await response.json();
                const uploadUrl = result.url;
                
                // Track the uploaded file
                const fileInfo = {
                  step: currentStep + 1,
                  stepName: steps[currentStep],
                  url: uploadUrl,
                  type: "photo",
                  timestamp: new Date().toISOString(),
                  fileSize: Math.round(blob.size / 1024) + " KB",
                  vehicleId: vehicleId,
                  inspectionId: inspectionId,
                  filePath: fileName
                };
                
                uploadedVideoUrls.push(fileInfo);

                statusBar.textContent = `‚úÖ Photo uploaded! (${Math.round(blob.size / 1024)} KB)`;
                nextButton.disabled = false;
                console.log('Upload successful:', uploadUrl);
              } else {
                throw new Error(`Upload failed: ${response.status}`);
              }
            } catch (uploadError) {
              console.error('R2 upload failed:', uploadError);
              statusBar.textContent = "‚ö†Ô∏è R2 upload failed - continuing anyway";
              nextButton.disabled = false;
            }
          }, 'image/jpeg', 0.8);
          
        } catch (error) {
          console.error('Upload error:', error);
          statusBar.textContent = "‚ö†Ô∏è Upload error - continuing anyway";
          nextButton.disabled = false;
        }
      }

      // Next step
      function nextStep() {
        console.log('Next step...');
        if (currentStep < steps.length - 1) {
          currentStep++;
          updateStep();
        } else {
          stepInstruction.textContent = "üéâ Inspection completed! Processing...";
          nextButton.style.display = "none";
          photoButton.style.display = "none";
          statusBar.textContent = "Sending to AI analysis...";
          
          // Update vehicle's inspection history
          updateVehicleHistory();
          
          triggerInspectionComplete();
        }
      }

      // Update vehicle history after inspection completion
      function updateVehicleHistory() {
        const inspectionId = uploadedVideoUrls[0]?.inspectionId || generateInspectionId();
        const inspectionRecord = {
          date: new Date().toISOString(),
          inspectionId: inspectionId,
          stepCount: uploadedVideoUrls.length,
          timestamp: new Date().toISOString()
        };
        
        // Find and update the vehicle in userVehicles
        const vehicleIndex = userVehicles.findIndex(v => v.vehicleUUID === currentVehicleId);
        if (vehicleIndex !== -1) {
          if (!userVehicles[vehicleIndex].inspectionHistory) {
            userVehicles[vehicleIndex].inspectionHistory = [];
          }
          userVehicles[vehicleIndex].inspectionHistory.push(inspectionRecord);
          saveUserVehicles();
          console.log('‚úÖ Updated vehicle inspection history');
        }
      }

      // Trigger inspection completion webhook
      async function triggerInspectionComplete() {
        const inspectionId = uploadedVideoUrls[0]?.inspectionId || generateInspectionId();
        const completionData = {
          inspectionId: inspectionId,
          vehicleInfo: {
            ...vehicleInfo,
            vehicleId: currentVehicleId,
            totalInspections: (detectedVehicle?.totalInspections || 0) + 1
          },
          userInfo: {
            userId: currentUser.id,
            email: currentUser.email
          },
          completedAt: new Date().toISOString(),
          totalSteps: steps.length,
          uploadedFiles: uploadedVideoUrls,
          summary: {
            totalFiles: uploadedVideoUrls.length,
            totalSize: uploadedVideoUrls.reduce((sum, file) => {
              return sum + parseInt(file.fileSize.replace(" KB", ""));
            }, 0) + " KB",
            photoCount: uploadedVideoUrls.length,
            videoCount: 0,
          },
          testMode: isTestMode,
          status: "inspection_complete"
        };

        try {
          const webhookUrl = "https://hamzaw.app.n8n.cloud/webhook-test/50903630-1eac-46a7-a041-6b5614e9f533";

          console.log("üöÄ Triggering inspection completion webhook...");

          const response = await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(completionData),
          });

          if (response.ok) {
            const vehicleText = vehicleInfo.make ? 
              `${vehicleInfo.make} ${vehicleInfo.model} ${vehicleInfo.year}` : 
              "Vehicle";
            stepInstruction.textContent = `‚úÖ ${vehicleText} inspection sent for AI analysis!`;
            statusBar.textContent = "Processing complete - AI analysis started! ü§ñ";
            console.log("‚úÖ Webhook sent successfully!");
          } else {
            throw new Error(`Webhook failed: ${response.status}`);
          }
        } catch (error) {
          console.error("Webhook trigger failed:", error);
          stepInstruction.textContent = "‚ö†Ô∏è Analysis trigger failed - inspection data saved locally";
          statusBar.textContent = "Inspection complete - please contact support if needed";
        }
      }

      // Lighting check function
      function checkLighting() {
        if (!inspectionStarted || video.readyState < 2) return;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth || 100;
        canvas.height = video.videoHeight || 100;

        if (video.videoWidth > 0) {
          ctx.drawImage(video, 0, 0);
          const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
          let total = 0;

          for (let i = 0; i < frame.data.length; i += 4) {
            const brightness =
              0.299 * frame.data[i] +
              0.587 * frame.data[i + 1] +
              0.114 * frame.data[i + 2];
            total += brightness;
          }

          const avg = total / (frame.data.length / 4);
          const lightOK = avg > 30 && avg < 200;

          if (currentStep === -1) {
            if (!statusBar.textContent.includes("‚úÖ") && !statusBar.textContent.includes("üì§") && !statusBar.textContent.includes("üîç")) {
              statusBar.textContent = `Lighting: ${lightOK ? "üü¢ Good" : "üü° Check"} | License plate detection ready`;
            }
          } else if (!statusBar.textContent.includes("‚úÖ") && !statusBar.textContent.includes("üì§")) {
            statusBar.textContent = `Lighting: ${lightOK ? "üü¢ Good" : "üü° Check"} | Ready for photo`;
          }
        } else {
          if (currentStep === -1) {
            statusBar.textContent = "üì∑ License plate detection ready";
          } else if (!statusBar.textContent.includes("‚úÖ") && !statusBar.textContent.includes("üì§")) {
            statusBar.textContent = "üì∑ Ready for photo";
          }
        }
      }

      function loopStatus() {
        checkLighting();
        requestAnimationFrame(loopStatus);
      }

      // Event listeners
      startInspectionBtn.addEventListener("click", function() {
        console.log('Start button clicked!');
        startInspection();
      });

      testModeBtn.addEventListener("click", function() {
        console.log('Test button clicked!');
        startTestMode();
      });

      photoButton.addEventListener("click", function() {
        console.log('Photo button clicked!');
        capturePhoto();
      });

      nextButton.addEventListener("click", function() {
        console.log('Next button clicked!');
        nextStep();
      });

      // Initialize
      console.log('Setting up camera...');
      startCamera();
      loopStatus();
      console.log('Setup complete!');
    </script>
  </body>
</html>
